const tpi_cc_i_cart_add = `
<svg stroke="currentColor" fill="none" stroke-width="0" viewBox="0 0 15 15" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M7.49991 0.876892C3.84222 0.876892 0.877075 3.84204 0.877075 7.49972C0.877075 11.1574 3.84222 14.1226 7.49991 14.1226C11.1576 14.1226 14.1227 11.1574 14.1227 7.49972C14.1227 3.84204 11.1576 0.876892 7.49991 0.876892ZM1.82707 7.49972C1.82707 4.36671 4.36689 1.82689 7.49991 1.82689C10.6329 1.82689 13.1727 4.36671 13.1727 7.49972C13.1727 10.6327 10.6329 13.1726 7.49991 13.1726C4.36689 13.1726 1.82707 10.6327 1.82707 7.49972ZM7.50003 4C7.77617 4 8.00003 4.22386 8.00003 4.5V7H10.5C10.7762 7 11 7.22386 11 7.5C11 7.77614 10.7762 8 10.5 8H8.00003V10.5C8.00003 10.7761 7.77617 11 7.50003 11C7.22389 11 7.00003 10.7761 7.00003 10.5V8H4.50003C4.22389 8 4.00003 7.77614 4.00003 7.5C4.00003 7.22386 4.22389 7 4.50003 7H7.00003V4.5C7.00003 4.22386 7.22389 4 7.50003 4Z" fill="currentColor"></path>
</svg>
`,
tpiIcon__trashBucket = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M170.5 51.6L151.5 80l145 0-19-28.4c-1.5-2.2-4-3.6-6.7-3.6l-93.7 0c-2.7 0-5.2 1.3-6.7 3.6zm147-26.6L354.2 80 368 80l48 0 8 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-8 0 0 304c0 44.2-35.8 80-80 80l-224 0c-44.2 0-80-35.8-80-80l0-304-8 0c-13.3 0-24-10.7-24-24S10.7 80 24 80l8 0 48 0 13.8 0 36.7-55.1C140.9 9.4 158.4 0 177.1 0l93.7 0c18.7 0 36.2 9.4 46.6 24.9zM80 128l0 304c0 17.7 14.3 32 32 32l224 0c17.7 0 32-14.3 32-32l0-304L80 128zm80 64l0 208c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-208c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0l0 208c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-208c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0l0 208c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-208c0-8.8 7.2-16 16-16s16 7.2 16 16z"></path>
</svg>
`,
tpiIcon__cross = `
<svg stroke="currentColor" fill="none" stroke-width="0" viewBox="0 0 15 15" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12.8536 2.85355C13.0488 2.65829 13.0488 2.34171 12.8536 2.14645C12.6583 1.95118 12.3417 1.95118 12.1464 2.14645L7.5 6.79289L2.85355 2.14645C2.65829 1.95118 2.34171 1.95118 2.14645 2.14645C1.95118 2.34171 1.95118 2.65829 2.14645 2.85355L6.79289 7.5L2.14645 12.1464C1.95118 12.3417 1.95118 12.6583 2.14645 12.8536C2.34171 13.0488 2.65829 13.0488 2.85355 12.8536L7.5 8.20711L12.1464 12.8536C12.3417 13.0488 12.6583 13.0488 12.8536 12.8536C13.0488 12.6583 13.0488 12.3417 12.8536 12.1464L8.20711 7.5L12.8536 2.85355Z" fill="currentColor"></path>
</svg>
`,
tpi_cc_i_cart = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" baseProfile="tiny" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M20.756 5.345c-.191-.219-.466-.345-.756-.345h-13.819l-.195-1.164c-.08-.482-.497-.836-.986-.836h-2.25c-.553 0-1 .447-1 1s.447 1 1 1h1.403l1.86 11.164.045.124.054.151.12.179.095.112.193.13.112.065c.116.047.238.075.367.075h11.001c.553 0 1-.447 1-1s-.447-1-1-1h-10.153l-.166-1h11.319c.498 0 .92-.366.99-.858l1-7c.041-.288-.045-.579-.234-.797zm-1.909 1.655l-.285 2h-3.562v-2h3.847zm-4.847 0v2h-3v-2h3zm0 3v2h-3v-2h3zm-4-3v2h-3l-.148.03-.338-2.03h3.486zm-2.986 3h2.986v2h-2.653l-.333-2zm7.986 2v-2h3.418l-.285 2h-3.133z"></path>
    <circle cx="8.5" cy="19.5" r="1.5">
    </circle><circle cx="17.5" cy="19.5" r="1.5"></circle>
</svg>
`,
tpi_cc_i_pallet = `
<svg class="tpi-infi--icon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 640 512" height="12px" width="12px" xmlns="http://www.w3.org/2000/svg">
    <path d="M144 256h352c8.8 0 16-7.2 16-16V16c0-8.8-7.2-16-16-16H384v128l-64-32-64 32V0H144c-8.8 0-16 7.2-16 16v224c0 8.8 7.2 16 16 16zm480 128c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h48v64H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h608c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16h-48v-64h48zm-336 64H128v-64h160v64zm224 0H352v-64h160v64z"></path>
</svg>
`,
tpi_cc_i_courier = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"></path>
    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"></path>
</svg>
`,
tpi_cc_i_courier_id = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M528 32H48C21.5 32 0 53.5 0 80v16h576V80c0-26.5-21.5-48-48-48zM0 432c0 26.5 21.5 48 48 48h480c26.5 0 48-21.5 48-48V128H0v304zm352-232c0-4.4 3.6-8 8-8h144c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4 0-8-3.6-8-8v-16zm0 64c0-4.4 3.6-8 8-8h144c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4 0-8-3.6-8-8v-16zm0 64c0-4.4 3.6-8 8-8h144c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4 0-8-3.6-8-8v-16zM176 192c35.3 0 64 28.7 64 64s-28.7 64-64 64-64-28.7-64-64 28.7-64 64-64zM67.1 396.2C75.5 370.5 99.6 352 128 352h8.2c12.3 5.1 25.7 8 39.8 8s27.6-2.9 39.8-8h8.2c28.4 0 52.5 18.5 60.9 44.2 3.2 9.9-5.2 19.8-15.6 19.8H82.7c-10.4 0-18.8-10-15.6-19.8z"></path>
</svg>
`,
tpi_cc_i_courier_route_id = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M5 3C6.30622 3 7.41746 3.83481 7.82929 5H10C12.2091 5 14 6.79086 14 9C14 11.2091 12.2091 13 10 13H7C5.34315 13 4 14.3431 4 16C4 17.6569 5.34315 19 7 19H13L15 21H7C4.23858 21 2 18.7614 2 16C2 13.2386 4.23858 11 7 11H10C11.1046 11 12 10.1046 12 9C12 7.89543 11.1046 7 10 7H7.82929C7.41746 8.16519 6.30622 9 5 9C3.34315 9 2 7.65685 2 6C2 4.34315 3.34315 3 5 3Z"></path>
    <path fill-rule="evenodd" clip-rule="evenodd" d="M17.5608 20.9961H18.4484C18.7487 20.192 19.5015 19.5618 20.1257 19.0568C20.3933 18.8404 20.6413 18.6397 20.8273 18.4502C21.3871 17.8811 21.7684 17.1554 21.9229 16.3652C22.0775 15.5751 21.9984 14.7559 21.6956 14.0116C21.3928 13.2673 20.88 12.6313 20.2221 12.1841C19.5642 11.737 18.7908 11.4989 18 11.5C17.2092 11.4989 16.4358 11.737 15.7779 12.1841C15.12 12.6313 14.6072 13.2673 14.3044 14.0116C14.0016 14.7559 13.9225 15.5751 14.0771 16.3652C14.2316 17.1554 14.6129 17.8811 15.1727 18.4502C15.359 18.6412 15.6088 18.8435 15.8786 19.0619C16.5011 19.5658 17.2566 20.2524 17.5608 20.9961Z"></path>
</svg>
`,
tpi_cc_i_courier_print = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
    <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1"></path><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"></path>
</svg>
`

function checkiIs__onCartControlsPage() {
    'use strict';

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ URL
    function isCartControlsPage(url) {
        const base = 'https://logistics.market.yandex.ru/sorting-center/21972131/orders/tpi-cart-controls?tpiCartControls=true';
        if (!url.startsWith(base)) return false;
        
        const params = new URLSearchParams(url.split('?')[1] || '');
        return params.get('tpiCartControls') === 'true' 
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ (–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è)
    function addTurboBlock() {
        if (document.querySelector('.tpi-settings--wrapper')) return;

        document.title = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MK"

        const overlay = document.createElement('div');
        overlay.className = 'tpi-cc--wrapper';

        overlay.innerHTML = 
        `
        <div class="tpi-cc--wrapper-title">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ú–ö
        </div>
        <div class="tpi-cc--table-wrapper">
            <table class="tpi-cc--table-data-output">
                <thead class="tpi-cc--table-thead-wrapper">
                    <tr class="tpi-cc--table-thead">
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">–î–∞–Ω–Ω—ã–µ –∫—É—Ä—å–µ—Ä–∞</div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">–Ø—á–µ–π–∫–∞</div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">–ù–æ–º–µ—Ä CART</div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">–ù–æ–º–µ—Ä PALLET</div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">C—Ç–∞—Ç—É—Å</div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏</div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">–ù–∞—á–∞–ª–æ<br>—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">–ö–æ–Ω–µ—Ü<br>—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">–ü—Ä–∏–±—ã—Ç–∏–µ<br>–∫—É—Ä—å–µ—Ä–∞</div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">–ü–µ—á–∞—Ç—å</div>
                        </th>
                    </tr>
                </thead>
                <tbody class="tpi-cc--table-tbody-wrapper">
                    <tr class="tpi-cc--table-tbody">
                        <td class="tpi-cc--table-tbody-item">
                            <div class="tpi-cc--table-tbody-data-courier">
                                <div class="tpi-cc--sortable-data-wrapper tpi-cc--courier-id-data-wrapper">
                                    <a href="#" target="_blank" class="tpi-cc--table-tbody-data-link">
                                        <i>${tpi_cc_i_courier}</i>
                                        <p class="tpi-cc--sortable-data-courier">–®–∏—à–∫–∏–Ω –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –í–∏–∫—Ç–æ—Ä–æ–≤–∏—á</p>
                                    </a>
                                    <div class="tpi-cc--table-tbody-data-courier-extra-info-wrapper">
                                        <div class="tpi-cc--table-tbody-data-courier-extra-info">
                                            <i>${tpi_cc_i_courier_route_id}</i>
                                            <p>1093235550</p>
                                        </div>
                                        <div class="tpi-cc--table-tbody-data-courier-extra-info">
                                            <i>${tpi_cc_i_courier_id}</i>
                                            <p>2005466013</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="tpi-cc--table-tbody-item">
                            <div class="tpi-cc--table-tbody-data">
                                <a href="#" class="tpi-cc--table-tbody-data-link">
                                    MK-101
                                </a>
                            </div>
                        </td>
                        <td class="tpi-cc--table-tbody-item">
                            <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-carts">
                                <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-cart-id">
                                    <i class="tpi-cc-table-tbody-data-cart-icon">${tpi_cc_i_cart}</i>
                                    -1011
                                </button>
                                <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-cart-id">
                                    <i class="tpi-cc-table-tbody-data-cart-icon">${tpi_cc_i_cart}</i>
                                    -1012
                                </button>
                                <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-cart-id">
                                    <i class="tpi-cc-table-tbody-data-cart-icon">${tpi_cc_i_cart}</i>
                                    -1013
                                </button>
                                <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-cart-id">
                                    <i class="tpi-cc-table-tbody-data-cart-icon">${tpi_cc_i_cart}</i>
                                    -1014
                                </button>
                                <div class="tpi-cc--carts-control-buttons-wrapper">
                                    <button class="tpi-cc--table-tbody-add-cart" tpi-state-change="tpi-add-cart">
                                        <i>${tpi_cc_i_cart_add}</i>
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td class="tpi-cc--table-tbody-item">
                            <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-pallets">
                                <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-pallet-id">
                                    <i class="tpi-cc-table-tbody-data-pallet-icon">${tpi_cc_i_pallet}</i>
                                    -776
                                </button>
                                <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-pallet-id">
                                    <i class="tpi-cc-table-tbody-data-pallet-icon">${tpi_cc_i_pallet}</i>
                                    -466
                                </button>
                                <div class="tpi-cc--carts-control-buttons-wrapper">
                                    <button class="tpi-cc--table-tbody-add-cart" tpi-state-change="tpi-add-cart">
                                        <i>${tpi_cc_i_cart_add}</i>
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td class="tpi-cc--table-tbody-item">
                            <div class="tpi-cc--table-tbody-data">
                                <div class="tpi-cc-table-tbody-data-route-status" tpi-cc-route-status="shipped">
                                    <i></i>
                                    <p>–û—Ç–≥—Ä—É–∂–µ–Ω</p>
                                </div>
                            </div>
                        </td>
                        <td class="tpi-cc--table-tbody-item">
                            <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-sort-progress-container">
                                <p class="tpi-cc--table-tbody-data-sort-progress">150 –∏–∑ 230</p>
                                <div class="tpi-cc--table-tbody-data-sort-progress-circle-wrapper">
                                    <p class="tpi-cc--table-tbody-data-sort-progress-circle-value">64%</p>
                                    <svg width="50" height="50" viewBox="-6.25 -6.25 62.5 62.5" version="1.1" xmlns="http://www.w3.org/2000/svg" style="transform:rotate(-90deg)">
                                        <circle r="25" cx="25" cy="25" fill="transparent" stroke="#e8e8e8" stroke-width="4"></circle>
                                        <circle r="25" cx="25" cy="25" stroke="#ffcc00" stroke-width="7" stroke-linecap="round" stroke-dashoffset="12px" fill="transparent" stroke-dasharray="94.2px"></circle>
                                    </svg>
                                </div>
                            </div>
                        </td>
                        <td class="tpi-cc--table-tbody-item">
                            <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-sort-progress-container">
                                <p class="tpi-cc--table-tbody-data-sort-progress">13 –∏–∑ 230</p>
                                <div class="tpi-cc--table-tbody-data-sort-progress-circle-wrapper">
                                    <p class="tpi-cc--table-tbody-data-sort-progress-circle-value">64%</p>
                                    <svg width="50" height="50" viewBox="-6.25 -6.25 62.5 62.5" version="1.1" xmlns="http://www.w3.org/2000/svg" style="transform:rotate(-90deg)">
                                        <circle r="25" cx="25" cy="25" fill="transparent" stroke="#e8e8e8" stroke-width="4"></circle>
                                        <circle r="25" cx="25" cy="25" stroke="#ffcc00" stroke-width="7" stroke-linecap="round" stroke-dashoffset="12px" fill="transparent" stroke-dasharray="94.2px"></circle>
                                    </svg>
                                </div>
                            </div>
                        </td>
                        <td class="tpi-cc--table-tbody-item">
                            <div class="tpi-cc--table-body-date-container">
                                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                                    <i class="tpi-cc--table-tbody-data-icon">${tpiIcon__calendar}</i>
                                    <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-date-type="start">
                                        03/11/2025
                                    </p>
                                </div>
                                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                                    <i class="tpi-cc--table-tbody-data-icon">${tpiIcon__clock}</i>
                                    <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-time-type="start">
                                        21:36:24
                                    </p>
                                </div>
                            </div>
                        </td>
                        <td class="tpi-cc--table-tbody-item">
                            <div class="tpi-cc--table-body-date-container">
                                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                                    <i class="tpi-cc--table-tbody-data-icon">${tpiIcon__calendar}</i>
                                    <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-date-type="end">
                                        04/11/2025
                                    </p>
                                </div>
                                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                                    <i class="tpi-cc--table-tbody-data-icon">${tpiIcon__clock}</i>
                                    <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-time-type="end">
                                        07:30:12
                                    </p>
                                </div>
                            </div>
                        </td>
                        <td class="tpi-cc--table-tbody-item">
                            <div class="tpi-cc--table-body-date-container">
                                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                                    <i class="tpi-cc--table-tbody-data-icon">${tpiIcon__calendar}</i>
                                    <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-date-type="arrived">
                                        04/11/2025
                                    </p>
                                </div>
                                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                                    <i class="tpi-cc--table-tbody-data-icon">${tpiIcon__clock}</i>
                                    <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-time-type="arrived">
                                        07:30:00
                                    </p>
                                </div>
                            </div>
                        </td>
                        <td class="tpi-cc--table-tbody-item">
                            <div class="tpi-cc--table-body-print-container">
                                <button class="tpi-cc--print-current-row">${tpi_cc_i_courier_print}</button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        `
        
        const appID = document.getElementById("app")
        const headerTitle = document.querySelector(".p-layout__header-wrapper")
        appID.remove()
        headerTitle.remove()

        document.querySelector(".p-layout__content").appendChild(overlay);
        
        callTurboPI__once();
        addTurboPiTitle()
        if (observer) {
            observer.disconnect();
            observer = null;
        }
    }


    if (isCartControlsPage(location.href)) {
        addTurboBlock();
        addCartsControlsListeners();
        addToastContainer()
        setTimeout(() => {
            tpiNotification.show('–°—Ç—Ä–∞–Ω–∏—Ü–∞ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ú–ö" –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞', "info", `–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω–æ–º, –ø–æ—Å–µ—Ç–∏—Ç–µ Wiki TURBOpi`);
        }, 100);
        return; 
    }

    observer = new MutationObserver(() => {
        if (isCartControlsPage(location.href)) {
            addTurboBlock();
        }
    });
    observer.observe(document, { subtree: true, childList: true });
    setTimeout(() => {
        addTurboPiTitle()
    }, 1000);
}

checkiIs__onCartControlsPage()

function addCartsControlsListeners(){
    console.log("test")
    waitForTokenAndRun();
}


//B- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—É—Ä—å–µ—Ä–∞–º–∏ –∏ —è—á–µ–π–∫–∞–º–∏
async function tpi_getCouriersAndCells() {
    console.log('üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—å–µ—Ä–∞—Ö –∏ —è—á–µ–π–∫–∞—Ö...');
    
    try {
        const url = new URL('https://logistics.market.yandex.ru/api/resolve/');
        url.searchParams.append('r', 'sortingCenter/routes/resolveGetRoutesFullInfo:resolveGetRoutesFullInfo');

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const currentDate = `${year}-${month}-${day}`;
        
        const requestBody = {
            "params": [{
                "sortingCenterId": 21972131,
                "type": "OUTGOING_COURIER",
                "sort": "",
                "hasCarts": false,
                "category": "COURIER", 
                "date": currentDate,
                "recipientName": "",
                "page": 0,
                "size": 100
            }],
            "path": `/sorting-center/21972131/routes?type=OUTGOING_COURIER&sort=&hasCarts=false&category=COURIER&date=${currentDate}&recipientName=`
        };

        console.log('üìÖ –î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞:', currentDate);

        const response = await fetch(url.toString(), {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Market-Core-Service': '<UNKNOWN>',
                'sk': tpiUserTOKEN // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–ø—Ä—è–º—É—é
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data && data.results && data.results.length > 0) {
            const result = data.results[0];
            
            if (result.error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ API:', result.error.message);
                return null;
            }
            
            if (result.data && result.data.content && result.data.content.length > 0) {
                const routes = result.data.content;
                console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤: ${routes.length}`);
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
                const couriersData = routes.map(route => {
                    const courierName = route.courier?.name || '–ù–µ —É–∫–∞–∑–∞–Ω';
                    
                    // –ü–æ–ª—É—á–∞–µ–º —è—á–µ–π–∫–∏ –∏–∑ –º–∞—Å—Å–∏–≤–∞ cells (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å)
                    let cellNumbers = '–ù–µ—Ç —è—á–µ–µ–∫';
                    let mainCell = '–ù–µ—Ç —è—á–µ–π–∫–∏';
                    
                    if (route.cells && route.cells.length > 0) {
                        cellNumbers = route.cells.map(cell => cell.number || '–ë–µ–∑ –Ω–æ–º–µ—Ä–∞').join(', ');
                        mainCell = route.cells[0]?.number || '–ù–µ—Ç —è—á–µ–π–∫–∏';
                    }
                    
                    const routeStatus = route.status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    
                    return {
                        courier: courierName,
                        cell: mainCell, // –û—Å–Ω–æ–≤–Ω–∞—è —è—á–µ–π–∫–∞ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                        cells: cellNumbers, // –í—Å–µ —è—á–µ–π–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        status: routeStatus,
                        ordersLeft: route.ordersLeft || 0,
                        ordersSorted: route.ordersSorted || 0,
                        ordersShipped: route.ordersShipped || 0,
                        ordersPlanned: route.ordersPlanned || 0,
                        courierArrivesAt: route.courierArrivesAt || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
                        finishedAt: route.finishedAt || '–ù–µ –∑–∞–≤–µ—Ä—à–µ–Ω',
                        routeId: route.id || null
                    };
                }).filter(item => item.cell !== '–ù–µ—Ç —è—á–µ–π–∫–∏'); // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫—É—Ä—å–µ—Ä–æ–≤ —Å —è—á–µ–π–∫–∞–º–∏
                
                console.log(`üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∫—É—Ä—å–µ—Ä–æ–≤ —Å —è—á–µ–π–∫–∞–º–∏: ${couriersData.length}`);
                return couriersData;
            } else {
                console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö');
                return null;
            }
        } else {
            console.log('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
            return null;
        }
    } catch (error) {
        console.error('üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        return null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º
function sortCouriersByGroups(couriersData) {
    const firstWave = []; // MK-1...
    const secondWave = []; // MK-2...
    const kgt = []; // KGT...
    const others = []; // –û—Å—Ç–∞–ª—å–Ω—ã–µ
    
    couriersData.forEach(courier => {
        const cell = courier.cell.toUpperCase();
        
        if (cell.startsWith('MK-1')) {
            firstWave.push(courier);
        } else if (cell.startsWith('MK-2')) {
            secondWave.push(courier);
        } else if (cell.startsWith('KGT')) {
            kgt.push(courier);
        } else {
            others.push(courier);
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –Ω–æ–º–µ—Ä—É —è—á–µ–π–∫–∏
    const sortByCellNumber = (a, b) => {
        const extractNumber = (cell) => {
            const match = cell.match(/\d+/);
            return match ? parseInt(match[0]) : 0;
        };
        
        return extractNumber(a.cell) - extractNumber(b.cell);
    };
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –≥—Ä—É–ø–ø—É
    firstWave.sort(sortByCellNumber);
    secondWave.sort(sortByCellNumber);
    kgt.sort(sortByCellNumber);
    others.sort(sortByCellNumber);
    
    return { firstWave, secondWave, kgt, others };
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–∞–±–ª–∏—Ü—ã –≤ –∫–æ–Ω—Å–æ–ª—å
function displayCourierTable(couriers, title) {
    if (couriers.length === 0) return;
    
    console.log(`\nüìã ${title}:`);
    console.table(couriers.map(item => ({
        '–Ø—á–µ–π–∫–∞': item.cell,
        '–ö—É—Ä—å–µ—Ä': item.courier,
        '–°—Ç–∞—Ç—É—Å': item.status,
        '–û—Å—Ç–∞–ª–æ—Å—å': item.ordersLeft,
        '–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ': item.ordersSorted,
        '–û—Ç–≥—Ä—É–∂–µ–Ω–æ': item.ordersShipped,
        '–í—Å–µ–≥–æ': item.ordersPlanned,
        '–ü—Ä–∏–±—ã—Ç–∏–µ': item.courierArrivesAt ? new Date(item.courierArrivesAt).toLocaleTimeString() : '-'
    })));
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–∑–æ–≤–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π –≤ –∫–æ–Ω—Å–æ–ª–∏
async function showCouriers() {
    try {
        const data = await tpi_getCouriersAndCells();
        
        if (!data || data.length === 0) {
            console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—å–µ—Ä–∞—Ö —Å —è—á–µ–π–∫–∞–º–∏');
            return;
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º
        const { firstWave, secondWave, kgt, others } = sortCouriersByGroups(data);
        
        // –í—ã–≤–æ–¥–∏–º —Ç–∞–±–ª–∏—Ü—ã
        displayCourierTable(firstWave, '–ü–ï–†–í–ê–Ø –í–û–õ–ù–ê (MK-1...)');
        displayCourierTable(secondWave, '–í–¢–û–†–ê–Ø –í–û–õ–ù–ê (MK-2...)');
        displayCourierTable(kgt, '–ö–ì–¢ (KGT...)');
        
        if (others.length > 0) {
            displayCourierTable(others, '–î–†–£–ì–ò–ï –Ø–ß–ï–ô–ö–ò');
        }
        
        // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const shippedCouriers = data.filter(item => item.status === 'SHIPPED').length;
        const totalOrdersLeft = data.reduce((sum, item) => sum + (item.ordersLeft || 0), 0);
        const totalOrdersShipped = data.reduce((sum, item) => sum + (item.ordersShipped || 0), 0);
        const totalOrdersPlanned = data.reduce((sum, item) => sum + (item.ordersPlanned || 0), 0);
        
        console.log(`\nüìà –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:`);
        console.log(`   –í—Å–µ–≥–æ –∫—É—Ä—å–µ—Ä–æ–≤ —Å —è—á–µ–π–∫–∞–º–∏: ${data.length}`);
        console.log(`   ‚îú‚îÄ –ü–µ—Ä–≤–∞—è –≤–æ–ª–Ω–∞: ${firstWave.length}`);
        console.log(`   ‚îú‚îÄ –í—Ç–æ—Ä–∞—è –≤–æ–ª–Ω–∞: ${secondWave.length}`);
        console.log(`   ‚îú‚îÄ –ö–ì–¢: ${kgt.length}`);
        console.log(`   ‚îî‚îÄ –î—Ä—É–≥–∏–µ: ${others.length}`);
        console.log(`   –û—Ç–≥—Ä—É–∂–µ–Ω–æ: ${shippedCouriers}`);
        console.log(`   –í —Ä–∞–±–æ—Ç–µ: ${data.length - shippedCouriers}`);
        console.log(`   –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${totalOrdersPlanned}`);
        console.log(`   –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: ${totalOrdersLeft}`);
        console.log(`   –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ: ${totalOrdersShipped}`);
        console.log(`   –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${((totalOrdersShipped / totalOrdersPlanned) * 100).toFixed(1)}%`);
        
    } catch (error) {
        console.error('üí• –û—à–∏–±–∫–∞:', error);
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
window.tpi_getCouriersAndCells = tpi_getCouriersAndCells;
window.showCouriers = showCouriers;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–∞
function waitForTokenAndRun() {
    let attempts = 0;
    const maxAttempts = 15;
    
    const checkInterval = setInterval(() => {
        attempts++;
        
        if (tpiUserTOKEN !== null && tpiUserTOKEN !== undefined) {
            console.log('‚úÖ –¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
            clearInterval(checkInterval);
            showCouriers();
        } else if (attempts >= maxAttempts) {
            console.log('‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞');
            clearInterval(checkInterval);
        } else {
            console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞... (–ø–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts})`);
        }
    }, 1000);
}


// –ó–∞–ø—É—Å–∫–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞