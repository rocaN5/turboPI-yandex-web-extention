const tpi_cc_i_cart_add = `
<svg stroke="currentColor" fill="none" stroke-width="0" viewBox="0 0 15 15" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M7.49991 0.876892C3.84222 0.876892 0.877075 3.84204 0.877075 7.49972C0.877075 11.1574 3.84222 14.1226 7.49991 14.1226C11.1576 14.1226 14.1227 11.1574 14.1227 7.49972C14.1227 3.84204 11.1576 0.876892 7.49991 0.876892ZM1.82707 7.49972C1.82707 4.36671 4.36689 1.82689 7.49991 1.82689C10.6329 1.82689 13.1727 4.36671 13.1727 7.49972C13.1727 10.6327 10.6329 13.1726 7.49991 13.1726C4.36689 13.1726 1.82707 10.6327 1.82707 7.49972ZM7.50003 4C7.77617 4 8.00003 4.22386 8.00003 4.5V7H10.5C10.7762 7 11 7.22386 11 7.5C11 7.77614 10.7762 8 10.5 8H8.00003V10.5C8.00003 10.7761 7.77617 11 7.50003 11C7.22389 11 7.00003 10.7761 7.00003 10.5V8H4.50003C4.22389 8 4.00003 7.77614 4.00003 7.5C4.00003 7.22386 4.22389 7 4.50003 7H7.00003V4.5C7.00003 4.22386 7.22389 4 7.50003 4Z" fill="currentColor"></path>
</svg>
`,
tpiIcon__trashBucket = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M170.5 51.6L151.5 80l145 0-19-28.4c-1.5-2.2-4-3.6-6.7-3.6l-93.7 0c-2.7 0-5.2 1.3-6.7 3.6zm147-26.6L354.2 80 368 80l48 0 8 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-8 0 0 304c0 44.2-35.8 80-80 80l-224 0c-44.2 0-80-35.8-80-80l0-304-8 0c-13.3 0-24-10.7-24-24S10.7 80 24 80l8 0 48 0 13.8 0 36.7-55.1C140.9 9.4 158.4 0 177.1 0l93.7 0c18.7 0 36.2 9.4 46.6 24.9zM80 128l0 304c0 17.7 14.3 32 32 32l224 0c17.7 0 32-14.3 32-32l0-304L80 128zm80 64l0 208c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-208c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0l0 208c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-208c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0l0 208c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-208c0-8.8 7.2-16 16-16s16 7.2 16 16z"></path>
</svg>
`,
tpiIcon__cross = `
<svg stroke="currentColor" fill="none" stroke-width="0" viewBox="0 0 15 15" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12.8536 2.85355C13.0488 2.65829 13.0488 2.34171 12.8536 2.14645C12.6583 1.95118 12.3417 1.95118 12.1464 2.14645L7.5 6.79289L2.85355 2.14645C2.65829 1.95118 2.34171 1.95118 2.14645 2.14645C1.95118 2.34171 1.95118 2.65829 2.14645 2.85355L6.79289 7.5L2.14645 12.1464C1.95118 12.3417 1.95118 12.6583 2.14645 12.8536C2.34171 13.0488 2.65829 13.0488 2.85355 12.8536L7.5 8.20711L12.1464 12.8536C12.3417 13.0488 12.6583 13.0488 12.8536 12.8536C13.0488 12.6583 13.0488 12.3417 12.8536 12.1464L8.20711 7.5L12.8536 2.85355Z" fill="currentColor"></path>
</svg>
`,
tpi_cc_i_cart = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" baseProfile="tiny" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M20.756 5.345c-.191-.219-.466-.345-.756-.345h-13.819l-.195-1.164c-.08-.482-.497-.836-.986-.836h-2.25c-.553 0-1 .447-1 1s.447 1 1 1h1.403l1.86 11.164.045.124.054.151.12.179.095.112.193.13.112.065c.116.047.238.075.367.075h11.001c.553 0 1-.447 1-1s-.447-1-1-1h-10.153l-.166-1h11.319c.498 0 .92-.366.99-.858l1-7c.041-.288-.045-.579-.234-.797zm-1.909 1.655l-.285 2h-3.562v-2h3.847zm-4.847 0v2h-3v-2h3zm0 3v2h-3v-2h3zm-4-3v2h-3l-.148.03-.338-2.03h3.486zm-2.986 3h2.986v2h-2.653l-.333-2zm7.986 2v-2h3.418l-.285 2h-3.133z"></path>
    <circle cx="8.5" cy="19.5" r="1.5">
    </circle><circle cx="17.5" cy="19.5" r="1.5"></circle>
</svg>
`,
tpi_cc_i_pallet = `
<svg class="tpi-infi--icon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 640 512" height="12px" width="12px" xmlns="http://www.w3.org/2000/svg">
    <path d="M144 256h352c8.8 0 16-7.2 16-16V16c0-8.8-7.2-16-16-16H384v128l-64-32-64 32V0H144c-8.8 0-16 7.2-16 16v224c0 8.8 7.2 16 16 16zm480 128c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h48v64H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h608c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16h-48v-64h48zm-336 64H128v-64h160v64zm224 0H352v-64h160v64z"></path>
</svg>
`,
tpi_cc_i_courier = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"></path>
    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"></path>
</svg>
`,
tpi_cc_i_courier_id = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M528 32H48C21.5 32 0 53.5 0 80v16h576V80c0-26.5-21.5-48-48-48zM0 432c0 26.5 21.5 48 48 48h480c26.5 0 48-21.5 48-48V128H0v304zm352-232c0-4.4 3.6-8 8-8h144c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4 0-8-3.6-8-8v-16zm0 64c0-4.4 3.6-8 8-8h144c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4 0-8-3.6-8-8v-16zm0 64c0-4.4 3.6-8 8-8h144c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4 0-8-3.6-8-8v-16zM176 192c35.3 0 64 28.7 64 64s-28.7 64-64 64-64-28.7-64-64 28.7-64 64-64zM67.1 396.2C75.5 370.5 99.6 352 128 352h8.2c12.3 5.1 25.7 8 39.8 8s27.6-2.9 39.8-8h8.2c28.4 0 52.5 18.5 60.9 44.2 3.2 9.9-5.2 19.8-15.6 19.8H82.7c-10.4 0-18.8-10-15.6-19.8z"></path>
</svg>
`,
tpi_cc_i_courier_route_id = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M5 3C6.30622 3 7.41746 3.83481 7.82929 5H10C12.2091 5 14 6.79086 14 9C14 11.2091 12.2091 13 10 13H7C5.34315 13 4 14.3431 4 16C4 17.6569 5.34315 19 7 19H13L15 21H7C4.23858 21 2 18.7614 2 16C2 13.2386 4.23858 11 7 11H10C11.1046 11 12 10.1046 12 9C12 7.89543 11.1046 7 10 7H7.82929C7.41746 8.16519 6.30622 9 5 9C3.34315 9 2 7.65685 2 6C2 4.34315 3.34315 3 5 3Z"></path>
    <path fill-rule="evenodd" clip-rule="evenodd" d="M17.5608 20.9961H18.4484C18.7487 20.192 19.5015 19.5618 20.1257 19.0568C20.3933 18.8404 20.6413 18.6397 20.8273 18.4502C21.3871 17.8811 21.7684 17.1554 21.9229 16.3652C22.0775 15.5751 21.9984 14.7559 21.6956 14.0116C21.3928 13.2673 20.88 12.6313 20.2221 12.1841C19.5642 11.737 18.7908 11.4989 18 11.5C17.2092 11.4989 16.4358 11.737 15.7779 12.1841C15.12 12.6313 14.6072 13.2673 14.3044 14.0116C14.0016 14.7559 13.9225 15.5751 14.0771 16.3652C14.2316 17.1554 14.6129 17.8811 15.1727 18.4502C15.359 18.6412 15.6088 18.8435 15.8786 19.0619C16.5011 19.5658 17.2566 20.2524 17.5608 20.9961Z"></path>
</svg>
`,
tpi_cc_i_courier_print = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
    <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1"></path><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"></path>
</svg>
`,
tpi_cc_i_courier_delete = `
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 16 16">
        <path fill="currentColor" d="M5.386 6h1.806l.219 7H5.886zm3.206 7 .218-7h1.814l-.5 7z"></path>
        <path fill="currentColor" fill-rule="evenodd" d="M7.837.014h.303c.71-.001 1.333-.002 1.881.22a3 3 0 0 1 1.257.962c.36.47.522 1.072.707 1.758l.012.046H15v2l-.96.48-.585 5.922c-.177 1.787-.265 2.68-.72 3.326a3 3 0 0 1-.975.883C11.073 16 10.175 16 8.38 16h-.76c-1.795 0-2.693 0-3.38-.39a3 3 0 0 1-.974-.882c-.456-.646-.544-1.54-.72-3.326L1.96 5.48 1 5V3h2.98l.012-.046c.185-.686.347-1.287.706-1.758A3 3 0 0 1 5.955.235C6.503.012 7.126.013 7.837.015M3.922 5l.614 6.205c.092.93.15 1.494.23 1.911.036.194.07.308.095.376.022.06.037.08.04.084.085.12.196.221.324.294a.3.3 0 0 0 .088.031c.07.018.187.04.383.059.423.038.99.04 1.925.04h.758c.935 0 1.502-.002 1.925-.04.196-.018.313-.04.383-.059.062-.016.083-.028.088-.03a1 1 0 0 0 .325-.295c.002-.004.017-.024.039-.084a2.4 2.4 0 0 0 .096-.376c.08-.417.138-.981.23-1.91L12.077 5zm5.766-2.592c.063.084.116.2.232.592H6.057c.115-.393.168-.508.232-.592a1 1 0 0 1 .419-.32c.137-.056.327-.074 1.28-.074s1.144.018 1.28.074a1 1 0 0 1 .42.32" clip-rule="evenodd"></path>
</svg>
`,
tpi_cc_i_warning = `
<svg class="tpi-cc-i-warning" stroke="currentColor" fill="url(#myGradient)" stroke-width="0" version="1.2" baseProfile="tiny" width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <linearGradient id="myGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="var(--no-ds-color-1)" />
            <stop offset="100%" stop-color="var(--no-ds-color-2)" />
        </linearGradient>
    </defs>
    <path d="M12 5.511c.561 0 1.119.354 1.544 1.062l5.912 9.854c.851 1.415.194 2.573-1.456 2.573h-12c-1.65 0-2.307-1.159-1.456-2.573l5.912-9.854c.425-.708.983-1.062 1.544-1.062m0-2c-1.296 0-2.482.74-3.259 2.031l-5.912 9.856c-.786 1.309-.872 2.705-.235 3.83s1.879 1.772 3.406 1.772h12c1.527 0 2.77-.646 3.406-1.771s.551-2.521-.235-3.83l-5.912-9.854c-.777-1.294-1.963-2.034-3.259-2.034z"></path>
    <circle cx="12" cy="16" r="1.3"></circle>
    <path d="M13.5 10c0-.83-.671-1.5-1.5-1.5s-1.5.67-1.5 1.5c0 .199.041.389.111.562.554 1.376 1.389 3.438 1.389 3.438l1.391-3.438c.068-.173.109-.363.109-.562z"></path>
</svg>
`,
tpi_cc_i_loading = `
<svg class="tpi-cc-i-loading" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" style="shape-rendering: auto; background: transparent;">
    <defs>
        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="var(--no-ds-color-1)"/>
            <stop offset="100%" stop-color="var(--no-ds-color-2)"/>
        </linearGradient>
    </defs>
    <path style="transform:scale(0.8);transform-origin:50px 50px" stroke-linecap="round" d="M24.3 30C11.4 30 5 43.3 5 50s6.4 20 19.3 20c19.3 0 32.1-40 51.4-40 C88.6 30 95 43.3 95 50s-6.4 20-19.3 20C56.4 70 43.6 30 24.3 30z" stroke-dasharray="130.8603533935547 125.72857482910155" stroke-width="10" stroke="url(#gradient)" fill="none">
        <animate values="0;256.58892822265625" keyTimes="0;1" dur="0.9523809523809523s" repeatCount="indefinite" attributeName="stroke-dashoffset"/>
    </path>
</svg>
`,
tpi_cc_i_checmark = `
<svg class="tpi_cc_i_checmark" viewBox="0 0 120 120">
    <defs>
        <linearGradient id="circleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="var(--no-ds-color-1)" />
            <stop offset="100%" stop-color="var(--no-ds-color-2)" />
        </linearGradient>
    </defs>
    <circle class="tpi-circle-outline" cx="60" cy="60" r="50" stroke="url(#circleGradient)"/>
    <path class="tpi-checkmark" d="M43,60 L55,75 L78,45" stroke="url(#circleGradient)" fill="none" stroke-width="4"/>
</svg>
`,
tpi_cc_i_filter_default = `
<svg class="tpi-filter-icon-default" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
    <path d="M8.53039 5.46978L5.00006 1.93945L1.46973 5.46978L2.53039 6.53044L4.25006 4.81077V14.0001H5.75006V4.81077L7.46973 6.53044L8.53039 5.46978Z"></path>
    <path d="M11.7501 11.1895L13.4697 9.46978L14.5304 10.5304L11.0001 14.0608L7.46973 10.5304L8.53039 9.46978L10.2501 11.1895V2.00011H11.7501V11.1895Z"></path>
</svg>
`,
tpi_cc_i_filter_up = `
<svg class="tpi-filter-icon-up" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M304 416h-64a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h64a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM16 160h48v304a16 16 0 0 0 16 16h32a16 16 0 0 0 16-16V160h48c14.21 0 21.38-17.24 11.31-27.31l-80-96a16 16 0 0 0-22.62 0l-80 96C-5.35 142.74 1.77 160 16 160zm416 0H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h192a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm-64 128H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h128a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM496 32H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h256a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16z"></path>
</svg>
`,
tpi_cc_i_filter_down = `
<svg class="tpi-filter-icon-down" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M240 96h64a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16h-64a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16zm0 128h128a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16zm256 192H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h256a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm-256-64h192a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16zm-64 0h-48V48a16 16 0 0 0-16-16H80a16 16 0 0 0-16 16v304H16c-14.19 0-21.37 17.24-11.29 27.31l80 96a16 16 0 0 0 22.62 0l80-96C197.35 369.26 190.22 352 176 352z"></path>
</svg>
`,
tpi_cc_i_print_row = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
    <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1"></path><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"></path>
</svg>
`,
tpi_cc_i_search = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tpi-search-icon">
    <circle class="glass" cx="10.5" cy="10.5" r="7.5" fill="none" stroke="currentcolor" stroke-width="1.5"/>
    <circle class="glassGap" cx="10.5" cy="10.5" r="7.5" fill="none" stroke="currentcolor" stroke-width="1.5"/>
    <path class="handle" d="m16.563 16.458 4.223 5.372-1.572 1.236-4.21-5.356" fill="currentcolor"/>
</svg>
`,
tpi_cc_i_chevron_down = `
<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" style="fill: transparent;">
    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
</svg>
`,
tpi_cc_i_calendar = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="14px" width="14px" xmlns="http://www.w3.org/2000/svg">
    <rect width="416" height="384" x="48" y="80" fill="none" stroke-linejoin="round" stroke-width="32" rx="48"></rect>
    <circle cx="296" cy="232" r="24"></circle>
    <circle cx="376" cy="232" r="24"></circle
    <circle cx="296" cy="312" r="24"></circle<circle cx="376" cy="312" r="24"></circle>
    <circle cx="136" cy="312" r="24"></circle><circle cx="216" cy="312" r="24"></circle>
    <circle cx="136" cy="392" r="24"></circle><circle cx="216" cy="392" r="24"></circle>
    <circle cx="296" cy="392" r="24"></circle>
    <path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M128 48v32m256-32v32"></path>
    <path fill="none" stroke-linejoin="round" stroke-width="32" d="M464 160H48"></path>
</svg>
`,
tpi_cc_i_clock = `
<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="14px" width="14px" xmlns="http://www.w3.org/2000/svg">
    <circle cx="12" cy="12" r="10"></circle>
    <polyline points="12 6 12 12 16 14"></polyline>
</svg>
`,
tpi_cc_i_chevron_right = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 320 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"></path>
</svg>
`,
tpi_cc_i_chevron_left = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 320 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.67 22.67c9.36 9.36 9.37 24.52.04 33.9L131.49 256l154.02 154.75c9.34 9.38 9.32 24.54-.04 33.9l-22.67 22.67c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.57 0-33.94z"></path>
</svg>
`,
tpi_cc_i_couriersTotal = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">
    <path d="M320 16a104 104 0 1 1 0 208 104 104 0 1 1 0-208zM96 88a72 72 0 1 1 0 144 72 72 0 1 1 0-144zM0 416c0-70.7 57.3-128 128-128 12.8 0 25.2 1.9 36.9 5.4-32.9 36.8-52.9 85.4-52.9 138.6l0 16c0 11.4 2.4 22.2 6.7 32L32 480c-17.7 0-32-14.3-32-32l0-32zm521.3 64c4.3-9.8 6.7-20.6 6.7-32l0-16c0-53.2-20-101.8-52.9-138.6 11.7-3.5 24.1-5.4 36.9-5.4 70.7 0 128 57.3 128 128l0 32c0 17.7-14.3 32-32 32l-86.7 0zM472 160a72 72 0 1 1 144 0 72 72 0 1 1 -144 0zM160 432c0-88.4 71.6-160 160-160s160 71.6 160 160l0 16c0 17.7-14.3 32-32 32l-256 0c-17.7 0-32-14.3-32-32l0-16z"></path>
</svg>
`,
tpi_cc_i_couriersFiltered = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">
    <path d="M256.1 8a120 120 0 1 1 0 240 120 120 0 1 1 0-240zM226.4 304l59.4 0c6.7 0 13.2 .4 19.7 1.1-.9 4.9-1.4 9.9-1.4 15l0 92.1c0 25.5 10.1 49.9 28.1 67.9l31.9 31.9-286.3 0c-16.4 0-29.7-13.3-29.7-29.7 0-98.5 79.8-178.3 178.3-178.3zM352.1 412.2l0-92.1c0-17.7 14.3-32 32-32l92.1 0c12.7 0 24.9 5.1 33.9 14.1l96 96c18.7 18.7 18.7 49.1 0 67.9l-76.1 76.1c-18.7 18.7-49.1 18.7-67.9 0l-96-96c-9-9-14.1-21.2-14.1-33.9zm104-44.2a24 24 0 1 0 -48 0 24 24 0 1 0 48 0z"></path>
</svg>
`,
tpi_cc_liquid_glass = `
<svg style="display: none;">
  <filter id="container-glass" x="0%" y="0%" width="100%" height="100%">
    <feTurbulence type="fractalNoise" baseFrequency="0.008 0.008" numOctaves="2" seed="92" result="noise"></feTurbulence>
    <feGaussianBlur in="noise" stdDeviation="0.02" result="blur"></feGaussianBlur>
    <feDisplacementMap in="SourceGraphic" in2="blur" scale="50" xChannelSelector="R" yChannelSelector="G"></feDisplacementMap>
  </filter>
  <filter id="settings-glass" x="0%" y="0%" width="100%" height="100%">
    <feTurbulence type="fractalNoise" baseFrequency="0.005 0.05" numOctaves="5" seed="15" result="noise"></feTurbulence>
    <feGaussianBlur in="noise" stdDeviation="0.02" result="blur"></feGaussianBlur>
    <feDisplacementMap in="SourceGraphic" in2="blur" scale="30" xChannelSelector="R" yChannelSelector="G"></feDisplacementMap>
  </filter>
</svg>
`

function checkiIs__onCartControlsPage() {
    'use strict';

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ URL
    function isCartControlsPage(url) {
        const base = 'https://logistics.market.yandex.ru/sorting-center/21972131/orders/tpi-cart-controls?tpiCartControls=true';
        if (!url.startsWith(base)) return false;
        
        const params = new URLSearchParams(url.split('?')[1] || '');
        return params.get('tpiCartControls') === 'true' 
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ (–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è)
    function addTurboBlock() {
        if (document.querySelector('.tpi-settings--wrapper')) return;

        document.title = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MK"

        const overlay = document.createElement('div');
        overlay.className = 'tpi-cc--wrapper';

        overlay.innerHTML = 
        `
        <div class="tpi-cc--wrapper-title">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MK
        </div>

        <div class="tpi-cc-filters-panel">
            <div class="tpi-cc-filters-wrapper">
                <div class="tpi-cc-filters-wrapper-title">
                    <p>–§–∏–ª—å—Ç—Ä—ã</p>
                </div>
                <div class="tpi-cc-filters-items-wrapper">
                    <div class="tpi-cc-filters-item">
                        <button class="tpi-cc-search-date">
                            <div class="tpi-cc-search-icon">${tpi_cc_i_calendar}</div>
                            <div class="tpi-cc-search-label-title" id="tpi-cc-seleceted-date">–î–∞—Ç–∞</div>
                        </button>
                    </div>
                    <div class="tpi-cc-filters-item">
                        <label for="tpi-cc-search-courier-name" class="tpi-cc-search-label">
                            <div class="tpi-cc-search-icon">${tpi_cc_i_search}</div>
                            <div class="tpi-cc-search-label-title">–§–ò–û –∫—É—Ä—å–µ—Ä–∞</div>
                            <input type="text" id="tpi-cc-search-courier-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û –∫—É—Ä—å–µ—Ä–∞" autocomplete="off">
                        </label>
                    </div>
                    <div class="tpi-cc-filters-item">
                        <label for="tpi-cc-search-courier-cell" class="tpi-cc-search-label">
                            <div class="tpi-cc-search-icon">${tpi_cc_i_search}</div>
                            <div class="tpi-cc-search-label-title">–ò–º—è —è—á–µ–π–∫–∏</div>
                            <input type="text" id="tpi-cc-search-courier-cell" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —è—á–µ–π–∫–∏" autocomplete="off">
                        </label>
                    </div>
                    <div class="tpi-cc-filters-item">
                        <label for="tpi-cc-search-courier-status" class="tpi-cc-search-label tpi-cc-search-dropdown">
                            <div class="tpi-cc-search-label-title">–°—Ç–∞—Ç—É—Å –∫—É—Ä—å–µ—Ä–∞</div>
                            <input type="text" id="tpi-cc-search-courier-status" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –∫—É—Ä—å–µ—Ä–∞" autocomplete="off" value="–í—ã–±—Ä–∞–Ω—ã –≤—Å–µ">
                            <div class="tpi-cc-search-icon">${tpi_cc_i_chevron_down}</div>
                        </label>
                    </div>
                    <div class="tpi-cc-data-item">
                        <div class="tpi-cc-data-item-container">
                            <i class="tpi-cc-data-item-icon">${tpi_cc_i_couriersTotal}</i>
                            <p class="tpi-cc-data-item-title" id="tpi-cc-data-total-couriers">–í—Å–µ–≥–æ: <span>0</span></p>
                        </div>
                        <div class="tpi-cc-data-item-container">
                            <i class="tpi-cc-data-item-icon">${tpi_cc_i_couriersFiltered}</i>
                            <p class="tpi-cc-data-item-title" id="tpi-cc-data-filtered-couriers">–§–∏–ª—å—Ç—Ä: <span>0</span></p>
                        </div>
                    </div>
                    <div class="tpi-cc-filters-item">
                        <button class="tpi-cc-filters-reset">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="tpi-cc--no-ds-data-wrapper">
            <div class="tpi-cc--no-ds-data-container" tpi-current-state="ready-to-data-search">
                <div class="tpi-cc--no-ds-data-block">
                    <div class="tpi-cc--no-ds-data-title">
                        <p>–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</p>
                    </div>
                </div>
                <div class="tpi-cc--no-ds-data-block">
                    <div class="tpi-cc--no-ds-data-icon-wrapper">
                        <i>${tpi_cc_i_warning}${tpi_cc_i_loading}${tpi_cc_i_checmark}</i>
                    </div>
                    <div class="tpi-cc--no-ds-data-info-wrapper">
                        <div class="tpi-cc--no-ds-data-description">
                            <p class="tpi-cc--no-ds-data-description-block">–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–µ –æ—Ç–≥—Ä—É–∑–∫–∏, –¥–ª—è –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</p>
                            <p class="tpi-cc--no-ds-data-description-block-sub">–í–Ω–∏–º–∞–Ω–∏–µ! –ù–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤—ã –ø–µ—Ä–µ–∑–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—É—â—É—é –æ—Ç–≥—Ä—É–∑–∫—É –∏ –≤—Å—è –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç —É—Ç–µ—Ä—è–Ω–∞, –∫–æ—Ä–∏–¥–æ—Ä –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö - —Å 23:00:00 –ø–æ 23:00:00 —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è</p>
                        </div>
                    </div>
                </div>  
                <div class="tpi-cc--no-ds-data-block">
                    <button class="tpi-cc--no-ds-data-start">–ù–∞—á–∞—Ç—å</button>
                </div>  
            </div>
        </div>
        <div class="tpi-cc--table-wrapper">
            <table class="tpi-cc--table-data-output">
                <thead class="tpi-cc--table-thead-wrapper">
                    <tr class="tpi-cc--table-thead">
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–î–∞–Ω–Ω—ã–µ –∫—É—Ä—å–µ—Ä–∞</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–Ø—á–µ–π–∫–∞</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item" tpi-cc-filters-not-allowed>
                            <div class="tpi-cc--table-thead-data">
                                <p>–ù–æ–º–µ—Ä CART</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item" tpi-cc-filters-not-allowed>
                            <div class="tpi-cc--table-thead-data">
                                <p>–ù–æ–º–µ—Ä PALLET</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>C—Ç–∞—Ç—É—Å</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–ù–∞—á–∞–ª–æ<br>—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–ö–æ–Ω–µ—Ü<br>—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–ü—Ä–∏–±—ã—Ç–∏–µ<br>–∫—É—Ä—å–µ—Ä–∞</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item" tpi-cc-filters-not-allowed>
                            <div class="tpi-cc--table-thead-data">
                                <p>–ü–µ—á–∞—Ç—å</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody class="tpi-cc--table-tbody-wrapper"></tbody>
            </table>
        </div>
        <div class="tpi-cc-process-manager-wrapper" tpi-current-state="hidden">
            <div class="tpi-cc-process-manager-block">
                <div class="tpi-cc-process-manager-data-wrapper">
                    <div class="tpi-cc-process-manager-title">
                        <p>–í—ã–±—Ä–∞–Ω–Ω–æ:</p>
                    </div>
                    <div class="tpi-cc-process-data-container">
                        <div class="tpi-cc-process-data-item">
                            <i class="tpi-cc-process-data-item-icon">${tpi_cc_i_cart}</i>
                            <p class="tpi-cc-process-data-item-text tpi-cc-data-cart-amount">CART: <span>${'0'}</span></p>
                        </div>
                        <div class="tpi-cc-process-data-item">
                            <i class="tpi-cc-process-data-item-icon">${tpi_cc_i_pallet}</i>
                            <p class="tpi-cc-process-data-item-text tpi-cc-data-pallet-amount">PALLET: <span>${'0'}</span></p>
                        </div>
                    </div>
                </div>
                <button class="tpi-cc-process-manager-button" tpi-cc-action="print">
                    <p>–ü–µ—á–∞—Ç—å</p>
                    <i class="tpi-cc-progress-action-icon">${tpi_cc_i_courier_print}</i>
                </button>
                <button class="tpi-cc-process-manager-button" tpi-cc-action="delete">
                    <p>–£–¥–∞–ª–∏—Ç—å</p>
                    <i class="tpi-cc-progress-action-icon">${tpi_cc_i_courier_delete}</i>
                </button>
                <button class="tpi-cc-process-manager-close">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.44 12 21 19.56 19.56 21 12 13.44 4.44 21 3 19.56 10.56 12 3 4.44 4.44 3 12 10.56 19.56 3 21 4.44 13.44 12Z" fill="#000"></path>
                    </svg>
                </button>
            </div>
        </div>
        ${tpi_cc_liquid_glass}
        `
        
        const appID = document.getElementById("app")
        const headerTitle = document.querySelector(".p-layout__header-wrapper")
        appID.remove()
        headerTitle.remove()

        document.querySelector(".p-layout__content").appendChild(overlay);

        const tpi_cc_closeManager = document.querySelector('.tpi-cc-process-manager-close')
        tpi_cc_closeManager.addEventListener('click', ()=>{
            if(document.querySelectorAll('button.tpi-cc--table-tbody-data-button[tpi-cc-selected-courier-cell]')){
                const evrySelectedButton = document.querySelectorAll('button.tpi-cc--table-tbody-data-button[tpi-cc-selected-courier-cell]')
                evrySelectedButton.forEach(btn =>{
                    btn.removeAttribute('tpi-cc-selected-courier-cell')
                })
                update_ActionProcessContainer()
            }else return
        })
        
        callTurboPI__once();
        addTurboPiTitle()
        if (observer) {
            observer.disconnect();
            observer = null;
        }
    }


    if (isCartControlsPage(location.href)) {
        addTurboBlock();
        addCartsControlsListeners();
        addToastContainer()
        setTimeout(() => {
            tpiNotification.show('–°—Ç—Ä–∞–Ω–∏—Ü–∞ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ú–ö" –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞', "info", `–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω–æ–º, –ø–æ—Å–µ—Ç–∏—Ç–µ Wiki TURBOpi`);
        }, 100);
        return; 
    }

    observer = new MutationObserver(() => {
        if (isCartControlsPage(location.href)) {
            addTurboBlock();
        }
    });
    observer.observe(document, { subtree: true, childList: true });
    setTimeout(() => {
        addTurboPiTitle()
    }, 1000);
}

checkiIs__onCartControlsPage()

function addCartsControlsListeners(){
    waitForTokenAndRun();
    couriersDataCapturing();
    tpi_cc_filteringColumnData()
    initializeDatePicker();
    initializeCourierStatusDropdown()
    // const statusDropdown = initializeCourierStatusDropdown();
}


//B- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—É—Ä—å–µ—Ä–∞–º–∏ –∏ —è—á–µ–π–∫–∞–º–∏
async function tpi_getCouriersAndCells() {
    console.log('üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—å–µ—Ä–∞—Ö –∏ —è—á–µ–π–∫–∞—Ö...');
    
    try {
        // –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö
        const url = new URL('https://logistics.market.yandex.ru/api/resolve/');
        url.searchParams.append('r', 'sortingCenter/routes/resolveGetRoutesFullInfo:resolveGetRoutesFullInfo');

        const today = new Date();
        const currentHour = today.getHours();

        const targetDate = new Date(today);
        if (currentHour >= 22) {
            targetDate.setDate(targetDate.getDate() + 1);
        }

        const year = targetDate.getFullYear();
        const month = String(targetDate.getMonth() + 1).padStart(2, '0');
        const day = String(targetDate.getDate()).padStart(2, '0');
        const currentDate = `${year}-${month}-${day}`;
        
        const requestBody = {
            "params": [{
                "sortingCenterId": 21972131,
                "type": "OUTGOING_COURIER",
                "sort": "",
                "hasCarts": false,
                "category": "COURIER", 
                "date": currentDate,
                "recipientName": "",
                "page": 0,
                "size": 100
            }],
            "path": `/sorting-center/21972131/routes?type=OUTGOING_COURIER&sort=&hasCarts=false&category=COURIER&date=${currentDate}&recipientName=`
        };

        console.log('üìÖ –î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞:', currentDate);

        const response = await fetch(url.toString(), {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Market-Core-Service': '<UNKNOWN>',
                'sk': tpiUserTOKEN
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data && data.results && data.results.length > 0) {
            const result = data.results[0];
            
            if (result.error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ API:', result.error.message);
                return null;
            }
            
            if (result.data && result.data.content && result.data.content.length > 0) {
                const routes = result.data.content;
                console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤: ${routes.length}`);
                
                // –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º –§–ò–û –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                let courierNamesMap = {};
                const encryptedIds = [];
                const routeIdToEncryptedIdMap = {};
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ encrypted IDs
                routes.forEach((route, index) => {
                    if (route.destination && 
                        route.destination.destinationName && 
                        route.destination.destinationName.encryptedPersonalFullNameId) {
                        
                        const encryptedId = route.destination.destinationName.encryptedPersonalFullNameId;
                        encryptedIds.push(encryptedId);
                        routeIdToEncryptedIdMap[index] = encryptedId;
                    }
                });
                
                console.log(`üîê –°–æ–±—Ä–∞–Ω–æ encrypted IDs: ${encryptedIds.length}`);
                
                if (encryptedIds.length > 0) {
                    console.log('üì§ –ü–æ–ª—É—á–∞–µ–º –§–ò–û –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É...');
                    courierNamesMap = await tpi_getCourierNamesOneByOneWithCache(encryptedIds);
                    console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –§–ò–û –¥–ª—è ${Object.keys(courierNamesMap).length} –∫—É—Ä—å–µ—Ä–æ–≤`);
                }
                
                // –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
                const couriersData = routes.map((route, index) => {
                    // –ü–æ–ª—É—á–∞–µ–º –§–ò–û
                    let courierName = '–ù–µ —É–∫–∞–∑–∞–Ω';
                    const encryptedId = routeIdToEncryptedIdMap[index];
                    
                    if (encryptedId && courierNamesMap[encryptedId]) {
                        courierName = courierNamesMap[encryptedId];
                    } else if (route.courier && route.courier.externalId) {
                        courierName = `–ö—É—Ä—å–µ—Ä ${route.courier.externalId}`;
                    } else if (route.courier && route.courier.id) {
                        courierName = `–ö—É—Ä—å–µ—Ä ID:${route.courier.id}`;
                    }
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è—á–µ–π–∫—É
                    let cellNumbers = '–ù–µ—Ç —è—á–µ–µ–∫';
                    let mainCell = '–ù–µ—Ç —è—á–µ–π–∫–∏';
                    
                    if (route.cells && route.cells.length > 0) {
                        // –ï—Å—Ç—å —è—á–µ–π–∫–∏
                        cellNumbers = route.cells.map(cell => cell.number || '–ë–µ–∑ –Ω–æ–º–µ—Ä–∞').join(', ');
                        mainCell = route.cells[0]?.number || '–ù–µ—Ç —è—á–µ–π–∫–∏';
                    } else if (route.cell && route.cell.number) {
                        // –ï—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ cell
                        cellNumbers = route.cell.number;
                        mainCell = route.cell.number;
                    } else {
                        // –ü—É—Å—Ç–æ–π cells - –∫—É—Ä—å–µ—Ä —É–∂–µ –æ—Ç–≥—Ä—É–∂–µ–Ω –∏ –ø—Ä–æ–ø–∞–ª
                        cellNumbers = 'null';
                        mainCell = 'null';
                    }
                    
                    const routeStatus = route.status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    
                    return {
                        courier: courierName,
                        cell: mainCell,
                        cells: cellNumbers,
                        status: routeStatus,
                        ordersLeft: route.ordersLeft || 0,
                        ordersSorted: route.ordersSorted || 0,
                        ordersShipped: route.ordersShipped || 0,
                        ordersPlanned: route.ordersPlanned || 0,
                        sortablesInCell: route.sortablesInCell || 0,
                        sortablesPrepared: route.sortablesPrepared || 0,
                        courierArrivesAt: route.courierArrivesAt || null,
                        startedAt: route.startedAt || null,
                        finishedAt: route.finishedAt || null,
                        routeId: route.id || null,
                        courierId: route.courier?.id || null,
                        externalId: route.courier?.externalId || null,
                        encryptedId: encryptedId || null,
                        hasCells: route.cells && route.cells.length > 0
                    };
                });
                
                console.log(`üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∫—É—Ä—å–µ—Ä–æ–≤: ${couriersData.length}`);
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –§–ò–û
                const withRealNames = couriersData.filter(item => 
                    !item.courier.startsWith('–ö—É—Ä—å–µ—Ä ') && 
                    !item.courier.startsWith('–ö—É—Ä—å–µ—Ä ID:') && 
                    item.courier !== '–ù–µ —É–∫–∞–∑–∞–Ω'
                ).length;
                
                console.log('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –§–ò–û:');
                console.log(`  - –° —Ä–µ–∞–ª—å–Ω—ã–º–∏ –§–ò–û: ${withRealNames}`);
                console.log(`  - –° ID –≤–º–µ—Å—Ç–æ –§–ò–û: ${couriersData.length - withRealNames}`);
                
                // –ü–æ–∫–∞–∂–µ–º –ø—Ä–∏–º–µ—Ä—ã –∫—É—Ä—å–µ—Ä–æ–≤ —Å –§–ò–û –∏ –±–µ–∑
                const withNames = couriersData.filter(item => !item.courier.includes('–ö—É—Ä—å–µ—Ä'));
                const withoutNames = couriersData.filter(item => item.courier.includes('–ö—É—Ä—å–µ—Ä'));
                
                if (withNames.length > 0) {
                    console.log('\n‚úÖ –ö—É—Ä—å–µ—Ä—ã —Å –§–ò–û:');
                    withNames.slice(0, 5).forEach((item, i) => {
                        console.log(`  ${i + 1}. ${item.courier} (${item.cell})`);
                    });
                }
                
                if (withoutNames.length > 0) {
                    console.log('\n‚ö†Ô∏è –ö—É—Ä—å–µ—Ä—ã –±–µ–∑ –§–ò–û (—Ç–æ–ª—å–∫–æ ID):');
                    withoutNames.slice(0, 5).forEach((item, i) => {
                        console.log(`  ${i + 1}. ${item.courier} (${item.cell})`);
                    });
                    console.log(`  ...–∏ –µ—â–µ ${withoutNames.length - 5} –¥—Ä—É–≥–∏—Ö`);
                }
                
                return couriersData;
                
            } else {
                console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö');
                return null;
            }
        } else {
            console.log('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
            return null;
        }
    } catch (error) {
        console.error('üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        return null;
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –§–ò–û –ø–æ –æ–¥–Ω–æ–º—É —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function tpi_getCourierNamesOneByOneWithCache(encryptedIds) {
    const nameMap = {};
    const batchSize = 15; // –ü–æ 3 –∑–∞ —Ä–∞–∑
    const delay = 1500; // –ó–∞–¥–µ—Ä–∂–∫–∞ 1.5 —Å–µ–∫ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
    
    console.log(`üîê –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –§–ò–û –¥–ª—è ${encryptedIds.length} –∫—É—Ä—å–µ—Ä–æ–≤...`);
    
    // –°–æ–∑–¥–∞–µ–º –∫—ç—à –≤ localStorage
    const cacheKey = 'tpi_courier_names_cache';
    let cache = {};
    
    try {
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            cache = JSON.parse(cached);
            console.log(`üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(cache).length} –§–ò–û –∏–∑ –∫—ç—à–∞`);
        }
    } catch (e) {
        console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—ç—à');
    }
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    const toFetch = [];
    encryptedIds.forEach(id => {
        if (cache[id]) {
            nameMap[id] = cache[id];
        } else {
            toFetch.push(id);
        }
    });
    
    console.log(`üìä –ò–∑ –∫—ç—à–∞: ${Object.keys(nameMap).length}, –Ω—É–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å: ${toFetch.length}`);
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è
    for (let i = 0; i < toFetch.length; i += batchSize) {
        const batch = toFetch.slice(i, i + batchSize);
        console.log(`üì¶ –ë–∞—Ç—á ${Math.floor(i/batchSize) + 1}: ${batch.length} —à—Ç`);
        
        const promises = batch.map(async (encryptedId) => {
            try {
                const name = await tpi_getSingleCourierName(encryptedId);
                if (name) {
                    nameMap[encryptedId] = name;
                    cache[encryptedId] = name; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    return { success: true, id: encryptedId };
                }
                return { success: false, id: encryptedId };
            } catch (error) {
                console.log(`‚ùå –û—à–∏–±–∫–∞ –¥–ª—è ${encryptedId.substring(0, 15)}...: ${error.message}`);
                return { success: false, id: encryptedId };
            }
        });
        
        const results = await Promise.all(promises);
        const successCount = results.filter(r => r.success).length;
        console.log(`  ‚úÖ –£—Å–ø–µ—à–Ω–æ: ${successCount}/${batch.length}`);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—ç—à –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞
        try {
            localStorage.setItem(cacheKey, JSON.stringify(cache));
        } catch (e) {
            console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—ç—à');
        }
        
        // –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –±–∞—Ç—á–µ–º
        if (i + batchSize < toFetch.length) {
            console.log(`  ‚è≥ –ñ–¥–µ–º ${delay}ms...`);
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
    
    console.log(`üéØ –ò—Ç–æ–≥: ${Object.keys(nameMap).length} –§–ò–û (${Object.keys(nameMap).length - (encryptedIds.length - toFetch.length)} –Ω–æ–≤—ã—Ö)`);
    return nameMap;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –§–ò–û –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞
async function tpi_getSingleCourierName(encryptedId) {
    try {
        const url = new URL('https://logistics.market.yandex.ru/api/resolve/');
        url.searchParams.append('r', 'logPoint/getLogpointPersonalIdBulk:getLogpointPersonalIdBulk');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
        const requestBody = {
            "params": [{
                "campaignId": 21972131,
                "ids": [encryptedId]
            }],
            "path": `/sorting-center/21972131/routes?type=OUTGOING_COURIER&sort=&hasCarts=false&category=COURIER`
        };

        const response = await fetch(url.toString(), {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Market-Core-Service': '<UNKNOWN>',
                'sk': tpiUserTOKEN
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            return null;
        }

        const responseText = await response.text();
        if (!responseText) return null;

        try {
            const data = JSON.parse(responseText);
            if (data && data.results && data.results[0] && data.results[0].data) {
                const name = Object.values(data.results[0].data)[0];
                if (name && typeof name === 'string') {
                    return name;
                }
            }
        } catch (e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
        }
        
        return null;
    } catch (error) {
        return null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º
function sortCouriersByGroups(couriersData) {
    const firstWave = []; // MK-1...
    const secondWave = []; // MK-2...
    const kgt = []; // KGT...
    const alreadyGone = []; // null
    const others = []; // –û—Å—Ç–∞–ª—å–Ω—ã–µ
    
    couriersData.forEach(courier => {
        const cell = courier.cell.toUpperCase();
        
        if (cell === 'null') {
            alreadyGone.push(courier);
        } else if (cell.startsWith('MK-1')) {
            firstWave.push(courier);
        } else if (cell.startsWith('MK-2')) {
            secondWave.push(courier);
        } else if (cell.startsWith('KGT')) {
            kgt.push(courier);
        } else {
            others.push(courier);
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –Ω–æ–º–µ—Ä—É —è—á–µ–π–∫–∏
    const sortByCellNumber = (a, b) => {
        if (a.cell === 'null' || b.cell === 'null') return 0;
        
        const extractNumber = (cell) => {
            const match = cell.match(/\d+/);
            return match ? parseInt(match[0]) : 0;
        };
        
        return extractNumber(a.cell) - extractNumber(b.cell);
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –§–ò–û (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –ø–æ ID
    const sortByNameOrId = (a, b) => {
        // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–∞–ª–∏—á–∏—é —Ä–µ–∞–ª—å–Ω–æ–≥–æ –§–ò–û
        const aHasRealName = !a.courier.includes('–ö—É—Ä—å–µ—Ä ');
        const bHasRealName = !b.courier.includes('–ö—É—Ä—å–µ—Ä ');
        
        if (aHasRealName && !bHasRealName) return -1;
        if (!aHasRealName && bHasRealName) return 1;
        
        // –ï—Å–ª–∏ –æ–±–∞ —Å –§–ò–û –∏–ª–∏ –æ–±–∞ –±–µ–∑ - —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏/ID
        return a.courier.localeCompare(b.courier);
    };
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –≥—Ä—É–ø–ø—É
    firstWave.sort(sortByCellNumber);
    secondWave.sort(sortByCellNumber);
    kgt.sort(sortByCellNumber);
    others.sort(sortByCellNumber);
    alreadyGone.sort(sortByNameOrId); // –°–æ—Ä—Ç–∏—Ä—É–µ–º "null" –ø–æ –∏–º–µ–Ω–∏
    
    return { firstWave, secondWave, kgt, alreadyGone, others };
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–∞–±–ª–∏—Ü—ã –≤ –∫–æ–Ω—Å–æ–ª—å
function displayCourierTable(couriers, title) {
    if (couriers.length === 0) return;
    
    console.log(`\nüìã ${title} (${couriers.length}):`);
    
    const tableData = couriers.map(item => ({
        '–Ø—á–µ–π–∫–∞': item.cell,
        '–ö—É—Ä—å–µ—Ä': item.courier,
        '–°—Ç–∞—Ç—É—Å': item.status,
        '–û—Å—Ç–∞–ª–æ—Å—å': item.ordersLeft,
        '–û—Ç–≥—Ä—É–∂–µ–Ω–æ': item.ordersShipped,
        '–í—Å–µ–≥–æ': item.ordersPlanned,
        '–ü—Ä–∏–±—ã—Ç–∏–µ': item.courierArrivesAt ? new Date(item.courierArrivesAt).toLocaleTimeString() : '-'
    }));
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É: —Å–Ω–∞—á–∞–ª–∞ —Å –§–ò–û, –ø–æ—Ç–æ–º —Å ID
    tableData.sort((a, b) => {
        const aHasName = !a.–ö—É—Ä—å–µ—Ä.includes('–ö—É—Ä—å–µ—Ä ');
        const bHasName = !b.–ö—É—Ä—å–µ—Ä.includes('–ö—É—Ä—å–µ—Ä ');
        if (aHasName && !bHasName) return -1;
        if (!aHasName && bHasName) return 1;
        return a.–ö—É—Ä—å–µ—Ä.localeCompare(b.–ö—É—Ä—å–µ—Ä);
    });
    
    console.table(tableData);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–∑–æ–≤–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π –≤ –∫–æ–Ω—Å–æ–ª–∏
async function showCouriers() {
    try {
        console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—å–µ—Ä–∞—Ö...');
        const data = await tpi_getCouriersAndCells();
        
        if (!data || data.length === 0) {
            console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—å–µ—Ä–∞—Ö');
            return;
        }

        console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${data.length} –∫—É—Ä—å–µ—Ä–æ–≤`);
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º
        const { firstWave, secondWave, kgt, alreadyGone, others } = sortCouriersByGroups(data);
        
        // –í—ã–≤–æ–¥–∏–º —Ç–∞–±–ª–∏—Ü—ã
        displayCourierTable(firstWave, '–ü–ï–†–í–ê–Ø –í–û–õ–ù–ê (MK-1...)');
        displayCourierTable(secondWave, '–í–¢–û–†–ê–Ø –í–û–õ–ù–ê (MK-2...)');
        displayCourierTable(kgt, '–ö–ì–¢ (KGT...)');
        displayCourierTable(alreadyGone, 'null–ò');
        
        if (others.length > 0) {
            displayCourierTable(others, '–î–†–£–ì–ò–ï –Ø–ß–ï–ô–ö–ò');
        }
        
        // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const shippedCouriers = data.filter(item => item.status === 'SHIPPED').length;
        const withRealNames = data.filter(item => !item.courier.includes('–ö—É—Ä—å–µ—Ä ')).length;
        const totalOrdersLeft = data.reduce((sum, item) => sum + (item.ordersLeft || 0), 0);
        const totalOrdersShipped = data.reduce((sum, item) => sum + (item.ordersShipped || 0), 0);
        const totalOrdersPlanned = data.reduce((sum, item) => sum + (item.ordersPlanned || 0), 0);
        
        console.log(`\nüìà –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:`);
        console.log(`   –í—Å–µ–≥–æ –∫—É—Ä—å–µ—Ä–æ–≤: ${data.length}`);
        console.log(`   ‚îú‚îÄ –° –§–ò–û: ${withRealNames}`);
        console.log(`   ‚îú‚îÄ –° ID: ${data.length - withRealNames}`);
        console.log(`   ‚îú‚îÄ –ü–µ—Ä–≤–∞—è –≤–æ–ª–Ω–∞: ${firstWave.length}`);
        console.log(`   ‚îú‚îÄ –í—Ç–æ—Ä–∞—è –≤–æ–ª–Ω–∞: ${secondWave.length}`);
        console.log(`   ‚îú‚îÄ –ö–ì–¢: ${kgt.length}`);
        console.log(`   ‚îú‚îÄ null–∏: ${alreadyGone.length}`);
        console.log(`   ‚îî‚îÄ –î—Ä—É–≥–∏–µ: ${others.length}`);
        console.log(`   –û—Ç–≥—Ä—É–∂–µ–Ω–æ: ${shippedCouriers}`);
        console.log(`   –í —Ä–∞–±–æ—Ç–µ: ${data.length - shippedCouriers}`);
        console.log(`   –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${totalOrdersPlanned}`);
        console.log(`   –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: ${totalOrdersLeft}`);
        console.log(`   –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ: ${totalOrdersShipped}`);
        const efficiency = totalOrdersPlanned > 0 ? ((totalOrdersShipped / totalOrdersPlanned) * 100).toFixed(1) : 0;
        console.log(`   –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${efficiency}%`);
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        console.log(`\nüìä –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û:`);
        console.log(`   –°—Ä–µ–¥–Ω–µ–µ –Ω–∞ –∫—É—Ä—å–µ—Ä–∞: ${(totalOrdersPlanned / data.length).toFixed(1)} –∑–∞–∫–∞–∑–æ–≤`);
        console.log(`   –°—Ä–µ–¥–Ω–µ–µ –æ—Å—Ç–∞–ª–æ—Å—å: ${(totalOrdersLeft / data.length).toFixed(1)} –Ω–∞ –∫—É—Ä—å–µ—Ä–∞`);
        
        // –ü–æ–∫–∞–∂–µ–º –∫—É—Ä—å–µ—Ä–æ–≤ —Å –§–ò–û
        const couriersWithNames = data.filter(item => !item.courier.includes('–ö—É—Ä—å–µ—Ä '));
        if (couriersWithNames.length > 0) {
            console.log(`\nüë§ –ö—É—Ä—å–µ—Ä—ã —Å –§–ò–û (${couriersWithNames.length}):`);
            couriersWithNames.forEach(item => {
                console.log(`  ‚Ä¢ ${item.courier}`);
            });
        }
        
    } catch (error) {
        console.error('üí• –û—à–∏–±–∫–∞:', error);
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
window.tpi_getCouriersAndCells = tpi_getCouriersAndCells;
window.showCouriers = showCouriers;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ –§–ò–û
function tpi_clearCourierNamesCache() {
    localStorage.removeItem('tpi_courier_names_cache');
    console.log('üóëÔ∏è –ö—ç—à –§–ò–û –æ—á–∏—â–µ–Ω');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–∞
function waitForTokenAndRun() {
    let attempts = 0;
    const maxAttempts = 15;
    
    const checkInterval = setInterval(() => {
        attempts++;
        
        if (tpiUserTOKEN !== null && tpiUserTOKEN !== undefined) {
            console.log('‚úÖ –¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
            clearInterval(checkInterval);
            // showCouriers();
        } else if (attempts >= maxAttempts) {
            console.log('‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞');
            clearInterval(checkInterval);
        } else {
            console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞... (–ø–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts})`);
        }
    }, 1000);
}

let dataCapturingFlag = false

function couriersDataCapturing(){
    const tpi_cc_startButton = document.querySelector('.tpi-cc--no-ds-data-start')
    const tpi_cc_areaContainer = document.querySelector('.tpi-cc--no-ds-data-container')
    const tpi_cc_desctiption = document.querySelector('.tpi-cc--no-ds-data-description')
    const tpi_cc_tableBody = document.querySelector('.tpi-cc--table-tbody-wrapper')
    
    tpi_cc_startButton.addEventListener('click', async () => {
        if(dataCapturingFlag === false){
            document.querySelector('.tpi-cc--no-ds-data-title').innerHTML = "<p>–ó–∞–≥—Ä—É–∑–∫–∞</p>"
            dataCapturingFlag = true
            tpi_cc_areaContainer.setAttribute('tpi-current-state', 'loading-data')
            tpi_cc_desctiption.innerHTML = `
                <div class="tpi-cc-no-ds-data-loading-item" tpi-cc-search-id="0" tpi-cc-status="waiting">
                    <i class="tpi-cc-no-ds-data-loading-item-icon"></i>
                    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞</p>
                </div>
                <div class="tpi-cc-no-ds-data-loading-item" tpi-cc-search-id="1" tpi-cc-status="waiting">
                    <i class="tpi-cc-no-ds-data-loading-item-icon"></i>
                    <p>–ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤</p>
                </div>
                <div class="tpi-cc-no-ds-data-loading-item" tpi-cc-search-id="2" tpi-cc-status="waiting">
                    <i class="tpi-cc-no-ds-data-loading-item-icon"></i>
                    <p>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤</p>
                </div>
                <div class="tpi-cc-no-ds-data-loading-item" tpi-cc-search-id="3" tpi-cc-status="waiting">
                    <i class="tpi-cc-no-ds-data-loading-item-icon"></i>
                    <p>–ó–∞–ø–∏—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</p>
                </div>
                <div class="tpi-cc-no-ds-data-loading-item" tpi-cc-search-id="4" tpi-cc-status="waiting">
                    <i class="tpi-cc-no-ds-data-loading-item-icon"></i>
                    <p>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ DOM</p>
                </div>
            `
            
            await fillCouriersTable();
        } else return
    })
    
    async function fillCouriersTable() {
        try {
            console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã...');
    
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
            updateLoadingStatus(0, 'in-progress');
    
            // –®–∞–≥ 0: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞ (—Ä–µ–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)
            if (!tpiUserTOKEN) {
                throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            // –ú–∏–Ω–∏–º—É–º 1.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            await new Promise(resolve => setTimeout(resolve, 1500));
            updateLoadingStatus(0, 'complete');
    
            // –®–∞–≥ 1: –ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤
            updateLoadingStatus(1, 'in-progress');
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫—É—Ä—å–µ—Ä–∞—Ö
            const data = await tpi_getCouriersAndCells();
    
            if (!data || data.length === 0) {
                throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—å–µ—Ä–∞—Ö');
            }
            
            // –ú–∏–Ω–∏–º—É–º 1.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            await new Promise(resolve => setTimeout(resolve, 1500));
            updateLoadingStatus(1, 'complete');
    
            // –®–∞–≥ 2: –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
            updateLoadingStatus(2, 'in-progress');
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º
            const { firstWave, secondWave, kgt, alreadyGone, others } = sortCouriersByGroups(data);
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã
            const allCouriers = [
                ...firstWave,
                ...secondWave, 
                ...kgt,
                ...alreadyGone,
                ...others
            ];
            
            // –ú–∏–Ω–∏–º—É–º 1.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            await new Promise(resolve => setTimeout(resolve, 1500));
            updateLoadingStatus(2, 'complete');
    
            // –®–∞–≥ 3: –ó–∞–ø–∏—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            updateLoadingStatus(3, 'in-progress');
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
            await new Promise(resolve => setTimeout(resolve, 3000));
            updateLoadingStatus(3, 'complete');
    
            // –®–∞–≥ 4: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ DOM
            updateLoadingStatus(4, 'in-progress');
            
            // –ú–∏–Ω–∏–º—É–º 1.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ complete
            updateLoadingStatus(4, 'complete');

            await new Promise(resolve => setTimeout(resolve, 500));
            const progressContainerWrapper = document.querySelector('.tpi-cc--no-ds-data-container')
            progressContainerWrapper.setAttribute('tpi-current-state', 'loading-data-animation')
            await new Promise(resolve => setTimeout(resolve, 1500));
            document.querySelector('.tpi-cc-no-ds-data-loading-item[tpi-cc-search-id="2"] p').innerText = "–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, —Ö–æ—Ä–æ—à–µ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏!"
            progressContainerWrapper.setAttribute('tpi-current-state', 'done')

            // –ñ–¥–µ–º 1.5 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥ —Å—Ç–∞–ª complete
            await new Promise(resolve => setTimeout(resolve, 2000));

            progressContainerWrapper.setAttribute('tpi-current-state', 'hidden')

            await new Promise(resolve => setTimeout(resolve, 600));
            
            // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞
            allCouriers.forEach((courier, index) => {
                const row = createCourierTableRow(courier, index);
                tpi_cc_tableBody.appendChild(row);
            });
            saveOriginalRowOrder();
            initializeAllFilters();
            // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            document.querySelector('.tpi-cc--no-ds-data-wrapper').style.display = 'none';
            document.querySelector('.tpi-cc--table-wrapper').style.display = 'block';
    
            cartPallet_btnActions();
            tpi_cc_filteringColumnData();
            
        } catch (error) {
            console.log('üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã:', error);
            updateLoadingStatus(0, 'error');
        }
    }

    function cartPallet_btnActions() {
        const tpi_cc_actionButtons = document.querySelectorAll('.tpi-cc-table-tbody-data-cart-id, .tpi-cc-table-tbody-data-pallet-id');
        tpi_cc_actionButtons.forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', () => {
                if (newBtn.hasAttribute('tpi-cc-selected-courier-cell')) {
                    newBtn.removeAttribute('tpi-cc-selected-courier-cell');
                } else {
                    newBtn.setAttribute('tpi-cc-selected-courier-cell', '');
                }
                update_ActionProcessContainer();
            });
        });
        update_ActionProcessContainer();
    }

    function createCourierTableRow(courierData, index) {
        const row = document.createElement('tr');
        row.className = 'tpi-cc--table-tbody';
        
        const sortCount = courierData.ordersSorted > 0 
            ? courierData.ordersSorted 
            : (courierData.ordersShipped > 0 ? courierData.ordersShipped : 0);
            
        const sortPercent = courierData.ordersPlanned > 0 
            ? Math.round((sortCount / courierData.ordersPlanned) * 100)
            : 0;
            
        const preparedPercent = courierData.sortablesInCell > 0
            ? Math.round((courierData.sortablesPrepared / courierData.sortablesInCell) * 100)
            : 0;
        
        // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
        const sortColor = getProgressColor(sortPercent);
        const preparedColor = getProgressColor(preparedPercent);
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
        const startedDate = courierData.startedAt ? cc_formatDate(courierData.startedAt) : null;
        const startedTime = courierData.startedAt ? cc_formatTime(courierData.startedAt) : null;
        const endedDate = courierData.finishedAt ? cc_formatDate(courierData.finishedAt) : null;
        const endedTime = courierData.finishedAt ? cc_formatTime(courierData.finishedAt) : null;
        const arrivesDate = courierData.courierArrivesAt ? cc_formatDate(courierData.courierArrivesAt) : null;
        const arrivesTime = courierData.courierArrivesAt ? cc_formatTime(courierData.courierArrivesAt) : null;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∞—Ä—à—Ä—É—Ç–∞
        const routeStatusText = getRouteStatusText(courierData.status);
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∏–∑ —è—á–µ–π–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "101" –∏–∑ "MK-101")
        let cellNumber = "000";
        if (courierData.cell && courierData.cell !== 'null' && courierData.cell !== '–ù–µ—Ç —è—á–µ–π–∫–∏') {
            const match = courierData.cell.match(/\d+/);
            cellNumber = match ? match[0].padStart(3, '0') : "000";
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫—É—Ä—å–µ—Ä –ö–ì–¢
        const isKGT = courierData.cell.toUpperCase().startsWith('KGT');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —è—á–µ–π–∫–∞ null
        const isNullCell = courierData.cell === 'null';
        
        // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∫–Ω–æ–ø–æ–∫ CART (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤, –Ω–µ –¥–ª—è null —è—á–µ–µ–∫)
        let cartButtonsHTML = '';
        if (!isNullCell && !isKGT) {
            // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤ - 4 –∫–Ω–æ–ø–∫–∏ CART
            for (let i = 1; i <= 4; i++) {
                const cartNumber = `${cellNumber}${i}`;
                cartButtonsHTML += `
                    <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-cart-id" tpi-data-courier-spec-cell="CART-${cartNumber}">
                        <i class="tpi-cc-table-tbody-data-cart-icon">${tpi_cc_i_cart}</i>
                        -${cartNumber}
                    </button>
                `;
            }
        }
        
        // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è CART (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
        const addCartButton = `
            <div class="tpi-cc--carts-control-buttons-wrapper">
                <button class="tpi-cc--table-tbody-add-cart" tpi-state-change="tpi-add-cart">
                    <i>${tpi_cc_i_cart_add}</i>
                </button>
            </div>
        `;
        
        // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∫–Ω–æ–ø–æ–∫ PALLET (–¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤ –∏ –ö–ì–¢, –Ω–µ –¥–ª—è null —è—á–µ–µ–∫)
        let palletButtonsHTML = '';
        if (!isNullCell) {
            if (isKGT) {
                // –î–ª—è –ö–ì–¢ - –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ PALLET —Å –Ω–æ–º–µ—Ä–æ–º —è—á–µ–π–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1" –∏–∑ "KGT-1")
                const kgtNumber = courierData.cell.replace('KGT-', '').replace('kgt-', '');
                palletButtonsHTML += `
                    <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-pallet-id" tpi-data-courier-spec-cell="PALLET-${kgtNumber}">
                        <i class="tpi-cc-table-tbody-data-pallet-icon">${tpi_cc_i_pallet}</i>
                        -${kgtNumber}
                    </button>
                `;
            } else {
                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤ - 2 –∫–Ω–æ–ø–∫–∏ PALLET —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏
                const palletNumbers = generateRandomPalletNumbers(2, index);
                palletNumbers.forEach(palletNumber => {
                    palletButtonsHTML += `
                        <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-pallet-id" tpi-data-courier-spec-cell="PALLET-${palletNumber}">
                            <i class="tpi-cc-table-tbody-data-pallet-icon">${tpi_cc_i_pallet}</i>
                            -${palletNumber}
                        </button>
                    `;
                });
            }
        }
        
        // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è PALLET (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
        const addPalletButton = `
            <div class="tpi-cc--carts-control-buttons-wrapper">
                <button class="tpi-cc--table-tbody-add-pallet" tpi-state-change="tpi-add-pallet">
                    <i>${tpi_cc_i_cart_add}</i>
                </button>
            </div>
        `;
        
        row.innerHTML = `
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data-courier">
                    <div class="tpi-cc--sortable-data-wrapper tpi-cc--courier-id-data-wrapper">
                        <a href="https://logistics.market.yandex.ru/sorting-center/21972131/routes?type=OUTGOING_COURIER&sort=&hasCarts=false&category=COURIER&id=21972131&page=1&pageSize=50&recipientName=${courierData.externalId}" target="_blank" class="tpi-cc--table-tbody-data-link">
                            <i>${tpi_cc_i_courier}</i>
                            <p class="tpi-cc--sortable-data-courier" tpi-cc-parsing-data="courier-full-name">${courierData.courier}</p>
                        </a>
                        <div class="tpi-cc--table-tbody-data-courier-extra-info-wrapper">
                            <div class="tpi-cc--table-tbody-data-courier-extra-info">
                                <i>${tpi_cc_i_courier_route_id}</i>
                                <p tpi-cc-parsing-data="courier-route-id">${courierData.routeId || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                            </div>
                            <div class="tpi-cc--table-tbody-data-courier-extra-info">
                                <i>${tpi_cc_i_courier_id}</i>
                                <p tpi-cc-parsing-data="courier-personal-id">${courierData.externalId || courierData.courierId || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data">
                    <a href="https://logistics.market.yandex.ru/sorting-center/21972131/sortables?sortableTypes=CART&sortableTypes=COURIER_PALLET&cellName=${courierData.cell}" class="tpi-cc--table-tbody-data-link" tpi-cc-parsing-data="courier-route-cell" target="_blank">
                        ${courierData.cell}
                    </a>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-carts">
                    ${cartButtonsHTML}
                    ${addCartButton}
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-pallets">
                    ${palletButtonsHTML}
                    ${addPalletButton}
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data">
                    <div class="tpi-cc-table-tbody-data-route-status" tpi-cc-route-status="${courierData.status.toLowerCase()}">
                        <i></i>
                        <p tpi-cc-parsing-data="courier-route-status">${routeStatusText}</p>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-sort-progress-container">
                        <p class="tpi-cc--table-tbody-data-sort-progress" tpi-cc-parsing-data="courier-sorting-progress">
                            ${sortCount} –∏–∑ ${courierData.ordersPlanned || 0}
                        </p>
                    <div class="tpi-cc--table-tbody-data-sort-progress-circle-wrapper">
                        <p class="tpi-cc--table-tbody-data-sort-progress-circle-value" tpi-cc-parsing-data="courier-sorting-progress-percent">
                            ${sortPercent}%
                        </p>
                        <svg width="50" height="50" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(-90deg)">
                            <circle cx="25" cy="25" r="20" fill="transparent" stroke="#e8e8e8" stroke-width="4"></circle>
                            <circle cx="25" cy="25" r="20" fill="transparent" 
                                    stroke="${sortColor}" stroke-width="5" stroke-linecap="round"
                                    stroke-dasharray="125.6" 
                                    stroke-dashoffset="${125.6 - (125.6 * sortPercent / 100)}"
                                    tpi-cc-parsing-data="courier-sorting-progress-circle">
                            </circle>
                        </svg>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-sort-progress-container">
                    <p class="tpi-cc--table-tbody-data-sort-progress" tpi-cc-parsing-data="courier-prepared-progress">
                        ${courierData.sortablesPrepared || 0} –∏–∑ ${courierData.sortablesInCell || 0}
                    </p>
                    <div class="tpi-cc--table-tbody-data-sort-progress-circle-wrapper">
                        <p class="tpi-cc--table-tbody-data-sort-progress-circle-value" tpi-cc-parsing-data="courier-prepared-progress-percent">
                            ${preparedPercent}%
                        </p>
                        <svg width="50" height="50" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(-90deg)">
                            <circle cx="25" cy="25" r="20" fill="transparent" stroke="#e8e8e8" stroke-width="4"></circle>
                            <circle cx="25" cy="25" r="20" fill="transparent" 
                                    stroke="${preparedColor}" stroke-width="5" stroke-linecap="round"
                                    stroke-dasharray="125.6" 
                                    stroke-dashoffset="${125.6 - (125.6 * preparedPercent / 100)}"
                                    tpi-cc-parsing-data="courier-prepared-progress-circle">
                            </circle>
                        </svg>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-body-date-container">
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_calendar}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-date-type="start" tpi-cc-parsing-data="courier-started-at-date">
                            ${startedDate || 'null'}
                        </p>
                    </div>
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_clock}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-time-type="start" tpi-cc-parsing-data="courier-started-at-time">
                            ${startedTime || 'null'}
                        </p>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-body-date-container">
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_calendar}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-date-type="end" tpi-cc-parsing-data="courier-ended-at-date">
                            ${endedDate || 'null'}
                        </p>
                    </div>
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_clock}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-time-type="end" tpi-cc-parsing-data="courier-ended-at-time">
                            ${endedTime || 'null'}
                        </p>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-body-date-container">
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_calendar}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-date-type="arrived" tpi-cc-parsing-data="courier-arrives-at-date">
                            ${arrivesDate || 'null'}
                        </p>
                    </div>
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_clock}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-time-type="arrived" tpi-cc-parsing-data="courier-arrives-at-time">
                            ${arrivesTime || 'null'}
                        </p>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-body-print-container">
                    <button class="tpi-cc--print-current-row">
                        <p class="tpi-cc--table-tbody-data-courier-print-text">–ü–µ—á–∞—Ç—å</p>
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_courier_print}</i>
                    </button>
                </div>
            </td>
        `;
        
        return row;
    }

    function getProgressColor(percent) {
        let r, g, b;
        
        if (percent <= 50) {
            const ratio = percent / 50;
            r = Math.floor(255);
            g = Math.floor(ratio * 204);
            b = 0;
        } else {
            const ratio = (percent - 50) / 50;
            r = Math.floor(255 - (255 - 42) * ratio);
            g = Math.floor(204 + (173 - 204) * ratio);
            b = Math.floor(0 + 46 * ratio);
        }
        return `rgb(${r}, ${g}, ${b})`;
    }

    function generateRandomPalletNumbers(count, seed) {
    const numbers = [];
    const usedNumbers = new Set();
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º seed –¥–ª—è –ø—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏, –Ω–æ —Ä–∞–∑–Ω–æ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞
    const baseSeed = seed * 9301 + 49297; // –ü—Ä–æ—Å—Ç—ã–µ —á–∏—Å–ª–∞ –¥–ª—è –ª—É—á—à–µ–π —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
    
    for (let i = 0; i < count; i++) {
        let number;
        let attempts = 0;
        
        do {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç 100 –¥–æ 999
            const random = (baseSeed * (i + 1) * 233 + 741) % 900;
            number = 100 + random;
            attempts++;
            
            // –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –∑–∞ 10 –ø–æ–ø—ã—Ç–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ
            if (attempts > 10) {
                number = 100 + ((baseSeed + i) % 900);
                while (usedNumbers.has(number) && number < 999) {
                    number++;
                }
            }
        } while (usedNumbers.has(number) && number >= 100 && number <= 999);
        
        numbers.push(number);
        usedNumbers.add(number);
    }
    
    return numbers;
}

    function updateLoadingStatus(stepId, status) {
        const loadingItem = document.querySelector(`[tpi-cc-search-id="${stepId}"]`);
        if (loadingItem) {
            loadingItem.setAttribute('tpi-cc-status', status);
        }
    }

    function cc_formatDate(dateString) {
        if (!dateString || dateString === 'null') return null;

        try {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã:', e);
            return null;
        }
    }

    function cc_formatTime(dateString) {
        if (!dateString || dateString === 'null') return null;

        try {
            const date = new Date(dateString);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:', e);
            return null;
        }
    }
    function getRouteStatusText(status) {
        switch(status) {
            case 'CELL_SHIPPED':
                return '–ü–µ—Ä–µ–¥–∞–Ω–æ –∫—É—Ä—å–µ—Ä—É';
            case 'FINISHED':
                return '–°–æ–±—Ä–∞–Ω';
            case 'IN_PROGRESS':
                return '–í —Ä–∞–±–æ—Ç–µ';
            case 'NOT_STARTED':
                return '–ù–µ –Ω–∞—á–∞—Ç';
            case 'SHIPPED':
                return '–û—Ç–≥—Ä—É–∂–µ–Ω';
            default:
                return status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }
    }
}


function tpi_cc_filteringColumnData() {
    const table = document.querySelector('table.tpi-cc--table-data-output');
    if (!table) {
        tpiNotification.show('–û—à–∏–±–∫–∞', "error", "–ù–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ —Ç–∞–±–ª–∏—Ü—É");
        return;
    }
    
    table.addEventListener('click', (event) => {
        const headerItem = event.target.closest('.tpi-cc--table-thead-item');
        if (!headerItem) return;
        if (headerItem.hasAttribute('tpi-cc-filters-not-allowed')) {
            return;
        }
        
        const targetDiv = headerItem.querySelector('div.tpi-cc--table-thead-data');
        if (!targetDiv) return;
        
        const currentState = targetDiv.getAttribute('tpi-current-state');
        let nextState = null;
        
        if (!currentState) {
            nextState = 'filtered-down';
        } else if (currentState === 'filtered-down') {
            nextState = 'filtered-up';
        }
        
        document.querySelectorAll('div.tpi-cc--table-thead-data[tpi-current-state]').forEach(div => {
            div.removeAttribute('tpi-current-state');
        });
        
        document.querySelectorAll('td.tpi-cc--table-tbody-item[tpi-current-state]').forEach(td => {
            td.removeAttribute('tpi-current-state');
        });
        
        if (nextState) {
            targetDiv.setAttribute('tpi-current-state', nextState);
            
            const thIndex = Array.from(headerItem.parentElement.children).indexOf(headerItem);
            
            const tableBodyRows = table.querySelectorAll('tbody tr');
            
            tableBodyRows.forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('td.tpi-cc--table-tbody-item');
                if (cells.length > thIndex) {
                    const cell = cells[thIndex];
                    
                    if (rowIndex === tableBodyRows.length - 1) {
                        cell.setAttribute('tpi-current-state', 'filtered-last');
                    } else {
                        cell.setAttribute('tpi-current-state', 'filtered');
                    }
                }
            });
        }
    });
}

function toggle_ActionProcessContainer(state){
    const actionProcessContainer = document.querySelector('.tpi-cc-process-manager-wrapper');
    
    if (!actionProcessContainer) {
        console.error('–≠–ª–µ–º–µ–Ω—Ç .tpi-cc-process-manager-wrapper –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    const actionAttributeState = actionProcessContainer.getAttribute('tpi-current-state');
    
    if (state === "show" && actionAttributeState === 'hidden') {
        actionProcessContainer.style.display = 'flex';
        setTimeout(() => {
            actionProcessContainer.setAttribute('tpi-current-state', 'shown');
        }, 2);
    } else if (state === "hide" && actionAttributeState === 'shown') {
        actionProcessContainer.setAttribute('tpi-current-state', 'hidden');
        setTimeout(() => {
            actionProcessContainer.style.display = 'none';
        }, 400);
    }
}

function update_ActionProcessContainer(){
    const tpi_cc_selected_carts = document.querySelector('div.tpi-cc-process-data-item:has(p.tpi-cc-process-data-item-text.tpi-cc-data-cart-amount)');
    const tpi_cc_selected_pallets = document.querySelector('div.tpi-cc-process-data-item:has(p.tpi-cc-process-data-item-text.tpi-cc-data-pallet-amount)');
    const tpi_cc_selected_data_carts = document.querySelector('p.tpi-cc-process-data-item-text.tpi-cc-data-cart-amount span');
    const tpi_cc_selected_data_pallets = document.querySelector('p.tpi-cc-process-data-item-text.tpi-cc-data-pallet-amount span');

    const tpi_cc_actionButtons = document.querySelectorAll('.tpi-cc-table-tbody-data-cart-id, .tpi-cc-table-tbody-data-pallet-id');
    
    let hasSelected = false;
    let tpi_cc_cart_amount = document.querySelectorAll('.tpi-cc-table-tbody-data-cart-id[tpi-cc-selected-courier-cell]');
    let tpi_cc_pallet_amount = document.querySelectorAll('.tpi-cc-table-tbody-data-pallet-id[tpi-cc-selected-courier-cell]');
    
    if (tpi_cc_selected_data_carts) {
        tpi_cc_selected_data_carts.innerText = tpi_cc_cart_amount.length;
        
        if (tpi_cc_cart_amount.length > 0) {
            tpi_cc_selected_data_carts.style.color = '#fc0';
            tpi_cc_selected_carts.style.height = '.8rem'
            tpi_cc_selected_carts.style.opacity = '1'
        } else {
            tpi_cc_selected_data_carts.style.color = '';
            tpi_cc_selected_carts.style.height = '0rem'
            tpi_cc_selected_carts.style.opacity = '0'
        }
    }
    
    if (tpi_cc_selected_data_pallets) {
        tpi_cc_selected_data_pallets.innerText = tpi_cc_pallet_amount.length;
        
        if (tpi_cc_pallet_amount.length > 0) {
            tpi_cc_selected_data_pallets.style.color = '#fc0';
            tpi_cc_selected_pallets.style.height = '.8rem'
            tpi_cc_selected_pallets.style.opacity = '1'
        } else {
            tpi_cc_selected_data_pallets.style.color = '';
            tpi_cc_selected_pallets.style.height = '0rem'
            tpi_cc_selected_pallets.style.opacity = '0'
        }
    }
    
    tpi_cc_actionButtons.forEach(button => {
        if (button.hasAttribute('tpi-cc-selected-courier-cell')) {
            hasSelected = true;
        }
    });
    
    if (hasSelected) {
        toggle_ActionProcessContainer("show");
    } else {
        toggle_ActionProcessContainer("hide");
    }
}

// B-
// B-
// B-   CALENDAR
// B-
// B-
function initializeDatePicker() {
    const searchDateButton = document.querySelector('.tpi-cc-search-date');
    const selectedDateElement = document.getElementById('tpi-cc-seleceted-date');
    
    if (!searchDateButton) return;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const today = new Date();
    const formattedToday = formatDateToDDMMYYYY(today);
    selectedDateElement.textContent = formattedToday;
    searchDateButton.setAttribute('tpi-cc-selected-date-value', formattedToday);
    
    // –°–æ–∑–¥–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    const calendarContainer = document.createElement('div');
    calendarContainer.className = 'tpi-cc-calendar-container';
    calendarContainer.style.display = 'none';
    
    searchDateButton.parentNode.appendChild(calendarContainer);
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
    let selectedDate = new Date(today);
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    function openCalendar() {
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å —Ç–µ–∫—É—â–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–æ–π
        createCalendar(calendarContainer, new Date(), selectedDate);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        calendarContainer.style.display = 'block';
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        closeAllDropdowns();
        
        // –ñ–¥–µ–º 1–º—Å –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
            calendarContainer.setAttribute('tpi-current-animation', 'shown');
            searchDateButton.setAttribute('tpi-current-state', 'active');
        }, 1);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        const calendarOpenedEvent = new CustomEvent('tpi-calendar-opened');
        document.dispatchEvent(calendarOpenedEvent);
    }
    
    // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
    function closeAllDropdowns() {
        document.querySelectorAll('.tpi-cc-dropdown-container').forEach(dropdown => {
            if (dropdown.style.display === 'block') {
                dropdown.removeAttribute('tpi-current-animation');
                setTimeout(() => {
                    dropdown.style.display = 'none';
                    const button = dropdown.parentNode.querySelector('.tpi-cc-search-dropdown');
                    if (button) {
                        button.removeAttribute('tpi-current-state');
                    }
                }, 200);
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    function closeCalendar() {
        if (calendarContainer.style.display === 'none') return;
        
        calendarContainer.removeAttribute('tpi-current-animation');
        searchDateButton.removeAttribute('tpi-current-state')
        
        // –ß–µ—Ä–µ–∑ 200–º—Å —Å–∫—Ä—ã–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç
        setTimeout(() => {
            calendarContainer.style.display = 'none';
        }, 200);
    }
    
    // –°–æ–∑–¥–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –ø–µ—Ä–µ–¥–∞—á–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
    createCalendar(calendarContainer, today, selectedDate);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É
    searchDateButton.addEventListener('click', function(event) {
        event.stopPropagation();
        
        const isVisible = calendarContainer.style.display === 'block';
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–∏
        document.querySelectorAll('.tpi-cc-calendar-container').forEach(cal => {
            if (cal !== calendarContainer) {
                closeCalendarElement(cal);
            }
        });
        
        if (!isVisible) {
            openCalendar();
        } else {
            closeCalendar();
        }
    });
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(event) {
        if (!calendarContainer.contains(event.target) && 
            !searchDateButton.contains(event.target) &&
            calendarContainer.style.display === 'block') {
            closeCalendar();
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –¥—Ä—É–≥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    function closeCalendarElement(element) {
        if (element.style.display === 'none') return;
        
        element.removeAttribute('tpi-current-animation');
        searchDateButton.removeAttribute('tpi-current-state')
        
        setTimeout(() => {
            element.style.display = 'none';
        }, 200);
    }
    
    // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã
    document.addEventListener('tpi-date-changed', function(event) {
        if (event.detail && event.detail.date) {
            selectedDate = new Date(event.detail.date);
            const formattedDate = formatDateToDDMMYYYY(selectedDate);
            selectedDateElement.textContent = formattedDate;
            searchDateButton.setAttribute('tpi-cc-selected-date-value', formattedDate);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
function createCalendar(container, currentDisplayDate, currentSelectedDate) {
    let currentMonth = currentDisplayDate.getMonth();
    let currentYear = currentDisplayDate.getFullYear();
    
    function renderCalendar() {
        container.innerHTML = '';
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        const header = document.createElement('div');
        header.className = 'tpi-cc-calendar-header';
        
        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const prevButton = document.createElement('button');
        prevButton.innerHTML = tpi_cc_i_chevron_left;
        prevButton.className = 'tpi-cc-calendar-nav';
        prevButton.addEventListener('click', (e) => {
            e.stopPropagation();
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞
        const monthYear = document.createElement('div');
        monthYear.className = 'tpi-cc-calendar-month-year';
        monthYear.textContent = getMonthName(currentMonth) + ' ' + currentYear;
        
        // –ö–Ω–æ–ø–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const nextButton = document.createElement('button');
        nextButton.innerHTML = tpi_cc_i_chevron_right;
        nextButton.className = 'tpi-cc-calendar-nav';
        nextButton.addEventListener('click', (e) => {
            e.stopPropagation();
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });
        
        header.appendChild(prevButton);
        header.appendChild(monthYear);
        header.appendChild(nextButton);
        container.appendChild(header);
        
        // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
        const daysOfWeek = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        const weekDaysRow = document.createElement('div');
        weekDaysRow.className = 'tpi-cc-calendar-weekdays';
        
        daysOfWeek.forEach(day => {
            const dayElement = document.createElement('div');
            dayElement.textContent = day;
            dayElement.className = 'tpi-cc-calendar-weekday';
            weekDaysRow.appendChild(dayElement);
        });
        
        container.appendChild(weekDaysRow);
        
        // –î–Ω–∏ –º–µ—Å—è—Ü–∞
        const daysGrid = document.createElement('div');
        daysGrid.className = 'tpi-cc-calendar-days';
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        const firstDayIndex = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
        
        // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –ø–µ—Ä–≤—ã—Ö –¥–Ω–µ–π
        for (let i = 0; i < firstDayIndex; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'tpi-cc-calendar-day empty';
            daysGrid.appendChild(emptyCell);
        }
        
        // –î–Ω–∏ –º–µ—Å—è—Ü–∞
        const today = new Date();
        const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;
        const isSelectedMonth = currentSelectedDate.getMonth() === currentMonth && 
                               currentSelectedDate.getFullYear() === currentYear;
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.textContent = day;
            dayElement.className = 'tpi-cc-calendar-day';
            
            const cellDate = new Date(currentYear, currentMonth, day);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç –¥–µ–Ω—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º
            const isToday = isCurrentMonth && day === today.getDate();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç –¥–µ–Ω—å –≤—ã–±—Ä–∞–Ω–Ω—ã–º
            const isSelected = isSelectedMonth && day === currentSelectedDate.getDate();
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å (–µ—Å–ª–∏ –æ–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω)
            if (isToday && !isSelected) {
                dayElement.classList.add('today');
            }
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å (–≤–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π, –µ—Å–ª–∏ –æ–Ω –≤—ã–±—Ä–∞–Ω)
            if (isSelected) {
                dayElement.classList.add('selected');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
            dayElement.addEventListener('click', (e) => {
                e.stopPropagation();
                const newSelectedDate = new Date(currentYear, currentMonth, day);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
                window.tpiSelectedDate = newSelectedDate;
                
                const formattedDate = formatDateToDDMMYYYY(newSelectedDate);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
                const selectedDateElement = document.getElementById('tpi-cc-seleceted-date');
                const searchDateButton = document.querySelector('.tpi-cc-search-date');
                
                selectedDateElement.textContent = formattedDate;
                searchDateButton.setAttribute('tpi-cc-selected-date-value', formattedDate);
                
                // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –Ω–æ–≤–æ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–æ–π
                createCalendar(container, new Date(currentYear, currentMonth, 1), newSelectedDate);
                
                // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã
                const dateChangeEvent = new CustomEvent('tpi-date-changed', {
                    detail: { 
                        date: newSelectedDate, 
                        formattedDate: formattedDate 
                    }
                });
                document.dispatchEvent(dateChangeEvent);
            });
            
            daysGrid.appendChild(dayElement);
        }
        
        container.appendChild(daysGrid);
    }
    
    renderCalendar();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function formatDateToDDMMYYYY(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

function getMonthName(monthIndex) {
    const months = [
        '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
        '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
    ];
    return months[monthIndex];
}

// B- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
// B- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
function createDropdownCheckboxFilter(dropdownButton, options, config = {}) {
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const defaultConfig = {
        placeholder: '–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è',
        selectAllText: '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ',
        nothingFoundText: '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
        showCountInInput: true,
        multiple: true,
        allowFiltering: true,
        closeOnSelect: false // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
    };
    
    const cfg = { ...defaultConfig, ...config };
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
    if (!dropdownButton || !(dropdownButton instanceof HTMLElement)) {
        console.error('Dropdown button element is required');
        return null;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º options
    if (!Array.isArray(options) || options.length === 0) {
        console.error('Options array is required');
        return null;
    }
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    const dropdownContainer = document.createElement('div');
    dropdownContainer.className = 'tpi-cc-dropdown-container';
    dropdownContainer.style.display = 'none';
    
    // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π .tpi-cc-filters-item –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    const filterItem = dropdownButton.closest('.tpi-cc-filters-item');
    if (!filterItem) {
        console.error('Could not find parent filter item');
        return null;
    }
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞
    filterItem.appendChild(dropdownContainer);
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    let selectedOptions = [];
    let allOptions = [...options];
    let isOpen = false;
    let filteredOptions = [...allOptions];
    let searchTerm = '';
    let lastFocusTime = 0;
    let focusTimeout = null;
    let isFirstOpen = true; // –§–ª–∞–≥ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ multiple = true
    if (cfg.multiple) {
        selectedOptions = [...options];
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤–≤–æ–¥–∞
    const input = dropdownButton.querySelector('input');
    if (!input) {
        console.error('Input element not found inside dropdown button');
        return null;
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
    const originalText = input.value || cfg.placeholder;
    input.setAttribute('data-original-value', originalText);
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    function renderDropdown() {
        dropdownContainer.innerHTML = '';
        
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ–ø—Ü–∏–π
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'tpi-cc-dropdown-options';
        
        // –î–æ–±–∞–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" —Ç–æ–ª—å–∫–æ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∏ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏
        if (cfg.multiple && filteredOptions.length > 0) {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–ø—Ü–∏–π
            const filteredSelected = selectedOptions.filter(opt => 
                filteredOptions.some(fopt => fopt.value === opt.value)
            ).length;
            const allFilteredSelected = filteredSelected === filteredOptions.length;
            
            const selectAllItem = createSelectAllItem(allFilteredSelected);
            optionsContainer.appendChild(selectAllItem);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
            const separator = document.createElement('div');
            separator.className = 'tpi-cc-dropdown-separator';
            optionsContainer.appendChild(separator);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        if (filteredOptions.length === 0) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
            const nothingFoundEl = document.createElement('div');
            nothingFoundEl.className = 'tpi-cc-dropdown-nothing';
            nothingFoundEl.textContent = cfg.nothingFoundText;
            optionsContainer.appendChild(nothingFoundEl);
        } else {
            // –°–æ–∑–¥–∞–µ–º –æ–±–µ—Ä—Ç–∫—É –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const otherItemsWrapper = document.createElement('div');
            otherItemsWrapper.className = 'tpi-cc-dropdown-item-wrapper';
            
            filteredOptions.forEach(option => {
                const isSelected = selectedOptions.some(
                    selected => selected.value === option.value
                );
                
                const optionItem = createOptionItem(option, isSelected);
                otherItemsWrapper.appendChild(optionItem);
            });
            
            optionsContainer.appendChild(otherItemsWrapper);
        }
        
        dropdownContainer.appendChild(optionsContainer);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤
        updateDropdownCounts(dropdownContainer);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
    function createSelectAllItem(isChecked) {
        const item = document.createElement('div');
        item.className = 'tpi-cc-dropdown-item';
        item.setAttribute('data-value', 'select-all');
        item.setAttribute('data-type', 'select-all');
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `tpi-cc-dropdown-select-all-${Date.now()}`;
        checkbox.checked = isChecked;
        
        const checkboxCustom = document.createElement('div');
        checkboxCustom.className = 'tpi-cc-dropdown-checkbox-custom';
        
        const labelEl = document.createElement('div');
        labelEl.className = 'tpi-cc-dropdown-label';
        
        // –î–ª—è "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–∑–º–µ—Ç–∫–∏
        const labelName = document.createElement('span');
        labelName.className = 'tpi-cc-dropdown-label-name';
        labelName.textContent = '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
        
        labelEl.appendChild(labelName);
        
        item.appendChild(checkbox);
        item.appendChild(checkboxCustom);
        item.appendChild(labelEl);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
        item.addEventListener('click', (e) => {
            e.stopPropagation();
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox) {
                if (checkbox.checked) {
                    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –í–°–ï–• –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–ø—Ü–∏–π
                    filteredOptions.forEach(option => {
                        selectedOptions = selectedOptions.filter(
                            selected => selected.value !== option.value
                        );
                    });
                } else {
                    // –í—ã–±–∏—Ä–∞–µ–º –í–°–ï –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏
                    filteredOptions.forEach(option => {
                        if (!selectedOptions.some(selected => selected.value === option.value)) {
                            selectedOptions.push(option);
                        }
                    });
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤
                updateCheckboxStates();
            }
        });
        
        return item;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –æ–ø—Ü–∏–∏
    function createOptionItem(option, isSelected) {
        const item = document.createElement('div');
        item.className = 'tpi-cc-dropdown-item';
        item.setAttribute('data-value', option.value);
        item.setAttribute('data-type', 'option');
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `tpi-cc-dropdown-${option.value}-${Date.now()}`;
        checkbox.checked = isSelected;
        
        const checkboxCustom = document.createElement('div');
        checkboxCustom.className = 'tpi-cc-dropdown-checkbox-custom';
        
        const labelEl = document.createElement('div');
        labelEl.className = 'tpi-cc-dropdown-label';
        
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –æ–ø—Ü–∏–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        const labelName = document.createElement('p');
        labelName.className = 'tpi-cc-dropdown-label-name';
        labelName.textContent = option.label;
        
        const labelAmount = document.createElement('span');
        labelAmount.className = 'tpi-cc-dropdown-label-amount';
        labelAmount.textContent = '0'; // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        
        labelEl.appendChild(labelName);
        labelEl.appendChild(labelAmount);
        
        item.appendChild(checkbox);
        item.appendChild(checkboxCustom);
        item.appendChild(labelEl);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
        item.addEventListener('click', (e) => {
            e.stopPropagation();
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox) {
                toggleOption(option, !checkbox.checked); // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º, —Ç–∞–∫ –∫–∞–∫ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—â–µ –Ω–µ –æ–±–Ω–æ–≤–∏–ª–æ—Å—å
            }
        });
        
        return item;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–ø—Ü–∏–∏
    function toggleOption(option, shouldSelect) {
        if (shouldSelect) {
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é
            if (cfg.multiple) {
                if (!selectedOptions.some(selected => selected.value === option.value)) {
                    selectedOptions.push(option);
                }
            } else {
                // –î–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ - —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –æ–ø—Ü–∏—è
                selectedOptions = [option];
            }
        } else {
            // –£–¥–∞–ª—è–µ–º –æ–ø—Ü–∏—é
            selectedOptions = selectedOptions.filter(
                selected => selected.value !== option.value
            );
        }
        
        updateCheckboxStates();
        
        if (cfg.closeOnSelect && !cfg.multiple) {
            closeDropdown();
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤
    function updateCheckboxStates() {
        if (!isOpen) return;
        
        const optionsContainer = dropdownContainer.querySelector('.tpi-cc-dropdown-options');
        if (!optionsContainer) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        const selectAllItem = optionsContainer.querySelector('.tpi-cc-dropdown-item[data-type="select-all"]');
        if (selectAllItem) {
            const selectAllCheckbox = selectAllItem.querySelector('input[type="checkbox"]');
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ
            const filteredSelected = selectedOptions.filter(opt => 
                filteredOptions.some(fopt => fopt.value === opt.value)
            ).length;
            const allFilteredSelected = filteredSelected === filteredOptions.length && filteredOptions.length > 0;
            selectAllCheckbox.checked = allFilteredSelected;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏–∏
        const optionItems = optionsContainer.querySelectorAll('.tpi-cc-dropdown-item[data-type="option"]');
        optionItems.forEach(item => {
            const value = item.getAttribute('data-value');
            const checkbox = item.querySelector('input[type="checkbox"]');
            if (checkbox) {
                const isSelected = selectedOptions.some(
                    option => option.value === value
                );
                checkbox.checked = isSelected;
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –∏–Ω–ø—É—Ç–µ
    function updateInputText() {
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –æ–ø—Ü–∏–∏ (–∫—Ä–æ–º–µ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ")
        const activeOptionsCount = selectedOptions.length;
        
        // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
        if (activeOptionsCount === 0) {
            input.value = cfg.placeholder;
            input.setAttribute('data-original-value', cfg.placeholder);
        } 
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏
        else if (cfg.multiple && activeOptionsCount === allOptions.length) {
            input.value = '–í—ã–±—Ä–∞–Ω—ã –≤—Å–µ';
            input.setAttribute('data-original-value', '–í—ã–±—Ä–∞–Ω—ã –≤—Å–µ');
        } 
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ
        else if (cfg.multiple && cfg.showCountInInput) {
            input.value = `–í—ã–±—Ä–∞–Ω–æ: ${activeOptionsCount}`;
            input.setAttribute('data-original-value', `–í—ã–±—Ä–∞–Ω–æ: ${activeOptionsCount}`);
        } 
        // –ï—Å–ª–∏ –æ–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã–±–æ—Ä
        else if (!cfg.multiple && activeOptionsCount > 0) {
            input.value = selectedOptions[0].label;
            input.setAttribute('data-original-value', selectedOptions[0].label);
        } 
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
        else {
            const labels = selectedOptions.map(opt => opt.label).join(', ');
            input.value = labels;
            input.setAttribute('data-original-value', labels);
        }
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        const changeEvent = new CustomEvent('tpi-dropdown-change', {
            detail: {
                selected: selectedOptions,
                allSelected: cfg.multiple && activeOptionsCount === allOptions.length
            }
        });
        dropdownButton.dispatchEvent(changeEvent);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ–ø—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ –≤ –∏–Ω–ø—É—Ç–µ
    function filterOptions() {
        const searchText = input.value.toLowerCase().trim();
        searchTerm = searchText;
        
        if (searchText === '') {
            filteredOptions = [...allOptions];
        } else {
            filteredOptions = allOptions.filter(option =>
                option.label.toLowerCase().includes(searchText)
            );
        }
        
        if (isOpen) {
            renderDropdown();
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ–∫—É—Å–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    function handleFocusWithDelay() {
        const now = Date.now();
        const timeSinceLastFocus = now - lastFocusTime;
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
        if (focusTimeout) {
            clearTimeout(focusTimeout);
            focusTimeout = null;
        }
        
        // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 250ms —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ñ–æ–∫—É—Å–∞
        if (timeSinceLastFocus < 250 && lastFocusTime > 0) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
            immediateOpenDropdown();
        } else {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
            focusTimeout = setTimeout(() => {
                if (!isOpen) {
                    openDropdown();
                }
                focusTimeout = null;
            }, 50);
        }
        
        lastFocusTime = now;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è (–±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è)
    function immediateOpenDropdown() {
        if (isOpen) return;
        
        // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–µ—Ä –∑–∞–∫—Ä—ã—Ç–∏—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (dropdownContainer._closeTimeout) {
            clearTimeout(dropdownContainer._closeTimeout);
            dropdownContainer._closeTimeout = null;
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        dropdownContainer.removeAttribute('tpi-current-animation');
        dropdownButton.removeAttribute('tpi-current-state');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
        closeAllOtherDropdowns(dropdownContainer);
        // –¢–∞–∫–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–∏
        closeAllCalendars();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        searchTerm = '';
        filteredOptions = [...allOptions];
        
        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        dropdownContainer.style.display = 'block';
        
        // –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–µ—Ä–µ–¥ –∞–Ω–∏–º–∞—Ü–∏–µ–π
        if (isFirstOpen) {
            isFirstOpen = false;
            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            renderDropdown();
            
            // –ñ–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ—Ä–µ–π–º–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ DOM
            requestAnimationFrame(() => {
                // –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –≤—Ä–µ–º—è –Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫—É
                requestAnimationFrame(() => {
                    dropdownContainer.setAttribute('tpi-current-animation', 'shown');
                    dropdownButton.setAttribute('tpi-current-state', 'active');
                });
            });
        } else {
            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            renderDropdown();
            
            // –ñ–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ—Ä–µ–π–º–∞ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
            requestAnimationFrame(() => {
                dropdownContainer.setAttribute('tpi-current-animation', 'shown');
                dropdownButton.setAttribute('tpi-current-state', 'active');
            });
        }
        
        isOpen = true;
        
        // –û—á–∏—â–∞–µ–º –∏–Ω–ø—É—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ placeholder
        if (input.value === cfg.placeholder || 
            input.value === '–í—ã–±—Ä–∞–Ω—ã –≤—Å–µ' || 
            input.value.startsWith('–í—ã–±—Ä–∞–Ω–æ: ')) {
            input.value = '';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    function openDropdown() {
        if (isOpen) return;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–¥–µ—Ç –ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è
        if (dropdownContainer._closeTimeout) {
            // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–µ—Ä –∑–∞–∫—Ä—ã—Ç–∏—è
            clearTimeout(dropdownContainer._closeTimeout);
            dropdownContainer._closeTimeout = null;
            dropdownContainer.removeAttribute('tpi-current-animation');
            dropdownButton.removeAttribute('tpi-current-state');
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
        closeAllOtherDropdowns(dropdownContainer);
        // –¢–∞–∫–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–∏
        closeAllCalendars();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        searchTerm = '';
        filteredOptions = [...allOptions];
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        dropdownContainer.style.display = 'block';
        
        // –î–ª—è –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
        if (isFirstOpen) {
            isFirstOpen = false;
            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            renderDropdown();
            
            // –ñ–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ—Ä–µ–π–º–∞ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
            requestAnimationFrame(() => {
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ—Ä–µ–π–º –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
                requestAnimationFrame(() => {
                    dropdownContainer.setAttribute('tpi-current-animation', 'shown');
                    dropdownButton.setAttribute('tpi-current-state', 'active');
                });
            });
        } else {
            // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            renderDropdown();
            
            // –ñ–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ—Ä–µ–π–º–∞ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
            requestAnimationFrame(() => {
                dropdownContainer.setAttribute('tpi-current-animation', 'shown');
                dropdownButton.setAttribute('tpi-current-state', 'active');
            });
        }
        
        isOpen = true;
        
        // –û—á–∏—â–∞–µ–º –∏–Ω–ø—É—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ placeholder
        if (input.value === cfg.placeholder || 
            input.value === '–í—ã–±—Ä–∞–Ω—ã –≤—Å–µ' || 
            input.value.startsWith('–í—ã–±—Ä–∞–Ω–æ: ')) {
            input.value = '';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ñ–æ–∫—É—Å–∞
    function closeDropdown() {
        if (!isOpen) return;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∏–Ω–ø—É—Ç –≤ —Ñ–æ–∫—É—Å–µ
        const isInputFocused = document.activeElement === input;
        
        if (isInputFocused) {
            // –ï—Å–ª–∏ –∏–Ω–ø—É—Ç –≤ —Ñ–æ–∫—É—Å–µ, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
            // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞
            dropdownContainer.removeAttribute('tpi-current-animation');
            dropdownButton.removeAttribute('tpi-current-state');
            
            // –ß–µ—Ä–µ–∑ 10ms —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            setTimeout(() => {
                if (isOpen && document.activeElement === input) {
                    dropdownContainer.setAttribute('tpi-current-animation', 'shown');
                    dropdownButton.setAttribute('tpi-current-state', 'active');
                }
            }, 10);
            
            return; // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        }
        
        // –ï—Å–ª–∏ –∏–Ω–ø—É—Ç –Ω–µ –≤ —Ñ–æ–∫—É—Å–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –∑–∞–∫—Ä—ã—Ç–∏–µ–º
        dropdownContainer.removeAttribute('tpi-current-animation');
        dropdownButton.removeAttribute('tpi-current-state');
        
        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –∏–Ω–ø—É—Ç–µ
        updateInputText();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω—ã
        dropdownContainer._closeTimeout = setTimeout(() => {
            // –ü–µ—Ä–µ–¥ —Å–∫—Ä—ã—Ç–∏–µ–º –µ—â–µ —Ä–∞–∑ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ–∫—É—Å
            const isStillFocused = document.activeElement === input;
            if (isStillFocused) {
                // –ï—Å–ª–∏ –∏–Ω–ø—É—Ç —Å–Ω–æ–≤–∞ –≤ —Ñ–æ–∫—É—Å–µ, –Ω–µ —Å–∫—Ä—ã–≤–∞–µ–º
                dropdownContainer.setAttribute('tpi-current-animation', 'shown');
                dropdownButton.setAttribute('tpi-current-state', 'active');
                dropdownContainer._closeTimeout = null;
                return;
            }
            
            dropdownContainer.style.display = 'none';
            isOpen = false;
            dropdownContainer._closeTimeout = null;
        }, 200);
        
        // –û—á–∏—â–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        searchTerm = '';
        filteredOptions = [...allOptions];
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    function forceCloseDropdown() {
        if (!isOpen) return;
        
        // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–µ—Ä –∑–∞–∫—Ä—ã—Ç–∏—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (dropdownContainer._closeTimeout) {
            clearTimeout(dropdownContainer._closeTimeout);
            dropdownContainer._closeTimeout = null;
        }
        
        dropdownContainer.removeAttribute('tpi-current-animation');
        dropdownButton.removeAttribute('tpi-current-state');
        
        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –∏–Ω–ø—É—Ç–µ
        updateInputText();
        
        // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ–∫—É—Å)
        dropdownContainer.style.display = 'none';
        isOpen = false;
        
        // –û—á–∏—â–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
        searchTerm = '';
        filteredOptions = [...allOptions];
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –¥—Ä—É–≥–∏—Ö –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
    function closeAllOtherDropdowns(currentDropdown) {
        document.querySelectorAll('.tpi-cc-dropdown-container').forEach(dropdown => {
            if (dropdown !== currentDropdown && dropdown.style.display === 'block') {
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º
                dropdown.removeAttribute('tpi-current-animation');
                const button = dropdown.parentNode.querySelector('.tpi-cc-search-dropdown');
                if (button) {
                    button.removeAttribute('tpi-current-state');
                }
                dropdown.style.display = 'none';
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
    function closeAllCalendars() {
        document.querySelectorAll('.tpi-cc-calendar-container').forEach(calendar => {
            if (calendar.style.display === 'block') {
                calendar.removeAttribute('tpi-current-animation');
                const searchDateButton = document.querySelector('.tpi-cc-search-date');
                if (searchDateButton) {
                    searchDateButton.removeAttribute('tpi-current-state');
                }
                calendar.style.display = 'none';
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    
    // –§–æ–∫—É—Å –Ω–∞ –∏–Ω–ø—É—Ç–µ —Å —É–º–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
    input.addEventListener('focus', function() {
        handleFocusWithDelay();
    });
    
    // –ö–ª–∏–∫ –ø–æ –∏–Ω–ø—É—Ç—É
    input.addEventListener('click', function(event) {
        event.stopPropagation();
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è
        if (!isOpen) {
            immediateOpenDropdown();
        }
    });
    
    // –ü–æ—Ç–µ—Ä—è —Ñ–æ–∫—É—Å–∞ –∏–Ω–ø—É—Ç–æ–º - –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    input.addEventListener('blur', function() {
        // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç —Ñ–æ–∫—É—Å–∞
        if (focusTimeout) {
            clearTimeout(focusTimeout);
            focusTimeout = null;
        }
        
        // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–ª–∏–∫–∞ –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        setTimeout(() => {
            const activeElement = document.activeElement;
            const isClickInside = dropdownContainer.contains(activeElement) || 
                                 dropdownButton.contains(activeElement);
            
            // –ï—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –≤–Ω–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –∏ –∫–Ω–æ–ø–∫–∏, –∑–∞–∫—Ä—ã–≤–∞–µ–º
            if (!isClickInside) {
                closeDropdown();
            }
        }, 100);
    });
    
    // –í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    if (cfg.allowFiltering) {
        input.addEventListener('input', function() {
            filterOptions();
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É (–∏–∫–æ–Ω–∫–∞)
    const icon = dropdownButton.querySelector('.tpi-cc-search-icon');
    if (icon) {
        icon.addEventListener('click', function(event) {
            event.stopPropagation();
            if (!isOpen) {
                immediateOpenDropdown();
            } else {
                closeDropdown();
            }
        });
    }
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–æ–±—ã—Ç–∏–µ mousedown –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    dropdownContainer.addEventListener('mousedown', function(event) {
        event.preventDefault();
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ input
        if (document.activeElement !== input) {
            input.focus();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –≤–µ—Å—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    dropdownContainer.addEventListener('click', function(event) {
        event.stopPropagation();
    });
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(event) {
        const target = event.target;
        const isClickInsideDropdown = dropdownContainer.contains(target) || 
                                      dropdownButton.contains(target);
        
        if (!isClickInsideDropdown && isOpen) {
            closeDropdown();
        }
    });
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    document.addEventListener('tpi-calendar-opened', function() {
        if (isOpen) {
            forceCloseDropdown();
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –∏–Ω–ø—É—Ç–µ
    updateInputText();
    

    const dropdownInstance = {
        getSelectedOptions: () => [...selectedOptions],
        setSelectedOptions: (options) => {
            selectedOptions = [...options];
            updateCheckboxStates();
            updateInputText();
        },
        getAllOptions: () => [...allOptions],
        setOptions: (newOptions) => {
            allOptions = [...newOptions];
            selectedOptions = selectedOptions.filter(selected => 
                newOptions.some(option => option.value === selected.value)
            );
            filteredOptions = [...allOptions];
            if (isOpen) {
                renderDropdown();
            }
            updateInputText();
        },
        open: () => immediateOpenDropdown(),
        close: () => closeDropdown(),
        isOpen: () => isOpen,
        updateInputText: () => updateInputText()
    };

    dropdownButton.tpiDropdownInstance = dropdownInstance;
    
    return dropdownInstance;
}
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∫—É—Ä—å–µ—Ä–∞
function initializeCourierStatusDropdown() {
    const statusDropdownButton = document.querySelector('.tpi-cc-search-dropdown');
    
    if (!statusDropdownButton) {
        console.warn('Status dropdown button not found');
        return null;
    }
    
    // –û–ø—Ü–∏–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∫—É—Ä—å–µ—Ä–∞
    const statusOptions = [
        { value: 'finished', label: '–°–æ–±—Ä–∞–Ω' },
        { value: 'in_progress', label: '–í —Ä–∞–±–æ—Ç–µ' },
        { value: 'not_started', label: '–ù–µ –Ω–∞—á–∞—Ç' },
        { value: 'shipped', label: '–û—Ç–≥—Ä—É–∂–µ–Ω' },
        { value: 'cell_shipped', label: '–ü–µ—Ä–µ–¥–∞–Ω–æ –∫—É—Ä—å–µ—Ä—É' }
    ];
    
    // –°–æ–∑–¥–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
    const statusDropdown = createDropdownCheckboxFilter(statusDropdownButton, statusOptions, {
        placeholder: '',
        selectAllText: '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ',
        nothingFoundText: '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
        searchPlaceholder: '–ü–æ–∏—Å–∫ —Å—Ç–∞—Ç—É—Å–∞...',
        showCountInInput: true,
        multiple: true
    });
    
    return statusDropdown;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ
function countStatusInTable() {
    const tableBody = document.querySelector('tbody.tpi-cc--table-tbody-wrapper');
    if (!tableBody) {
        return null; // –¢–∞–±–ª–∏—Ü–∞ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞
    }
    
    const rows = tableBody.querySelectorAll('tr.tpi-cc--table-tbody');
    if (rows.length === 0) {
        return null; // –ù–µ—Ç —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
    }
    
    const statusCounts = {};
    
    rows.forEach(row => {
        const statusElement = row.querySelector('p[tpi-cc-parsing-data="courier-route-status"]');
        if (statusElement) {
            const statusText = statusElement.textContent.trim();
            statusCounts[statusText] = (statusCounts[statusText] || 0) + 1;
        }
    });
    
    return statusCounts;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
function updateDropdownCounts(dropdownContainer) {
    const statusCounts = countStatusInTable();
    if (!statusCounts) return;
    
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –æ–ø—Ü–∏–π –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
    const optionItems = dropdownContainer.querySelectorAll('.tpi-cc-dropdown-item[data-type="option"]');
    
    optionItems.forEach(item => {
        const labelName = item.querySelector('.tpi-cc-dropdown-label-name');
        if (labelName) {
            const optionText = labelName.textContent.trim();
            const count = statusCounts[optionText] || 0;
            
            const labelAmount = item.querySelector('.tpi-cc-dropdown-label-amount');
            if (labelAmount) {
                labelAmount.textContent = count > 0 ? count.toString() : '0';
            }
        }
    });
}

// C-
// C-
// C- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¢–ê–ë–õ–ò–¶–´
// C-
// C-

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ —Å—Ç—Ä–æ–∫
let tpi_cc_originalRowOrder = [];
let tpi_cc_currentFilterColumn = null;
let tpi_cc_currentFilterDirection = null;

// –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å—Ç—Ä–æ–∫ —Å –∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
function saveOriginalRowOrder() {
    const tableBody = document.querySelector('.tpi-cc--table-tbody-wrapper');
    if (!tableBody || tableBody.children.length === 0) return;
    
    tpi_cc_originalRowOrder = Array.from(tableBody.querySelectorAll('.tpi-cc--table-tbody'));
}

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
function tpi_cc_filteringColumnData() {
    const table = document.querySelector('table.tpi-cc--table-data-output');
    if (!table) {
        tpiNotification.show('–û—à–∏–±–∫–∞', "error", "–ù–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ —Ç–∞–±–ª–∏—Ü—É");
        return;
    }
    
    table.addEventListener('click', (event) => {
        const headerItem = event.target.closest('.tpi-cc--table-thead-item');
        if (!headerItem) return;
        if (headerItem.hasAttribute('tpi-cc-filters-not-allowed')) {
            return;
        }
        
        const targetDiv = headerItem.querySelector('div.tpi-cc--table-thead-data');
        if (!targetDiv) return;
        
        const currentState = targetDiv.getAttribute('tpi-current-state');
        const columnIndex = Array.from(headerItem.parentElement.children).indexOf(headerItem);
        let nextState = null;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–∂–∏–º–∞–µ–º –ª–∏ –º—ã –Ω–∞ —Ç–æ—Ç –∂–µ —Å—Ç–æ–ª–±–µ—Ü
        const isSameColumn = tpi_cc_currentFilterColumn === columnIndex;
        
        if (!currentState) {
            nextState = 'filtered-down';
            tpi_cc_currentFilterDirection = 'down';
        } else if (currentState === 'filtered-down') {
            nextState = 'filtered-up';
            tpi_cc_currentFilterDirection = 'up';
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
        document.querySelectorAll('div.tpi-cc--table-thead-data[tpi-current-state]').forEach(div => {
            div.removeAttribute('tpi-current-state');
        });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        document.querySelectorAll('td.tpi-cc--table-tbody-item[tpi-current-state]').forEach(td => {
            td.removeAttribute('tpi-current-state');
        });
        
        if (nextState) {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä
            targetDiv.setAttribute('tpi-current-state', nextState);
            tpi_cc_currentFilterColumn = columnIndex;
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å—Ç–æ–ª–±—Ü—É
            sortTableByColumnMove(columnIndex, nextState);
            
        } else {
            // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä —Å–Ω—è—Ç
            tpi_cc_currentFilterColumn = null;
            tpi_cc_currentFilterDirection = null;
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
            restoreOriginalRowOrder();
        }
    });
}

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏, –∞ –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç –∏—Ö
function sortTableByColumnMove(columnIndex, sortDirection) {
    const tableBody = document.querySelector('.tpi-cc--table-tbody-wrapper');
    if (!tableBody) return;
    
    // –ï—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
    if (tpi_cc_originalRowOrder.length === 0) {
        saveOriginalRowOrder();
    }
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —Å—Ç—Ä–æ–∫–∏
    const rows = Array.from(tableBody.querySelectorAll('.tpi-cc--table-tbody'))
        .filter(row => row.style.display !== 'none');
    
    if (rows.length === 0) return;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫ —Å–∫—Ä—ã—Ç—ã—Ö —Å—Ç—Ä–æ–∫
    const hiddenRows = Array.from(tableBody.querySelectorAll('.tpi-cc--table-tbody'))
        .filter(row => row.style.display === 'none');
    
    // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤–∏–¥–∏–º—ã—Ö —Å—Ç—Ä–æ–∫ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    const rowData = rows.map((row, index) => {
        const cell = row.querySelectorAll('td.tpi-cc--table-tbody-item')[columnIndex];
        return {
            row: row,
            originalIndex: index,
            value: extractCellValue(cell),
            sortValue: getSortValue(cell, columnIndex)
        };
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
    rowData.sort((a, b) => {
        let comparison = 0;
        
        if (a.sortValue !== null && b.sortValue !== null) {
            comparison = a.sortValue - b.sortValue;
        } else if (typeof a.value === 'string' && typeof b.value === 'string') {
            comparison = a.value.localeCompare(b.value, 'ru', { sensitivity: 'base' });
        }
        
        if (comparison === 0) {
            comparison = a.originalIndex - b.originalIndex;
        }
        
        if (sortDirection === 'filtered-up') {
            comparison = -comparison;
        }
        
        return comparison;
    });
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    const sortedVisibleRows = rowData.map(item => item.row);
    const allRows = [...sortedVisibleRows, ...hiddenRows];
    
    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ –Ω–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ
    moveRowsToNewOrder(allRows);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∫ —è—á–µ–π–∫–∞–º
    addVisualEffectsWithFilter(columnIndex);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
function getSortValue(cell, columnIndex) {
    if (!cell) return null;
    
    // –î–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    const percentElement = cell.querySelector('p[tpi-cc-parsing-data*="progress-percent"]');
    if (percentElement) {
        const percentText = percentElement.textContent.trim().replace('%', '');
        return parseInt(percentText) || 0;
    }
    
    // –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (–ø—Ä–æ–≥—Ä–µ—Å—Å)
    const progressElement = cell.querySelector('p[tpi-cc-parsing-data*="progress"]');
    if (progressElement && !progressElement.textContent.includes('%')) {
        const match = progressElement.textContent.match(/(\d+)\s*–∏–∑\s*(\d+)/);
        if (match) {
            return parseInt(match[1]) || 0;
        }
    }
    
    // –î–ª—è –¥–∞—Ç
    const dateElement = cell.querySelector('p[tpi-cc-parsing-data*="date"]');
    if (dateElement && dateElement.textContent !== 'null') {
        return parseDateString(dateElement.textContent.trim());
    }
    
    // –î–ª—è –≤—Ä–µ–º–µ–Ω–∏
    const timeElement = cell.querySelector('p[tpi-cc-parsing-data*="time"]');
    if (timeElement && timeElement.textContent !== 'null') {
        return parseTimeString(timeElement.textContent.trim());
    }
    
    return null; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
function moveRowsToNewOrder(rowsInNewOrder) {
    const tableBody = document.querySelector('.tpi-cc--table-tbody-wrapper');
    if (!tableBody) return;
    
    // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    tableBody.style.transition = 'none';
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏
    const originalPositions = new Map();
    const rows = Array.from(tableBody.querySelectorAll('.tpi-cc--table-tbody'));
    
    rows.forEach((row, index) => {
        originalPositions.set(row, {
            element: row,
            originalIndex: index,
            rect: row.getBoundingClientRect()
        });
    });
    
    // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    tableBody.innerHTML = '';
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ –Ω–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ
    rowsInNewOrder.forEach(row => {
        tableBody.appendChild(row);
    });
    
    // –í–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ
    setTimeout(() => {
        tableBody.style.transition = '';
    }, 10);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
function restoreOriginalRowOrder() {
    if (tpi_cc_originalRowOrder.length === 0) return;
    
    const tableBody = document.querySelector('.tpi-cc--table-tbody-wrapper');
    if (!tableBody) return;
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤", –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    removeNoResultsMessage();
    
    // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
    tableBody.innerHTML = '';
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
    tpi_cc_originalRowOrder.forEach(row => {
        tableBody.appendChild(row);
    });
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    applyAllFilters();
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    restoreEventListeners();
}

function removeNoResultsMessage() {
    const existingMessage = document.querySelector('tr[tpi-cc-no-filtered-results]');
    if (existingMessage) {
        existingMessage.classList.remove('shown');
        if (existingMessage.parentNode) {
            existingMessage.parentNode.removeChild(existingMessage);
        }
    }
}

function showNoResultsMessage() {
    const tableBody = document.querySelector('.tpi-cc--table-tbody-wrapper');
    if (!tableBody) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–∏ —É–∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    const existingMessage = document.querySelector('tr[tpi-cc-no-filtered-results]');
    if (existingMessage) return; // –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    
    // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    const noResultsRow = document.createElement('tr');
    noResultsRow.setAttribute('tpi-cc-no-filtered-results', '');
    noResultsRow.className = 'tpi-cc-no-results-row';
    
    // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫—É, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏
    const td = document.createElement('td');
    td.colSpan = 11; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–æ–Ω–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
    td.className = 'tpi-cc-no-results-cell';
    td.innerHTML = `
        <div class="tpi-cc-no-results-container">
            <p class="tpi-cc-no-results-title">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</p>
            <i class="tpi-cc-no-results-icon"></i>
        </div>
    `
    
    noResultsRow.appendChild(td);
    tableBody.appendChild(noResultsRow);
    
    // –î–æ–±–∞–≤–ª—è–µ–º CSS –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    setTimeout(() => {
        noResultsRow.classList.add('shown');
    }, 10);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
function addVisualEffects(columnIndex) {
    const table = document.querySelector('table.tpi-cc--table-data-output');
    if (!table) return;
    
    const tableBodyRows = table.querySelectorAll('tbody tr');
    
    tableBodyRows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('td.tpi-cc--table-tbody-item');
        if (cells.length > columnIndex) {
            const cell = cells[columnIndex];
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã
            cell.removeAttribute('tpi-current-state');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            if (rowIndex === tableBodyRows.length - 1) {
                cell.setAttribute('tpi-current-state', 'filtered-last');
            } else {
                cell.setAttribute('tpi-current-state', 'filtered');
            }
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function restoreEventListeners() {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ CART –∏ PALLET
    const tpi_cc_actionButtons = document.querySelectorAll('.tpi-cc-table-tbody-data-cart-id, .tpi-cc-table-tbody-data-pallet-id');
    tpi_cc_actionButtons.forEach(btn => {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        newBtn.addEventListener('click', () => {
            if (newBtn.hasAttribute('tpi-cc-selected-courier-cell')) {
                newBtn.removeAttribute('tpi-cc-selected-courier-cell');
            } else {
                newBtn.setAttribute('tpi-cc-selected-courier-cell', '');
            }
            update_ActionProcessContainer();
        });
    });
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è CART/PALLET
    const addCartButtons = document.querySelectorAll('.tpi-cc--table-tbody-add-cart');
    const addPalletButtons = document.querySelectorAll('.tpi-cc--table-tbody-add-pallet');
    
    addCartButtons.forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è CART
    });
    
    addPalletButtons.forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è PALLET
    });
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–µ—á–∞—Ç–∏
    const printButtons = document.querySelectorAll('.tpi-cc--print-current-row');
    printButtons.forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—á–∞—Ç–∏
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–µ–π—Å—Ç–≤–∏–π
    update_ActionProcessContainer();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —è—á–µ–π–∫–∏
function extractCellValue(cell) {
    if (!cell) return '';
    
    // –î–ª—è —è—á–µ–µ–∫ —Å–æ —Å—Å—ã–ª–∫–∞–º–∏
    const linkElement = cell.querySelector('a.tpi-cc--table-tbody-data-link');
    if (linkElement) {
        return linkElement.textContent.trim();
    }
    
    // –î–ª—è —è—á–µ–µ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ CART/PALLET
    const buttonElements = cell.querySelectorAll('.tpi-cc--table-tbody-data-button');
    if (buttonElements.length > 0) {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–π –∫–Ω–æ–ø–∫–∏ –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
        return buttonElements[0].textContent.trim();
    }
    
    // –î–ª—è —è—á–µ–µ–∫ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    const textElements = cell.querySelectorAll('p[tpi-cc-parsing-data]');
    if (textElements.length > 0) {
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ç–µ–∫—Å—Ç –≤—Å–µ—Ö –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤
        return Array.from(textElements)
            .map(el => el.textContent.trim())
            .filter(text => text)
            .join(' ');
    }
    
    // –î–ª—è —è—á–µ–µ–∫ —Å –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
    if (cell.textContent) {
        return cell.textContent.trim();
    }
    
    return '';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
function parseDateString(dateStr) {
    if (!dateStr || dateStr === 'null') return null;
    
    try {
        // –§–æ—Ä–º–∞—Ç: DD/MM/YYYY
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            return new Date(year, month, day).getTime();
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã:', e);
    }
    return null;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
function parseTimeString(timeStr) {
    if (!timeStr || timeStr === 'null') return null;
    
    try {
        // –§–æ—Ä–º–∞—Ç: HH:MM:SS
        const parts = timeStr.split(':');
        if (parts.length >= 2) {
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            const seconds = parts.length > 2 ? parseInt(parts[2], 10) : 0;
            return hours * 3600 + minutes * 60 + seconds;
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ä–µ–º–µ–Ω–∏:', e);
    }
    return null;
}

// C-
// C-
// C- –§–∏–ª—å—Ç—Ä –ò–ù–ü–£–¢–û–í
// C-
// C-

let tpi_cc_currentFilters = {
    courierName: '',
    cellName: '',
    statuses: [], // –ú–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
    allStatusesSelected: false
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
function initializeAllFilters() {
    initializeCourierNameFilter();
    initializeCellFilter();
    initializeStatusFilter();
    initializeResetFiltersButton();
    initializeTotalCourierCount();
}

// –§–∏–ª—å—Ç—Ä –ø–æ –§–ò–û –∫—É—Ä—å–µ—Ä–∞
function initializeCourierNameFilter() {
    const nameInput = document.getElementById('tpi-cc-search-courier-name');
    if (!nameInput) return;
    
    // –î–µ–±–∞—É–Ω—Å –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    let debounceTimer;
    
    nameInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            tpi_cc_currentFilters.courierName = this.value.trim().toLowerCase();
            applyAllFilters();
        }, 300);
    });
    
    // –û—á–∏—Å—Ç–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ Esc
    nameInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            tpi_cc_currentFilters.courierName = '';
            applyAllFilters();
        }
    });
}

// –§–∏–ª—å—Ç—Ä –ø–æ —è—á–µ–π–∫–µ
function initializeCellFilter() {
    const cellInput = document.getElementById('tpi-cc-search-courier-cell');
    if (!cellInput) return;
    
    let debounceTimer;
    
    cellInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            tpi_cc_currentFilters.cellName = this.value.trim().toLowerCase();
            applyAllFilters();
        }, 300);
    });
    
    cellInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            tpi_cc_currentFilters.cellName = '';
            applyAllFilters();
        }
    });
}

// –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º —á–µ—Ä–µ–∑ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
function initializeStatusFilter() {
    const statusDropdown = document.querySelector('.tpi-cc-search-dropdown');
    if (!statusDropdown) return;
    
    // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
    statusDropdown.addEventListener('tpi-dropdown-change', function(event) {
        if (event.detail) {
            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
            const selectedOptions = event.detail.selected;
            tpi_cc_currentFilters.statuses = selectedOptions.map(opt => opt.label);
            tpi_cc_currentFilters.allStatusesSelected = event.detail.allSelected || false;
            
            applyAllFilters();
        }
    });
}

// –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
function initializeResetFiltersButton() {
    const resetButton = document.querySelector('.tpi-cc-filters-reset');
    if (!resetButton) return;
    
    resetButton.addEventListener('click', function() {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–ø—É—Ç—ã
        const nameInput = document.getElementById('tpi-cc-search-courier-name');
        const cellInput = document.getElementById('tpi-cc-search-courier-cell');
        
        if (nameInput) {
            nameInput.value = '';
            nameInput.blur();
        }
        
        if (cellInput) {
            cellInput.value = '';
            cellInput.blur();
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã —á–µ—Ä–µ–∑ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        const statusDropdown = document.querySelector('.tpi-cc-search-dropdown');
        if (statusDropdown && statusDropdown.tpiDropdownInstance) {
            // –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã
            const allOptions = statusDropdown.tpiDropdownInstance.getAllOptions();
            statusDropdown.tpiDropdownInstance.setSelectedOptions(allOptions);
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        tpi_cc_currentFilters = {
            courierName: '',
            cellName: '',
            statuses: [],
            allStatusesSelected: true
        };
        
        // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
        removeNoResultsMessage();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã (–ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏)
        applyAllFilters();
    });
}

function initializeTotalCourierCount() {
    const tableBody = document.querySelector('.tpi-cc--table-tbody-wrapper');
    if (!tableBody) return;
    
    const rows = tableBody.querySelectorAll('.tpi-cc--table-tbody');
    const total = rows.length;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    updateFilterCounters(total, total);
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
function applyAllFilters() {
    const tableBody = document.querySelector('.tpi-cc--table-tbody-wrapper');
    if (!tableBody) return;
    
    const rows = Array.from(tableBody.querySelectorAll('.tpi-cc--table-tbody'));
    if (rows.length === 0) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö
    const previousVisibleCount = getVisibleRowCount();
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
    let visibleCount = 0;
    
    rows.forEach(row => {
        let shouldShow = true;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
        if (tpi_cc_currentFilters.courierName) {
            const nameElement = row.querySelector('p[tpi-cc-parsing-data="courier-full-name"]');
            const name = nameElement ? nameElement.textContent.trim().toLowerCase() : '';
            shouldShow = shouldShow && name.includes(tpi_cc_currentFilters.courierName);
        }
        
        if (shouldShow && tpi_cc_currentFilters.cellName) {
            const cellElement = row.querySelector('a[tpi-cc-parsing-data="courier-route-cell"]');
            const cell = cellElement ? cellElement.textContent.trim().toLowerCase() : '';
            shouldShow = shouldShow && cell.includes(tpi_cc_currentFilters.cellName);
        }
        
        if (shouldShow && !tpi_cc_currentFilters.allStatusesSelected && tpi_cc_currentFilters.statuses.length > 0) {
            const statusElement = row.querySelector('p[tpi-cc-parsing-data="courier-route-status"]');
            const status = statusElement ? statusElement.textContent.trim() : '';
            shouldShow = shouldShow && tpi_cc_currentFilters.statuses.includes(status);
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
        if (shouldShow) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–∏–º—ã—Ö —Å—Ç—Ä–æ–∫
    if (visibleCount !== previousVisibleCount) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤", –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        removeNoResultsMessage();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
        updateFilterCounters(rows.length, visibleCount);
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤–∏–¥–∏–º—ã—Ö —Å—Ç—Ä–æ–∫, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (visibleCount === 0 && hasActiveFilters()) {
            showNoResultsMessage();
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
    updateSortVisualEffects();
}

function getVisibleRowCount() {
    const tableBody = document.querySelector('.tpi-cc--table-tbody-wrapper');
    if (!tableBody) return 0;
    
    const rows = tableBody.querySelectorAll('.tpi-cc--table-tbody');
    let count = 0;
    
    rows.forEach(row => {
        if (row.style.display !== 'none') {
            count++;
        }
    });
    
    return count;
}

function hasActiveFilters() {
    return tpi_cc_currentFilters.courierName || 
           tpi_cc_currentFilters.cellName || 
           (!tpi_cc_currentFilters.allStatusesSelected && tpi_cc_currentFilters.statuses.length > 0);
}

function updateSortVisualEffects() {
    if (tpi_cc_currentFilterColumn === null) return;
    
    const table = document.querySelector('table.tpi-cc--table-data-output');
    if (!table) return;
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
    document.querySelectorAll('td.tpi-cc--table-tbody-item[tpi-current-state]').forEach(td => {
        td.removeAttribute('tpi-current-state');
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã —Ç–æ–ª—å–∫–æ –∫ –≤–∏–¥–∏–º—ã–º —Å—Ç—Ä–æ–∫–∞–º
    const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
        .filter(row => row.style.display !== 'none');
    
    visibleRows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('td.tpi-cc--table-tbody-item');
        if (cells.length > tpi_cc_currentFilterColumn) {
            const cell = cells[tpi_cc_currentFilterColumn];
            
            if (rowIndex === visibleRows.length - 1) {
                cell.setAttribute('tpi-current-state', 'filtered-last');
            } else {
                cell.setAttribute('tpi-current-state', 'filtered');
            }
        }
    });
}

function addVisualEffectsWithFilter(columnIndex) {
    const table = document.querySelector('table.tpi-cc--table-data-output');
    if (!table) return;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —Å—Ç—Ä–æ–∫–∏
    const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
        .filter(row => row.style.display !== 'none');
    
    visibleRows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('td.tpi-cc--table-tbody-item');
        if (cells.length > columnIndex) {
            const cell = cells[columnIndex];
            
            cell.removeAttribute('tpi-current-state');
            
            if (rowIndex === visibleRows.length - 1) {
                cell.setAttribute('tpi-current-state', 'filtered-last');
            } else {
                cell.setAttribute('tpi-current-state', 'filtered');
            }
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö
function updateFilterCounters(total, filtered) {
    const totalElement = document.getElementById('tpi-cc-data-total-couriers');
    const filteredElement = document.getElementById('tpi-cc-data-filtered-couriers');
    
    if (totalElement) {
        const span = totalElement.querySelector('span');
        if (span) span.textContent = total;
    }
    
    if (filteredElement) {
        const span = filteredElement.querySelector('span');
        if (span) {
            // –ï—Å–ª–∏ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º 0
            if (filtered === total) {
                span.textContent = '0';
            } else {
                span.textContent = filtered;
            }
        }
    }
}
