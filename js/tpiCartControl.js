const tpi_cc_i_cart_add = `
<svg stroke="currentColor" fill="none" stroke-width="0" viewBox="0 0 15 15" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M7.49991 0.876892C3.84222 0.876892 0.877075 3.84204 0.877075 7.49972C0.877075 11.1574 3.84222 14.1226 7.49991 14.1226C11.1576 14.1226 14.1227 11.1574 14.1227 7.49972C14.1227 3.84204 11.1576 0.876892 7.49991 0.876892ZM1.82707 7.49972C1.82707 4.36671 4.36689 1.82689 7.49991 1.82689C10.6329 1.82689 13.1727 4.36671 13.1727 7.49972C13.1727 10.6327 10.6329 13.1726 7.49991 13.1726C4.36689 13.1726 1.82707 10.6327 1.82707 7.49972ZM7.50003 4C7.77617 4 8.00003 4.22386 8.00003 4.5V7H10.5C10.7762 7 11 7.22386 11 7.5C11 7.77614 10.7762 8 10.5 8H8.00003V10.5C8.00003 10.7761 7.77617 11 7.50003 11C7.22389 11 7.00003 10.7761 7.00003 10.5V8H4.50003C4.22389 8 4.00003 7.77614 4.00003 7.5C4.00003 7.22386 4.22389 7 4.50003 7H7.00003V4.5C7.00003 4.22386 7.22389 4 7.50003 4Z" fill="currentColor"></path>
</svg>
`,
tpiIcon__trashBucket = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M170.5 51.6L151.5 80l145 0-19-28.4c-1.5-2.2-4-3.6-6.7-3.6l-93.7 0c-2.7 0-5.2 1.3-6.7 3.6zm147-26.6L354.2 80 368 80l48 0 8 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-8 0 0 304c0 44.2-35.8 80-80 80l-224 0c-44.2 0-80-35.8-80-80l0-304-8 0c-13.3 0-24-10.7-24-24S10.7 80 24 80l8 0 48 0 13.8 0 36.7-55.1C140.9 9.4 158.4 0 177.1 0l93.7 0c18.7 0 36.2 9.4 46.6 24.9zM80 128l0 304c0 17.7 14.3 32 32 32l224 0c17.7 0 32-14.3 32-32l0-304L80 128zm80 64l0 208c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-208c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0l0 208c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-208c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0l0 208c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-208c0-8.8 7.2-16 16-16s16 7.2 16 16z"></path>
</svg>
`,
tpiIcon__cross = `
<svg stroke="currentColor" fill="none" stroke-width="0" viewBox="0 0 15 15" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12.8536 2.85355C13.0488 2.65829 13.0488 2.34171 12.8536 2.14645C12.6583 1.95118 12.3417 1.95118 12.1464 2.14645L7.5 6.79289L2.85355 2.14645C2.65829 1.95118 2.34171 1.95118 2.14645 2.14645C1.95118 2.34171 1.95118 2.65829 2.14645 2.85355L6.79289 7.5L2.14645 12.1464C1.95118 12.3417 1.95118 12.6583 2.14645 12.8536C2.34171 13.0488 2.65829 13.0488 2.85355 12.8536L7.5 8.20711L12.1464 12.8536C12.3417 13.0488 12.6583 13.0488 12.8536 12.8536C13.0488 12.6583 13.0488 12.3417 12.8536 12.1464L8.20711 7.5L12.8536 2.85355Z" fill="currentColor"></path>
</svg>
`,
tpi_cc_i_cart = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" baseProfile="tiny" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path d="M20.756 5.345c-.191-.219-.466-.345-.756-.345h-13.819l-.195-1.164c-.08-.482-.497-.836-.986-.836h-2.25c-.553 0-1 .447-1 1s.447 1 1 1h1.403l1.86 11.164.045.124.054.151.12.179.095.112.193.13.112.065c.116.047.238.075.367.075h11.001c.553 0 1-.447 1-1s-.447-1-1-1h-10.153l-.166-1h11.319c.498 0 .92-.366.99-.858l1-7c.041-.288-.045-.579-.234-.797zm-1.909 1.655l-.285 2h-3.562v-2h3.847zm-4.847 0v2h-3v-2h3zm0 3v2h-3v-2h3zm-4-3v2h-3l-.148.03-.338-2.03h3.486zm-2.986 3h2.986v2h-2.653l-.333-2zm7.986 2v-2h3.418l-.285 2h-3.133z"></path>
    <circle cx="8.5" cy="19.5" r="1.5">
    </circle><circle cx="17.5" cy="19.5" r="1.5"></circle>
</svg>
`,
tpi_cc_i_pallet = `
<svg class="tpi-infi--icon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 640 512" height="12px" width="12px" xmlns="http://www.w3.org/2000/svg">
    <path d="M144 256h352c8.8 0 16-7.2 16-16V16c0-8.8-7.2-16-16-16H384v128l-64-32-64 32V0H144c-8.8 0-16 7.2-16 16v224c0 8.8 7.2 16 16 16zm480 128c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h48v64H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h608c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16h-48v-64h48zm-336 64H128v-64h160v64zm224 0H352v-64h160v64z"></path>
</svg>
`,
tpi_cc_i_courier = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"></path>
    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"></path>
</svg>
`,
tpi_cc_i_courier_id = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M528 32H48C21.5 32 0 53.5 0 80v16h576V80c0-26.5-21.5-48-48-48zM0 432c0 26.5 21.5 48 48 48h480c26.5 0 48-21.5 48-48V128H0v304zm352-232c0-4.4 3.6-8 8-8h144c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4 0-8-3.6-8-8v-16zm0 64c0-4.4 3.6-8 8-8h144c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4 0-8-3.6-8-8v-16zm0 64c0-4.4 3.6-8 8-8h144c4.4 0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4 0-8-3.6-8-8v-16zM176 192c35.3 0 64 28.7 64 64s-28.7 64-64 64-64-28.7-64-64 28.7-64 64-64zM67.1 396.2C75.5 370.5 99.6 352 128 352h8.2c12.3 5.1 25.7 8 39.8 8s27.6-2.9 39.8-8h8.2c28.4 0 52.5 18.5 60.9 44.2 3.2 9.9-5.2 19.8-15.6 19.8H82.7c-10.4 0-18.8-10-15.6-19.8z"></path>
</svg>
`,
tpi_cc_i_courier_route_id = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M5 3C6.30622 3 7.41746 3.83481 7.82929 5H10C12.2091 5 14 6.79086 14 9C14 11.2091 12.2091 13 10 13H7C5.34315 13 4 14.3431 4 16C4 17.6569 5.34315 19 7 19H13L15 21H7C4.23858 21 2 18.7614 2 16C2 13.2386 4.23858 11 7 11H10C11.1046 11 12 10.1046 12 9C12 7.89543 11.1046 7 10 7H7.82929C7.41746 8.16519 6.30622 9 5 9C3.34315 9 2 7.65685 2 6C2 4.34315 3.34315 3 5 3Z"></path>
    <path fill-rule="evenodd" clip-rule="evenodd" d="M17.5608 20.9961H18.4484C18.7487 20.192 19.5015 19.5618 20.1257 19.0568C20.3933 18.8404 20.6413 18.6397 20.8273 18.4502C21.3871 17.8811 21.7684 17.1554 21.9229 16.3652C22.0775 15.5751 21.9984 14.7559 21.6956 14.0116C21.3928 13.2673 20.88 12.6313 20.2221 12.1841C19.5642 11.737 18.7908 11.4989 18 11.5C17.2092 11.4989 16.4358 11.737 15.7779 12.1841C15.12 12.6313 14.6072 13.2673 14.3044 14.0116C14.0016 14.7559 13.9225 15.5751 14.0771 16.3652C14.2316 17.1554 14.6129 17.8811 15.1727 18.4502C15.359 18.6412 15.6088 18.8435 15.8786 19.0619C16.5011 19.5658 17.2566 20.2524 17.5608 20.9961Z"></path>
</svg>
`,
tpi_cc_i_courier_print = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
    <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1"></path><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"></path>
</svg>
`,
tpi_cc_i_courier_delete = `
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 16 16">
        <path fill="currentColor" d="M5.386 6h1.806l.219 7H5.886zm3.206 7 .218-7h1.814l-.5 7z"></path>
        <path fill="currentColor" fill-rule="evenodd" d="M7.837.014h.303c.71-.001 1.333-.002 1.881.22a3 3 0 0 1 1.257.962c.36.47.522 1.072.707 1.758l.012.046H15v2l-.96.48-.585 5.922c-.177 1.787-.265 2.68-.72 3.326a3 3 0 0 1-.975.883C11.073 16 10.175 16 8.38 16h-.76c-1.795 0-2.693 0-3.38-.39a3 3 0 0 1-.974-.882c-.456-.646-.544-1.54-.72-3.326L1.96 5.48 1 5V3h2.98l.012-.046c.185-.686.347-1.287.706-1.758A3 3 0 0 1 5.955.235C6.503.012 7.126.013 7.837.015M3.922 5l.614 6.205c.092.93.15 1.494.23 1.911.036.194.07.308.095.376.022.06.037.08.04.084.085.12.196.221.324.294a.3.3 0 0 0 .088.031c.07.018.187.04.383.059.423.038.99.04 1.925.04h.758c.935 0 1.502-.002 1.925-.04.196-.018.313-.04.383-.059.062-.016.083-.028.088-.03a1 1 0 0 0 .325-.295c.002-.004.017-.024.039-.084a2.4 2.4 0 0 0 .096-.376c.08-.417.138-.981.23-1.91L12.077 5zm5.766-2.592c.063.084.116.2.232.592H6.057c.115-.393.168-.508.232-.592a1 1 0 0 1 .419-.32c.137-.056.327-.074 1.28-.074s1.144.018 1.28.074a1 1 0 0 1 .42.32" clip-rule="evenodd"></path>
</svg>
`,
tpi_cc_i_warning = `
<svg class="tpi-cc-i-warning" stroke="currentColor" fill="url(#myGradient)" stroke-width="0" version="1.2" baseProfile="tiny" width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <linearGradient id="myGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="var(--no-ds-color-1)" />
            <stop offset="100%" stop-color="var(--no-ds-color-2)" />
        </linearGradient>
    </defs>
    <path d="M12 5.511c.561 0 1.119.354 1.544 1.062l5.912 9.854c.851 1.415.194 2.573-1.456 2.573h-12c-1.65 0-2.307-1.159-1.456-2.573l5.912-9.854c.425-.708.983-1.062 1.544-1.062m0-2c-1.296 0-2.482.74-3.259 2.031l-5.912 9.856c-.786 1.309-.872 2.705-.235 3.83s1.879 1.772 3.406 1.772h12c1.527 0 2.77-.646 3.406-1.771s.551-2.521-.235-3.83l-5.912-9.854c-.777-1.294-1.963-2.034-3.259-2.034z"></path>
    <circle cx="12" cy="16" r="1.3"></circle>
    <path d="M13.5 10c0-.83-.671-1.5-1.5-1.5s-1.5.67-1.5 1.5c0 .199.041.389.111.562.554 1.376 1.389 3.438 1.389 3.438l1.391-3.438c.068-.173.109-.363.109-.562z"></path>
</svg>
`,
tpi_cc_i_loading = `
<svg class="tpi-cc-i-loading" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" style="shape-rendering: auto; background: transparent;">
    <defs>
        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="var(--no-ds-color-1)"/>
            <stop offset="100%" stop-color="var(--no-ds-color-2)"/>
        </linearGradient>
    </defs>
    <path style="transform:scale(0.8);transform-origin:50px 50px" stroke-linecap="round" d="M24.3 30C11.4 30 5 43.3 5 50s6.4 20 19.3 20c19.3 0 32.1-40 51.4-40 C88.6 30 95 43.3 95 50s-6.4 20-19.3 20C56.4 70 43.6 30 24.3 30z" stroke-dasharray="130.8603533935547 125.72857482910155" stroke-width="10" stroke="url(#gradient)" fill="none">
        <animate values="0;256.58892822265625" keyTimes="0;1" dur="0.9523809523809523s" repeatCount="indefinite" attributeName="stroke-dashoffset"/>
    </path>
</svg>
`,
tpi_cc_i_checmark = `
<svg class="tpi_cc_i_checmark" viewBox="0 0 120 120">
    <defs>
        <linearGradient id="circleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="var(--no-ds-color-1)" />
            <stop offset="100%" stop-color="var(--no-ds-color-2)" />
        </linearGradient>
    </defs>
    
    <circle class="tpi-circle-outline" cx="60" cy="60" r="50" stroke="url(#circleGradient)"/>
    <path class="tpi-checkmark" d="M43,60 L55,75 L78,45" stroke="url(#circleGradient)" fill="none" stroke-width="4"/>
</svg>
`,
tpi_cc_i_filter_default = `
<svg class="tpi-filter-icon-default" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
    <path d="M8.53039 5.46978L5.00006 1.93945L1.46973 5.46978L2.53039 6.53044L4.25006 4.81077V14.0001H5.75006V4.81077L7.46973 6.53044L8.53039 5.46978Z"></path>
    <path d="M11.7501 11.1895L13.4697 9.46978L14.5304 10.5304L11.0001 14.0608L7.46973 10.5304L8.53039 9.46978L10.2501 11.1895V2.00011H11.7501V11.1895Z"></path>
</svg>
`,
tpi_cc_i_filter_up = `
<svg class="tpi-filter-icon-up" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M304 416h-64a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h64a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM16 160h48v304a16 16 0 0 0 16 16h32a16 16 0 0 0 16-16V160h48c14.21 0 21.38-17.24 11.31-27.31l-80-96a16 16 0 0 0-22.62 0l-80 96C-5.35 142.74 1.77 160 16 160zm416 0H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h192a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm-64 128H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h128a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zM496 32H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h256a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16z"></path>
</svg>
`,
tpi_cc_i_filter_down = `
<svg class="tpi-filter-icon-down" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M240 96h64a16 16 0 0 0 16-16V48a16 16 0 0 0-16-16h-64a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16zm0 128h128a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16zm256 192H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16h256a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16zm-256-64h192a16 16 0 0 0 16-16v-32a16 16 0 0 0-16-16H240a16 16 0 0 0-16 16v32a16 16 0 0 0 16 16zm-64 0h-48V48a16 16 0 0 0-16-16H80a16 16 0 0 0-16 16v304H16c-14.19 0-21.37 17.24-11.29 27.31l80 96a16 16 0 0 0 22.62 0l80-96C197.35 369.26 190.22 352 176 352z"></path>
</svg>
`,
tpi_cc_i_print_row = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
    <path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1"></path><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"></path>
</svg>
`,
tpi_cc_i_search = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tpi-search-icon">
    <circle class="glass" cx="10.5" cy="10.5" r="7.5" fill="none" stroke="currentcolor" stroke-width="1.5"/>
    <circle class="glassGap" cx="10.5" cy="10.5" r="7.5" fill="none" stroke="currentcolor" stroke-width="1.5"/>
    <path class="handle" d="m16.563 16.458 4.223 5.372-1.572 1.236-4.21-5.356" fill="currentcolor"/>
</svg>
`,
tpi_cc_i_calendar = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="14px" width="14px" xmlns="http://www.w3.org/2000/svg">
    <rect width="416" height="384" x="48" y="80" fill="none" stroke-linejoin="round" stroke-width="32" rx="48"></rect>
    <circle cx="296" cy="232" r="24"></circle>
    <circle cx="376" cy="232" r="24"></circle
    <circle cx="296" cy="312" r="24"></circle<circle cx="376" cy="312" r="24"></circle>
    <circle cx="136" cy="312" r="24"></circle><circle cx="216" cy="312" r="24"></circle>
    <circle cx="136" cy="392" r="24"></circle><circle cx="216" cy="392" r="24"></circle>
    <circle cx="296" cy="392" r="24"></circle>
    <path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M128 48v32m256-32v32"></path>
    <path fill="none" stroke-linejoin="round" stroke-width="32" d="M464 160H48"></path>
</svg>
`,
tpi_cc_i_clock = `
<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="14px" width="14px" xmlns="http://www.w3.org/2000/svg">
    <circle cx="12" cy="12" r="10"></circle>
    <polyline points="12 6 12 12 16 14"></polyline>
</svg>
`

function checkiIs__onCartControlsPage() {
    'use strict';

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ URL
    function isCartControlsPage(url) {
        const base = 'https://logistics.market.yandex.ru/sorting-center/21972131/orders/tpi-cart-controls?tpiCartControls=true';
        if (!url.startsWith(base)) return false;
        
        const params = new URLSearchParams(url.split('?')[1] || '');
        return params.get('tpiCartControls') === 'true' 
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ (–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è)
    function addTurboBlock() {
        if (document.querySelector('.tpi-settings--wrapper')) return;

        document.title = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MK"

        const overlay = document.createElement('div');
        overlay.className = 'tpi-cc--wrapper';

        overlay.innerHTML = 
        `
        <div class="tpi-cc--wrapper-title">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MK
        </div>

        <div class="tpi-cc-filters-panel">
            <div class="tpi-cc-filters-wrapper">
                <div class="tpi-cc-filters-wrapper-title">
                    <p>–§–∏–ª—å—Ç—Ä—ã</p>
                </div>
                <div class="tpi-cc-filters-items-wrapper">
                    <div class="tpi-cc-filters-item">
                        <button class="tpi-cc-search-date">
                            <div class="tpi-cc-search-icon">${tpi_cc_i_calendar}</div>
                            <div class="tpi-cc-search-label-title" id="tpi-cc-seleceted-date">–î–∞—Ç–∞ –æ—Ç–≥—Ä—É–∑–∫–∏</div>
                        </button>
                    </div>
                    <div class="tpi-cc-filters-item">
                        <label for="tpi-cc-search-courier-name" class="tpi-cc-search-label">
                            <div class="tpi-cc-search-icon">${tpi_cc_i_search}</div>
                            <div class="tpi-cc-search-label-title">–§–ò–û –∫—É—Ä—å–µ—Ä–∞</div>
                            <input type="text" id="tpi-cc-search-courier-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û –∫—É—Ä—å–µ—Ä–∞" autocomplete="off">
                        </label>
                    </div>
                    <div class="tpi-cc-filters-item">
                        <label for="tpi-cc-search-courier-cell" class="tpi-cc-search-label">
                            <div class="tpi-cc-search-icon">${tpi_cc_i_search}</div>
                            <div class="tpi-cc-search-label-title">–ò–º—è —è—á–µ–π–∫–∏</div>
                            <input type="text" id="tpi-cc-search-courier-cell" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è —è—á–µ–π–∫–∏" autocomplete="off">
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="tpi-cc--no-ds-data-wrapper">
            <div class="tpi-cc--no-ds-data-container" tpi-current-state="ready-to-data-search">
                <div class="tpi-cc--no-ds-data-block">
                    <div class="tpi-cc--no-ds-data-title">
                        <p>–î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</p>
                    </div>
                </div>
                <div class="tpi-cc--no-ds-data-block">
                    <div class="tpi-cc--no-ds-data-icon-wrapper">
                        <i>${tpi_cc_i_warning}${tpi_cc_i_loading}${tpi_cc_i_checmark}</i>
                    </div>
                    <div class="tpi-cc--no-ds-data-info-wrapper">
                        <div class="tpi-cc--no-ds-data-description">
                            <p class="tpi-cc--no-ds-data-description-block">–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–µ –æ—Ç–≥—Ä—É–∑–∫–∏, –¥–ª—è –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ</p>
                            <p class="tpi-cc--no-ds-data-description-block-sub">–í–Ω–∏–º–∞–Ω–∏–µ! –ù–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤—ã –ø–µ—Ä–µ–∑–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—É—â—É—é –æ—Ç–≥—Ä—É–∑–∫—É –∏ –≤—Å—è –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç —É—Ç–µ—Ä—è–Ω–∞, –∫–æ—Ä–∏–¥–æ—Ä –¥–ª—è –∑–∞–ø–∏—Å–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö - —Å 23:00:00 –ø–æ 23:00:00 —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è</p>
                        </div>
                    </div>
                </div>  
                <div class="tpi-cc--no-ds-data-block">
                    <button class="tpi-cc--no-ds-data-start">–ù–∞—á–∞—Ç—å</button>
                </div>  
            </div>
        </div>
        <div class="tpi-cc--table-wrapper">
            <table class="tpi-cc--table-data-output">
                <thead class="tpi-cc--table-thead-wrapper">
                    <tr class="tpi-cc--table-thead">
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–î–∞–Ω–Ω—ã–µ –∫—É—Ä—å–µ—Ä–∞</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–Ø—á–µ–π–∫–∞</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item" tpi-cc-filters-not-allowed>
                            <div class="tpi-cc--table-thead-data">
                                <p>–ù–æ–º–µ—Ä CART</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item" tpi-cc-filters-not-allowed>
                            <div class="tpi-cc--table-thead-data">
                                <p>–ù–æ–º–µ—Ä PALLET</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>C—Ç–∞—Ç—É—Å</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–ù–∞—á–∞–ª–æ<br>—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–ö–æ–Ω–µ—Ü<br>—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item">
                            <div class="tpi-cc--table-thead-data">
                                <p>–ü—Ä–∏–±—ã—Ç–∏–µ<br>–∫—É—Ä—å–µ—Ä–∞</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                        <th class="tpi-cc--table-thead-item" tpi-cc-filters-not-allowed>
                            <div class="tpi-cc--table-thead-data">
                                <p>–ü–µ—á–∞—Ç—å</p>
                                <i class="tpi-cc--table-thead-filter">
                                    ${tpi_cc_i_filter_default}
                                    ${tpi_cc_i_filter_up}
                                    ${tpi_cc_i_filter_down}
                                </i>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody class="tpi-cc--table-tbody-wrapper"></tbody>
            </table>
        </div>
        <div class="tpi-cc-process-manager-wrapper" tpi-current-state="hidden">
            <div class="tpi-cc-process-manager-block">
                <div class="tpi-cc-process-manager-data-wrapper">
                    <div class="tpi-cc-process-manager-title">
                        <p>–í—ã–±—Ä–∞–Ω–Ω–æ:</p>
                    </div>
                    <div class="tpi-cc-process-data-container">
                        <div class="tpi-cc-process-data-item">
                            <i class="tpi-cc-process-data-item-icon">${tpi_cc_i_cart}</i>
                            <p class="tpi-cc-process-data-item-text tpi-cc-data-cart-amount">CART: <span>${'0'}</span></p>
                        </div>
                        <div class="tpi-cc-process-data-item">
                            <i class="tpi-cc-process-data-item-icon">${tpi_cc_i_pallet}</i>
                            <p class="tpi-cc-process-data-item-text tpi-cc-data-pallet-amount">PALLET: <span>${'0'}</span></p>
                        </div>
                    </div>
                </div>
                <button class="tpi-cc-process-manager-button" tpi-cc-action="print">
                    <p>–ü–µ—á–∞—Ç—å</p>
                    <i class="tpi-cc-progress-action-icon">${tpi_cc_i_courier_print}</i>
                </button>
                <button class="tpi-cc-process-manager-button" tpi-cc-action="delete">
                    <p>–£–¥–∞–ª–∏—Ç—å</p>
                    <i class="tpi-cc-progress-action-icon">${tpi_cc_i_courier_delete}</i>
                </button>
                <button class="tpi-cc-process-manager-close">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.44 12 21 19.56 19.56 21 12 13.44 4.44 21 3 19.56 10.56 12 3 4.44 4.44 3 12 10.56 19.56 3 21 4.44 13.44 12Z" fill="#000"></path>
                    </svg>
                </button>
            </div>
        </div>
        `
        
        const appID = document.getElementById("app")
        const headerTitle = document.querySelector(".p-layout__header-wrapper")
        appID.remove()
        headerTitle.remove()

        document.querySelector(".p-layout__content").appendChild(overlay);

        const tpi_cc_closeManager = document.querySelector('.tpi-cc-process-manager-close')
        tpi_cc_closeManager.addEventListener('click', ()=>{
            if(document.querySelectorAll('button.tpi-cc--table-tbody-data-button[tpi-cc-selected-courier-cell]')){
                const evrySelectedButton = document.querySelectorAll('button.tpi-cc--table-tbody-data-button[tpi-cc-selected-courier-cell]')
                evrySelectedButton.forEach(btn =>{
                    btn.removeAttribute('tpi-cc-selected-courier-cell')
                })
                update_ActionProcessContainer()
            }else return
        })
        
        callTurboPI__once();
        addTurboPiTitle()
        if (observer) {
            observer.disconnect();
            observer = null;
        }
    }


    if (isCartControlsPage(location.href)) {
        addTurboBlock();
        addCartsControlsListeners();
        addToastContainer()
        setTimeout(() => {
            tpiNotification.show('–°—Ç—Ä–∞–Ω–∏—Ü–∞ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ú–ö" –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞', "info", `–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω–æ–º, –ø–æ—Å–µ—Ç–∏—Ç–µ Wiki TURBOpi`);
        }, 100);
        return; 
    }

    observer = new MutationObserver(() => {
        if (isCartControlsPage(location.href)) {
            addTurboBlock();
        }
    });
    observer.observe(document, { subtree: true, childList: true });
    setTimeout(() => {
        addTurboPiTitle()
    }, 1000);
}

checkiIs__onCartControlsPage()

function addCartsControlsListeners(){
    waitForTokenAndRun();
    couriersDataCapturing();
    tpi_cc_filteringColumnData()
}


//B- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—É—Ä—å–µ—Ä–∞–º–∏ –∏ —è—á–µ–π–∫–∞–º–∏
async function tpi_getCouriersAndCells() {
    console.log('üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—å–µ—Ä–∞—Ö –∏ —è—á–µ–π–∫–∞—Ö...');
    
    try {
        // –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö
        const url = new URL('https://logistics.market.yandex.ru/api/resolve/');
        url.searchParams.append('r', 'sortingCenter/routes/resolveGetRoutesFullInfo:resolveGetRoutesFullInfo');

        const today = new Date();
        const currentHour = today.getHours();

        const targetDate = new Date(today);
        if (currentHour >= 22) {
            targetDate.setDate(targetDate.getDate() + 1);
        }

        const year = targetDate.getFullYear();
        const month = String(targetDate.getMonth() + 1).padStart(2, '0');
        const day = String(targetDate.getDate()).padStart(2, '0');
        const currentDate = `${year}-${month}-${day}`;
        
        const requestBody = {
            "params": [{
                "sortingCenterId": 21972131,
                "type": "OUTGOING_COURIER",
                "sort": "",
                "hasCarts": false,
                "category": "COURIER", 
                "date": currentDate,
                "recipientName": "",
                "page": 0,
                "size": 100
            }],
            "path": `/sorting-center/21972131/routes?type=OUTGOING_COURIER&sort=&hasCarts=false&category=COURIER&date=${currentDate}&recipientName=`
        };

        console.log('üìÖ –î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞:', currentDate);

        const response = await fetch(url.toString(), {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Market-Core-Service': '<UNKNOWN>',
                'sk': tpiUserTOKEN
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data && data.results && data.results.length > 0) {
            const result = data.results[0];
            
            if (result.error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ API:', result.error.message);
                return null;
            }
            
            if (result.data && result.data.content && result.data.content.length > 0) {
                const routes = result.data.content;
                console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤: ${routes.length}`);
                
                // –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º –§–ò–û –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                let courierNamesMap = {};
                const encryptedIds = [];
                const routeIdToEncryptedIdMap = {};
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ encrypted IDs
                routes.forEach((route, index) => {
                    if (route.destination && 
                        route.destination.destinationName && 
                        route.destination.destinationName.encryptedPersonalFullNameId) {
                        
                        const encryptedId = route.destination.destinationName.encryptedPersonalFullNameId;
                        encryptedIds.push(encryptedId);
                        routeIdToEncryptedIdMap[index] = encryptedId;
                    }
                });
                
                console.log(`üîê –°–æ–±—Ä–∞–Ω–æ encrypted IDs: ${encryptedIds.length}`);
                
                if (encryptedIds.length > 0) {
                    console.log('üì§ –ü–æ–ª—É—á–∞–µ–º –§–ò–û –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É...');
                    courierNamesMap = await tpi_getCourierNamesOneByOneWithCache(encryptedIds);
                    console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –§–ò–û –¥–ª—è ${Object.keys(courierNamesMap).length} –∫—É—Ä—å–µ—Ä–æ–≤`);
                }
                
                // –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
                const couriersData = routes.map((route, index) => {
                    // –ü–æ–ª—É—á–∞–µ–º –§–ò–û
                    let courierName = '–ù–µ —É–∫–∞–∑–∞–Ω';
                    const encryptedId = routeIdToEncryptedIdMap[index];
                    
                    if (encryptedId && courierNamesMap[encryptedId]) {
                        courierName = courierNamesMap[encryptedId];
                    } else if (route.courier && route.courier.externalId) {
                        courierName = `–ö—É—Ä—å–µ—Ä ${route.courier.externalId}`;
                    } else if (route.courier && route.courier.id) {
                        courierName = `–ö—É—Ä—å–µ—Ä ID:${route.courier.id}`;
                    }
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è—á–µ–π–∫—É
                    let cellNumbers = '–ù–µ—Ç —è—á–µ–µ–∫';
                    let mainCell = '–ù–µ—Ç —è—á–µ–π–∫–∏';
                    
                    if (route.cells && route.cells.length > 0) {
                        // –ï—Å—Ç—å —è—á–µ–π–∫–∏
                        cellNumbers = route.cells.map(cell => cell.number || '–ë–µ–∑ –Ω–æ–º–µ—Ä–∞').join(', ');
                        mainCell = route.cells[0]?.number || '–ù–µ—Ç —è—á–µ–π–∫–∏';
                    } else if (route.cell && route.cell.number) {
                        // –ï—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ cell
                        cellNumbers = route.cell.number;
                        mainCell = route.cell.number;
                    } else {
                        // –ü—É—Å—Ç–æ–π cells - –∫—É—Ä—å–µ—Ä —É–∂–µ –æ—Ç–≥—Ä—É–∂–µ–Ω –∏ –ø—Ä–æ–ø–∞–ª
                        cellNumbers = 'null';
                        mainCell = 'null';
                    }
                    
                    const routeStatus = route.status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    
                    return {
                        courier: courierName,
                        cell: mainCell,
                        cells: cellNumbers,
                        status: routeStatus,
                        ordersLeft: route.ordersLeft || 0,
                        ordersSorted: route.ordersSorted || 0,
                        ordersShipped: route.ordersShipped || 0,
                        ordersPlanned: route.ordersPlanned || 0,
                        sortablesInCell: route.sortablesInCell || 0,
                        sortablesPrepared: route.sortablesPrepared || 0,
                        courierArrivesAt: route.courierArrivesAt || null,
                        startedAt: route.startedAt || null,
                        finishedAt: route.finishedAt || null,
                        routeId: route.id || null,
                        courierId: route.courier?.id || null,
                        externalId: route.courier?.externalId || null,
                        encryptedId: encryptedId || null,
                        hasCells: route.cells && route.cells.length > 0
                    };
                });
                
                console.log(`üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∫—É—Ä—å–µ—Ä–æ–≤: ${couriersData.length}`);
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –§–ò–û
                const withRealNames = couriersData.filter(item => 
                    !item.courier.startsWith('–ö—É—Ä—å–µ—Ä ') && 
                    !item.courier.startsWith('–ö—É—Ä—å–µ—Ä ID:') && 
                    item.courier !== '–ù–µ —É–∫–∞–∑–∞–Ω'
                ).length;
                
                console.log('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –§–ò–û:');
                console.log(`  - –° —Ä–µ–∞–ª—å–Ω—ã–º–∏ –§–ò–û: ${withRealNames}`);
                console.log(`  - –° ID –≤–º–µ—Å—Ç–æ –§–ò–û: ${couriersData.length - withRealNames}`);
                
                // –ü–æ–∫–∞–∂–µ–º –ø—Ä–∏–º–µ—Ä—ã –∫—É—Ä—å–µ—Ä–æ–≤ —Å –§–ò–û –∏ –±–µ–∑
                const withNames = couriersData.filter(item => !item.courier.includes('–ö—É—Ä—å–µ—Ä'));
                const withoutNames = couriersData.filter(item => item.courier.includes('–ö—É—Ä—å–µ—Ä'));
                
                if (withNames.length > 0) {
                    console.log('\n‚úÖ –ö—É—Ä—å–µ—Ä—ã —Å –§–ò–û:');
                    withNames.slice(0, 5).forEach((item, i) => {
                        console.log(`  ${i + 1}. ${item.courier} (${item.cell})`);
                    });
                }
                
                if (withoutNames.length > 0) {
                    console.log('\n‚ö†Ô∏è –ö—É—Ä—å–µ—Ä—ã –±–µ–∑ –§–ò–û (—Ç–æ–ª—å–∫–æ ID):');
                    withoutNames.slice(0, 5).forEach((item, i) => {
                        console.log(`  ${i + 1}. ${item.courier} (${item.cell})`);
                    });
                    console.log(`  ...–∏ –µ—â–µ ${withoutNames.length - 5} –¥—Ä—É–≥–∏—Ö`);
                }
                
                return couriersData;
                
            } else {
                console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–∞—Ä—à—Ä—É—Ç–∞—Ö');
                return null;
            }
        } else {
            console.log('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
            return null;
        }
    } catch (error) {
        console.error('üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        return null;
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –§–ò–û –ø–æ –æ–¥–Ω–æ–º—É —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async function tpi_getCourierNamesOneByOneWithCache(encryptedIds) {
    const nameMap = {};
    const batchSize = 15; // –ü–æ 3 –∑–∞ —Ä–∞–∑
    const delay = 1500; // –ó–∞–¥–µ—Ä–∂–∫–∞ 1.5 —Å–µ–∫ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
    
    console.log(`üîê –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –§–ò–û –¥–ª—è ${encryptedIds.length} –∫—É—Ä—å–µ—Ä–æ–≤...`);
    
    // –°–æ–∑–¥–∞–µ–º –∫—ç—à –≤ localStorage
    const cacheKey = 'tpi_courier_names_cache';
    let cache = {};
    
    try {
        const cached = localStorage.getItem(cacheKey);
        if (cached) {
            cache = JSON.parse(cached);
            console.log(`üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(cache).length} –§–ò–û –∏–∑ –∫—ç—à–∞`);
        }
    } catch (e) {
        console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—ç—à');
    }
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    const toFetch = [];
    encryptedIds.forEach(id => {
        if (cache[id]) {
            nameMap[id] = cache[id];
        } else {
            toFetch.push(id);
        }
    });
    
    console.log(`üìä –ò–∑ –∫—ç—à–∞: ${Object.keys(nameMap).length}, –Ω—É–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å: ${toFetch.length}`);
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è
    for (let i = 0; i < toFetch.length; i += batchSize) {
        const batch = toFetch.slice(i, i + batchSize);
        console.log(`üì¶ –ë–∞—Ç—á ${Math.floor(i/batchSize) + 1}: ${batch.length} —à—Ç`);
        
        const promises = batch.map(async (encryptedId) => {
            try {
                const name = await tpi_getSingleCourierName(encryptedId);
                if (name) {
                    nameMap[encryptedId] = name;
                    cache[encryptedId] = name; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                    return { success: true, id: encryptedId };
                }
                return { success: false, id: encryptedId };
            } catch (error) {
                console.log(`‚ùå –û—à–∏–±–∫–∞ –¥–ª—è ${encryptedId.substring(0, 15)}...: ${error.message}`);
                return { success: false, id: encryptedId };
            }
        });
        
        const results = await Promise.all(promises);
        const successCount = results.filter(r => r.success).length;
        console.log(`  ‚úÖ –£—Å–ø–µ—à–Ω–æ: ${successCount}/${batch.length}`);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—ç—à –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞
        try {
            localStorage.setItem(cacheKey, JSON.stringify(cache));
        } catch (e) {
            console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫—ç—à');
        }
        
        // –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –±–∞—Ç—á–µ–º
        if (i + batchSize < toFetch.length) {
            console.log(`  ‚è≥ –ñ–¥–µ–º ${delay}ms...`);
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
    
    console.log(`üéØ –ò—Ç–æ–≥: ${Object.keys(nameMap).length} –§–ò–û (${Object.keys(nameMap).length - (encryptedIds.length - toFetch.length)} –Ω–æ–≤—ã—Ö)`);
    return nameMap;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –§–ò–û –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞
async function tpi_getSingleCourierName(encryptedId) {
    try {
        const url = new URL('https://logistics.market.yandex.ru/api/resolve/');
        url.searchParams.append('r', 'logPoint/getLogpointPersonalIdBulk:getLogpointPersonalIdBulk');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
        const requestBody = {
            "params": [{
                "campaignId": 21972131,
                "ids": [encryptedId]
            }],
            "path": `/sorting-center/21972131/routes?type=OUTGOING_COURIER&sort=&hasCarts=false&category=COURIER`
        };

        const response = await fetch(url.toString(), {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Market-Core-Service': '<UNKNOWN>',
                'sk': tpiUserTOKEN
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            return null;
        }

        const responseText = await response.text();
        if (!responseText) return null;

        try {
            const data = JSON.parse(responseText);
            if (data && data.results && data.results[0] && data.results[0].data) {
                const name = Object.values(data.results[0].data)[0];
                if (name && typeof name === 'string') {
                    return name;
                }
            }
        } catch (e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
        }
        
        return null;
    } catch (error) {
        return null;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º
function sortCouriersByGroups(couriersData) {
    const firstWave = []; // MK-1...
    const secondWave = []; // MK-2...
    const kgt = []; // KGT...
    const alreadyGone = []; // null
    const others = []; // –û—Å—Ç–∞–ª—å–Ω—ã–µ
    
    couriersData.forEach(courier => {
        const cell = courier.cell.toUpperCase();
        
        if (cell === 'null') {
            alreadyGone.push(courier);
        } else if (cell.startsWith('MK-1')) {
            firstWave.push(courier);
        } else if (cell.startsWith('MK-2')) {
            secondWave.push(courier);
        } else if (cell.startsWith('KGT')) {
            kgt.push(courier);
        } else {
            others.push(courier);
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –Ω–æ–º–µ—Ä—É —è—á–µ–π–∫–∏
    const sortByCellNumber = (a, b) => {
        if (a.cell === 'null' || b.cell === 'null') return 0;
        
        const extractNumber = (cell) => {
            const match = cell.match(/\d+/);
            return match ? parseInt(match[0]) : 0;
        };
        
        return extractNumber(a.cell) - extractNumber(b.cell);
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –§–ò–û (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏–ª–∏ –ø–æ ID
    const sortByNameOrId = (a, b) => {
        // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–∞–ª–∏—á–∏—é —Ä–µ–∞–ª—å–Ω–æ–≥–æ –§–ò–û
        const aHasRealName = !a.courier.includes('–ö—É—Ä—å–µ—Ä ');
        const bHasRealName = !b.courier.includes('–ö—É—Ä—å–µ—Ä ');
        
        if (aHasRealName && !bHasRealName) return -1;
        if (!aHasRealName && bHasRealName) return 1;
        
        // –ï—Å–ª–∏ –æ–±–∞ —Å –§–ò–û –∏–ª–∏ –æ–±–∞ –±–µ–∑ - —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏/ID
        return a.courier.localeCompare(b.courier);
    };
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –≥—Ä—É–ø–ø—É
    firstWave.sort(sortByCellNumber);
    secondWave.sort(sortByCellNumber);
    kgt.sort(sortByCellNumber);
    others.sort(sortByCellNumber);
    alreadyGone.sort(sortByNameOrId); // –°–æ—Ä—Ç–∏—Ä—É–µ–º "null" –ø–æ –∏–º–µ–Ω–∏
    
    return { firstWave, secondWave, kgt, alreadyGone, others };
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–∞–±–ª–∏—Ü—ã –≤ –∫–æ–Ω—Å–æ–ª—å
function displayCourierTable(couriers, title) {
    if (couriers.length === 0) return;
    
    console.log(`\nüìã ${title} (${couriers.length}):`);
    
    const tableData = couriers.map(item => ({
        '–Ø—á–µ–π–∫–∞': item.cell,
        '–ö—É—Ä—å–µ—Ä': item.courier,
        '–°—Ç–∞—Ç—É—Å': item.status,
        '–û—Å—Ç–∞–ª–æ—Å—å': item.ordersLeft,
        '–û—Ç–≥—Ä—É–∂–µ–Ω–æ': item.ordersShipped,
        '–í—Å–µ–≥–æ': item.ordersPlanned,
        '–ü—Ä–∏–±—ã—Ç–∏–µ': item.courierArrivesAt ? new Date(item.courierArrivesAt).toLocaleTimeString() : '-'
    }));
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É: —Å–Ω–∞—á–∞–ª–∞ —Å –§–ò–û, –ø–æ—Ç–æ–º —Å ID
    tableData.sort((a, b) => {
        const aHasName = !a.–ö—É—Ä—å–µ—Ä.includes('–ö—É—Ä—å–µ—Ä ');
        const bHasName = !b.–ö—É—Ä—å–µ—Ä.includes('–ö—É—Ä—å–µ—Ä ');
        if (aHasName && !bHasName) return -1;
        if (!aHasName && bHasName) return 1;
        return a.–ö—É—Ä—å–µ—Ä.localeCompare(b.–ö—É—Ä—å–µ—Ä);
    });
    
    console.table(tableData);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–∑–æ–≤–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π –≤ –∫–æ–Ω—Å–æ–ª–∏
async function showCouriers() {
    try {
        console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—å–µ—Ä–∞—Ö...');
        const data = await tpi_getCouriersAndCells();
        
        if (!data || data.length === 0) {
            console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—å–µ—Ä–∞—Ö');
            return;
        }

        console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${data.length} –∫—É—Ä—å–µ—Ä–æ–≤`);
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º
        const { firstWave, secondWave, kgt, alreadyGone, others } = sortCouriersByGroups(data);
        
        // –í—ã–≤–æ–¥–∏–º —Ç–∞–±–ª–∏—Ü—ã
        displayCourierTable(firstWave, '–ü–ï–†–í–ê–Ø –í–û–õ–ù–ê (MK-1...)');
        displayCourierTable(secondWave, '–í–¢–û–†–ê–Ø –í–û–õ–ù–ê (MK-2...)');
        displayCourierTable(kgt, '–ö–ì–¢ (KGT...)');
        displayCourierTable(alreadyGone, 'null–ò');
        
        if (others.length > 0) {
            displayCourierTable(others, '–î–†–£–ì–ò–ï –Ø–ß–ï–ô–ö–ò');
        }
        
        // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const shippedCouriers = data.filter(item => item.status === 'SHIPPED').length;
        const withRealNames = data.filter(item => !item.courier.includes('–ö—É—Ä—å–µ—Ä ')).length;
        const totalOrdersLeft = data.reduce((sum, item) => sum + (item.ordersLeft || 0), 0);
        const totalOrdersShipped = data.reduce((sum, item) => sum + (item.ordersShipped || 0), 0);
        const totalOrdersPlanned = data.reduce((sum, item) => sum + (item.ordersPlanned || 0), 0);
        
        console.log(`\nüìà –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:`);
        console.log(`   –í—Å–µ–≥–æ –∫—É—Ä—å–µ—Ä–æ–≤: ${data.length}`);
        console.log(`   ‚îú‚îÄ –° –§–ò–û: ${withRealNames}`);
        console.log(`   ‚îú‚îÄ –° ID: ${data.length - withRealNames}`);
        console.log(`   ‚îú‚îÄ –ü–µ—Ä–≤–∞—è –≤–æ–ª–Ω–∞: ${firstWave.length}`);
        console.log(`   ‚îú‚îÄ –í—Ç–æ—Ä–∞—è –≤–æ–ª–Ω–∞: ${secondWave.length}`);
        console.log(`   ‚îú‚îÄ –ö–ì–¢: ${kgt.length}`);
        console.log(`   ‚îú‚îÄ null–∏: ${alreadyGone.length}`);
        console.log(`   ‚îî‚îÄ –î—Ä—É–≥–∏–µ: ${others.length}`);
        console.log(`   –û—Ç–≥—Ä—É–∂–µ–Ω–æ: ${shippedCouriers}`);
        console.log(`   –í —Ä–∞–±–æ—Ç–µ: ${data.length - shippedCouriers}`);
        console.log(`   –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${totalOrdersPlanned}`);
        console.log(`   –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: ${totalOrdersLeft}`);
        console.log(`   –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤ –æ—Ç–≥—Ä—É–∂–µ–Ω–æ: ${totalOrdersShipped}`);
        const efficiency = totalOrdersPlanned > 0 ? ((totalOrdersShipped / totalOrdersPlanned) * 100).toFixed(1) : 0;
        console.log(`   –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${efficiency}%`);
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        console.log(`\nüìä –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û:`);
        console.log(`   –°—Ä–µ–¥–Ω–µ–µ –Ω–∞ –∫—É—Ä—å–µ—Ä–∞: ${(totalOrdersPlanned / data.length).toFixed(1)} –∑–∞–∫–∞–∑–æ–≤`);
        console.log(`   –°—Ä–µ–¥–Ω–µ–µ –æ—Å—Ç–∞–ª–æ—Å—å: ${(totalOrdersLeft / data.length).toFixed(1)} –Ω–∞ –∫—É—Ä—å–µ—Ä–∞`);
        
        // –ü–æ–∫–∞–∂–µ–º –∫—É—Ä—å–µ—Ä–æ–≤ —Å –§–ò–û
        const couriersWithNames = data.filter(item => !item.courier.includes('–ö—É—Ä—å–µ—Ä '));
        if (couriersWithNames.length > 0) {
            console.log(`\nüë§ –ö—É—Ä—å–µ—Ä—ã —Å –§–ò–û (${couriersWithNames.length}):`);
            couriersWithNames.forEach(item => {
                console.log(`  ‚Ä¢ ${item.courier}`);
            });
        }
        
    } catch (error) {
        console.error('üí• –û—à–∏–±–∫–∞:', error);
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
window.tpi_getCouriersAndCells = tpi_getCouriersAndCells;
window.showCouriers = showCouriers;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞ –§–ò–û
function tpi_clearCourierNamesCache() {
    localStorage.removeItem('tpi_courier_names_cache');
    console.log('üóëÔ∏è –ö—ç—à –§–ò–û –æ—á–∏—â–µ–Ω');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–∞
function waitForTokenAndRun() {
    let attempts = 0;
    const maxAttempts = 15;
    
    const checkInterval = setInterval(() => {
        attempts++;
        
        if (tpiUserTOKEN !== null && tpiUserTOKEN !== undefined) {
            console.log('‚úÖ –¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
            clearInterval(checkInterval);
            // showCouriers();
        } else if (attempts >= maxAttempts) {
            console.log('‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞');
            clearInterval(checkInterval);
        } else {
            console.log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞... (–ø–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts})`);
        }
    }, 1000);
}

let dataCapturingFlag = false

function couriersDataCapturing(){
    const tpi_cc_startButton = document.querySelector('.tpi-cc--no-ds-data-start')
    const tpi_cc_areaContainer = document.querySelector('.tpi-cc--no-ds-data-container')
    const tpi_cc_desctiption = document.querySelector('.tpi-cc--no-ds-data-description')
    const tpi_cc_tableBody = document.querySelector('.tpi-cc--table-tbody-wrapper')
    
    tpi_cc_startButton.addEventListener('click', async () => {
        if(dataCapturingFlag === false){
            document.querySelector('.tpi-cc--no-ds-data-title').innerHTML = "<p>–ó–∞–≥—Ä—É–∑–∫–∞</p>"
            dataCapturingFlag = true
            tpi_cc_areaContainer.setAttribute('tpi-current-state', 'loading-data')
            tpi_cc_desctiption.innerHTML = `
                <div class="tpi-cc-no-ds-data-loading-item" tpi-cc-search-id="0" tpi-cc-status="waiting">
                    <i class="tpi-cc-no-ds-data-loading-item-icon"></i>
                    <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞</p>
                </div>
                <div class="tpi-cc-no-ds-data-loading-item" tpi-cc-search-id="1" tpi-cc-status="waiting">
                    <i class="tpi-cc-no-ds-data-loading-item-icon"></i>
                    <p>–ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤</p>
                </div>
                <div class="tpi-cc-no-ds-data-loading-item" tpi-cc-search-id="2" tpi-cc-status="waiting">
                    <i class="tpi-cc-no-ds-data-loading-item-icon"></i>
                    <p>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤</p>
                </div>
                <div class="tpi-cc-no-ds-data-loading-item" tpi-cc-search-id="3" tpi-cc-status="waiting">
                    <i class="tpi-cc-no-ds-data-loading-item-icon"></i>
                    <p>–ó–∞–ø–∏—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</p>
                </div>
                <div class="tpi-cc-no-ds-data-loading-item" tpi-cc-search-id="4" tpi-cc-status="waiting">
                    <i class="tpi-cc-no-ds-data-loading-item-icon"></i>
                    <p>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ DOM</p>
                </div>
            `
            
            await fillCouriersTable();
        } else return
    })
    
    async function fillCouriersTable() {
        try {
            console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã...');
    
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
            updateLoadingStatus(0, 'in-progress');
    
            // –®–∞–≥ 0: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞ (—Ä–µ–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)
            if (!tpiUserTOKEN) {
                throw new Error('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            // –ú–∏–Ω–∏–º—É–º 1.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            await new Promise(resolve => setTimeout(resolve, 1500));
            updateLoadingStatus(0, 'complete');
    
            // –®–∞–≥ 1: –ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–æ–≤
            updateLoadingStatus(1, 'in-progress');
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫—É—Ä—å–µ—Ä–∞—Ö
            const data = await tpi_getCouriersAndCells();
    
            if (!data || data.length === 0) {
                throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫—É—Ä—å–µ—Ä–∞—Ö');
            }
            
            // –ú–∏–Ω–∏–º—É–º 1.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            await new Promise(resolve => setTimeout(resolve, 1500));
            updateLoadingStatus(1, 'complete');
    
            // –®–∞–≥ 2: –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
            updateLoadingStatus(2, 'in-progress');
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫—É—Ä—å–µ—Ä–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º
            const { firstWave, secondWave, kgt, alreadyGone, others } = sortCouriersByGroups(data);
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã
            const allCouriers = [
                ...firstWave,
                ...secondWave, 
                ...kgt,
                ...alreadyGone,
                ...others
            ];
            
            // –ú–∏–Ω–∏–º—É–º 1.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            await new Promise(resolve => setTimeout(resolve, 1500));
            updateLoadingStatus(2, 'complete');
    
            // –®–∞–≥ 3: –ó–∞–ø–∏—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            updateLoadingStatus(3, 'in-progress');
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
            await new Promise(resolve => setTimeout(resolve, 3000));
            updateLoadingStatus(3, 'complete');
    
            // –®–∞–≥ 4: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ DOM
            updateLoadingStatus(4, 'in-progress');
            
            // –ú–∏–Ω–∏–º—É–º 1.5 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // –í–ê–ñ–ù–û: –°–Ω–∞—á–∞–ª–∞ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ complete
            updateLoadingStatus(4, 'complete');

            await new Promise(resolve => setTimeout(resolve, 500));
            const progressContainerWrapper = document.querySelector('.tpi-cc--no-ds-data-container')
            progressContainerWrapper.setAttribute('tpi-current-state', 'loading-data-animation')
            await new Promise(resolve => setTimeout(resolve, 1500));
            document.querySelector('.tpi-cc-no-ds-data-loading-item[tpi-cc-search-id="2"] p').innerText = "–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, —Ö–æ—Ä–æ—à–µ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏!"
            progressContainerWrapper.setAttribute('tpi-current-state', 'done')

            // –ñ–¥–µ–º 1.5 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥ —Å—Ç–∞–ª complete
            await new Promise(resolve => setTimeout(resolve, 2000));

            progressContainerWrapper.setAttribute('tpi-current-state', 'hidden')

            await new Promise(resolve => setTimeout(resolve, 600));
            
            // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞
            allCouriers.forEach((courier, index) => {
                const row = createCourierTableRow(courier, index);
                tpi_cc_tableBody.appendChild(row);
            });
            
            // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            document.querySelector('.tpi-cc--no-ds-data-wrapper').style.display = 'none';
            document.querySelector('.tpi-cc--table-wrapper').style.display = 'block';
    
            cartPallet_btnActions();
    
        } catch (error) {
            console.log('üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã:', error);
            updateLoadingStatus(0, 'error');
        }
    }

    function cartPallet_btnActions(){
        const tpi_cc_actionButtons = document.querySelectorAll('.tpi-cc-table-tbody-data-cart-id, .tpi-cc-table-tbody-data-pallet-id');
        tpi_cc_actionButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.hasAttribute('tpi-cc-selected-courier-cell')) {
                    btn.removeAttribute('tpi-cc-selected-courier-cell');
                } else {
                    btn.setAttribute('tpi-cc-selected-courier-cell', '');
                }
                update_ActionProcessContainer()
            })
        });
        update_ActionProcessContainer()
    }

    function createCourierTableRow(courierData, index) {
        const row = document.createElement('tr');
        row.className = 'tpi-cc--table-tbody';
        
        const sortCount = courierData.ordersSorted > 0 
            ? courierData.ordersSorted 
            : (courierData.ordersShipped > 0 ? courierData.ordersShipped : 0);
            
        const sortPercent = courierData.ordersPlanned > 0 
            ? Math.round((sortCount / courierData.ordersPlanned) * 100)
            : 0;
            
        const preparedPercent = courierData.sortablesInCell > 0
            ? Math.round((courierData.sortablesPrepared / courierData.sortablesInCell) * 100)
            : 0;
        
        // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
        const sortColor = getProgressColor(sortPercent);
        const preparedColor = getProgressColor(preparedPercent);
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
        const startedDate = courierData.startedAt ? cc_formatDate(courierData.startedAt) : null;
        const startedTime = courierData.startedAt ? cc_formatTime(courierData.startedAt) : null;
        const endedDate = courierData.finishedAt ? cc_formatDate(courierData.finishedAt) : null;
        const endedTime = courierData.finishedAt ? cc_formatTime(courierData.finishedAt) : null;
        const arrivesDate = courierData.courierArrivesAt ? cc_formatDate(courierData.courierArrivesAt) : null;
        const arrivesTime = courierData.courierArrivesAt ? cc_formatTime(courierData.courierArrivesAt) : null;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∞—Ä—à—Ä—É—Ç–∞
        const routeStatusText = getRouteStatusText(courierData.status);
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –∏–∑ —è—á–µ–π–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "101" –∏–∑ "MK-101")
        let cellNumber = "000";
        if (courierData.cell && courierData.cell !== 'null' && courierData.cell !== '–ù–µ—Ç —è—á–µ–π–∫–∏') {
            const match = courierData.cell.match(/\d+/);
            cellNumber = match ? match[0].padStart(3, '0') : "000";
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫—É—Ä—å–µ—Ä –ö–ì–¢
        const isKGT = courierData.cell.toUpperCase().startsWith('KGT');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —è—á–µ–π–∫–∞ null
        const isNullCell = courierData.cell === 'null';
        
        // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∫–Ω–æ–ø–æ–∫ CART (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤, –Ω–µ –¥–ª—è null —è—á–µ–µ–∫)
        let cartButtonsHTML = '';
        if (!isNullCell && !isKGT) {
            // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤ - 4 –∫–Ω–æ–ø–∫–∏ CART
            for (let i = 1; i <= 4; i++) {
                const cartNumber = `${cellNumber}${i}`;
                cartButtonsHTML += `
                    <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-cart-id" tpi-data-courier-spec-cell="CART-${cartNumber}">
                        <i class="tpi-cc-table-tbody-data-cart-icon">${tpi_cc_i_cart}</i>
                        -${cartNumber}
                    </button>
                `;
            }
        }
        
        // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è CART (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
        const addCartButton = `
            <div class="tpi-cc--carts-control-buttons-wrapper">
                <button class="tpi-cc--table-tbody-add-cart" tpi-state-change="tpi-add-cart">
                    <i>${tpi_cc_i_cart_add}</i>
                </button>
            </div>
        `;
        
        // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –∫–Ω–æ–ø–æ–∫ PALLET (–¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤ –∏ –ö–ì–¢, –Ω–µ –¥–ª—è null —è—á–µ–µ–∫)
        let palletButtonsHTML = '';
        if (!isNullCell) {
            if (isKGT) {
                // –î–ª—è –ö–ì–¢ - –æ–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞ PALLET —Å –Ω–æ–º–µ—Ä–æ–º —è—á–µ–π–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1" –∏–∑ "KGT-1")
                const kgtNumber = courierData.cell.replace('KGT-', '').replace('kgt-', '');
                palletButtonsHTML += `
                    <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-pallet-id" tpi-data-courier-spec-cell="PALLET-${kgtNumber}">
                        <i class="tpi-cc-table-tbody-data-pallet-icon">${tpi_cc_i_pallet}</i>
                        -${kgtNumber}
                    </button>
                `;
            } else {
                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤ - 2 –∫–Ω–æ–ø–∫–∏ PALLET —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏
                const palletNumbers = generateRandomPalletNumbers(2, index);
                palletNumbers.forEach(palletNumber => {
                    palletButtonsHTML += `
                        <button class="tpi-cc--table-tbody-data-button tpi-cc-table-tbody-data-pallet-id" tpi-data-courier-spec-cell="PALLET-${palletNumber}">
                            <i class="tpi-cc-table-tbody-data-pallet-icon">${tpi_cc_i_pallet}</i>
                            -${palletNumber}
                        </button>
                    `;
                });
            }
        }
        
        // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è PALLET (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º)
        const addPalletButton = `
            <div class="tpi-cc--carts-control-buttons-wrapper">
                <button class="tpi-cc--table-tbody-add-pallet" tpi-state-change="tpi-add-pallet">
                    <i>${tpi_cc_i_cart_add}</i>
                </button>
            </div>
        `;
        
        row.innerHTML = `
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data-courier">
                    <div class="tpi-cc--sortable-data-wrapper tpi-cc--courier-id-data-wrapper">
                        <a href="https://logistics.market.yandex.ru/sorting-center/21972131/routes?type=OUTGOING_COURIER&sort=&hasCarts=false&category=COURIER&id=21972131&page=1&pageSize=50&recipientName=${courierData.externalId}" target="_blank" class="tpi-cc--table-tbody-data-link">
                            <i>${tpi_cc_i_courier}</i>
                            <p class="tpi-cc--sortable-data-courier" tpi-cc-parsing-data="courier-full-name">${courierData.courier}</p>
                        </a>
                        <div class="tpi-cc--table-tbody-data-courier-extra-info-wrapper">
                            <div class="tpi-cc--table-tbody-data-courier-extra-info">
                                <i>${tpi_cc_i_courier_route_id}</i>
                                <p tpi-cc-parsing-data="courier-route-id">${courierData.routeId || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                            </div>
                            <div class="tpi-cc--table-tbody-data-courier-extra-info">
                                <i>${tpi_cc_i_courier_id}</i>
                                <p tpi-cc-parsing-data="courier-personal-id">${courierData.externalId || courierData.courierId || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data">
                    <a href="https://logistics.market.yandex.ru/sorting-center/21972131/sortables?sortableTypes=CART&sortableTypes=COURIER_PALLET&cellName=${courierData.cell}" class="tpi-cc--table-tbody-data-link" tpi-cc-parsing-data="courier-route-cell" target="_blank">
                        ${courierData.cell}
                    </a>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-carts">
                    ${cartButtonsHTML}
                    ${addCartButton}
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-pallets">
                    ${palletButtonsHTML}
                    ${addPalletButton}
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data">
                    <div class="tpi-cc-table-tbody-data-route-status" tpi-cc-route-status="${courierData.status.toLowerCase()}">
                        <i></i>
                        <p tpi-cc-parsing-data="courier-route-status">${routeStatusText}</p>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-sort-progress-container">
                        <p class="tpi-cc--table-tbody-data-sort-progress" tpi-cc-parsing-data="courier-sorting-progress">
                            ${sortCount} –∏–∑ ${courierData.ordersPlanned || 0}
                        </p>
                    <div class="tpi-cc--table-tbody-data-sort-progress-circle-wrapper">
                        <p class="tpi-cc--table-tbody-data-sort-progress-circle-value" tpi-cc-parsing-data="courier-sorting-progress-percent">
                            ${sortPercent}%
                        </p>
                        <svg width="50" height="50" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(-90deg)">
                            <circle cx="25" cy="25" r="20" fill="transparent" stroke="#e8e8e8" stroke-width="4"></circle>
                            <circle cx="25" cy="25" r="20" fill="transparent" 
                                    stroke="${sortColor}" stroke-width="5" stroke-linecap="round"
                                    stroke-dasharray="125.6" 
                                    stroke-dashoffset="${125.6 - (125.6 * sortPercent / 100)}"
                                    tpi-cc-parsing-data="courier-sorting-progress-circle">
                            </circle>
                        </svg>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-data-sort-progress-container">
                    <p class="tpi-cc--table-tbody-data-sort-progress" tpi-cc-parsing-data="courier-prepared-progress">
                        ${courierData.sortablesPrepared || 0} –∏–∑ ${courierData.sortablesInCell || 0}
                    </p>
                    <div class="tpi-cc--table-tbody-data-sort-progress-circle-wrapper">
                        <p class="tpi-cc--table-tbody-data-sort-progress-circle-value" tpi-cc-parsing-data="courier-prepared-progress-percent">
                            ${preparedPercent}%
                        </p>
                        <svg width="50" height="50" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(-90deg)">
                            <circle cx="25" cy="25" r="20" fill="transparent" stroke="#e8e8e8" stroke-width="4"></circle>
                            <circle cx="25" cy="25" r="20" fill="transparent" 
                                    stroke="${preparedColor}" stroke-width="5" stroke-linecap="round"
                                    stroke-dasharray="125.6" 
                                    stroke-dashoffset="${125.6 - (125.6 * preparedPercent / 100)}"
                                    tpi-cc-parsing-data="courier-prepared-progress-circle">
                            </circle>
                        </svg>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-body-date-container">
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_calendar}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-date-type="start" tpi-cc-parsing-data="courier-started-at-date">
                            ${startedDate || 'null'}
                        </p>
                    </div>
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_clock}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-time-type="start" tpi-cc-parsing-data="courier-started-at-time">
                            ${startedTime || 'null'}
                        </p>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-body-date-container">
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_calendar}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-date-type="end" tpi-cc-parsing-data="courier-ended-at-date">
                            ${endedDate || 'null'}
                        </p>
                    </div>
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_clock}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-time-type="end" tpi-cc-parsing-data="courier-ended-at-time">
                            ${endedTime || 'null'}
                        </p>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-body-date-container">
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_calendar}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-date-type="arrived" tpi-cc-parsing-data="courier-arrives-at-date">
                            ${arrivesDate || 'null'}
                        </p>
                    </div>
                    <div class="tpi-cc--table-tbody-data tpi-cc--table-tbody-date-wrapper">
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_clock}</i>
                        <p class="tpi-cc--table-tbody-data-courier-status" tpi-cc-time-type="arrived" tpi-cc-parsing-data="courier-arrives-at-time">
                            ${arrivesTime || 'null'}
                        </p>
                    </div>
                </div>
            </td>
            <td class="tpi-cc--table-tbody-item">
                <div class="tpi-cc--table-body-print-container">
                    <button class="tpi-cc--print-current-row">
                        <p class="tpi-cc--table-tbody-data-courier-print-text">–ü–µ—á–∞—Ç—å</p>
                        <i class="tpi-cc--table-tbody-data-icon">${tpi_cc_i_courier_print}</i>
                    </button>
                </div>
            </td>
        `;
        
        return row;
    }

    function getProgressColor(percent) {
        let r, g, b;
        
        if (percent <= 50) {
            const ratio = percent / 50;
            r = Math.floor(255);
            g = Math.floor(ratio * 204);
            b = 0;
        } else {
            const ratio = (percent - 50) / 50;
            r = Math.floor(255 - (255 - 42) * ratio);
            g = Math.floor(204 + (173 - 204) * ratio);
            b = Math.floor(0 + 46 * ratio);
        }
        return `rgb(${r}, ${g}, ${b})`;
    }

    function generateRandomPalletNumbers(count, seed) {
    const numbers = [];
    const usedNumbers = new Set();
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º seed –¥–ª—è –ø—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏, –Ω–æ —Ä–∞–∑–Ω–æ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞
    const baseSeed = seed * 9301 + 49297; // –ü—Ä–æ—Å—Ç—ã–µ —á–∏—Å–ª–∞ –¥–ª—è –ª—É—á—à–µ–π —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
    
    for (let i = 0; i < count; i++) {
        let number;
        let attempts = 0;
        
        do {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç 100 –¥–æ 999
            const random = (baseSeed * (i + 1) * 233 + 741) % 900;
            number = 100 + random;
            attempts++;
            
            // –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –∑–∞ 10 –ø–æ–ø—ã—Ç–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª–µ–¥—É—é—â–µ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ
            if (attempts > 10) {
                number = 100 + ((baseSeed + i) % 900);
                while (usedNumbers.has(number) && number < 999) {
                    number++;
                }
            }
        } while (usedNumbers.has(number) && number >= 100 && number <= 999);
        
        numbers.push(number);
        usedNumbers.add(number);
    }
    
    return numbers;
}

    function updateLoadingStatus(stepId, status) {
        const loadingItem = document.querySelector(`[tpi-cc-search-id="${stepId}"]`);
        if (loadingItem) {
            loadingItem.setAttribute('tpi-cc-status', status);
        }
    }

    function cc_formatDate(dateString) {
        if (!dateString || dateString === 'null') return null;

        try {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã:', e);
            return null;
        }
    }

    function cc_formatTime(dateString) {
        if (!dateString || dateString === 'null') return null;

        try {
            const date = new Date(dateString);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:', e);
            return null;
        }
    }
    function getRouteStatusText(status) {
        switch(status) {
            case 'CELL_SHIPPED':
                return '–ü–µ—Ä–µ–¥–∞–Ω–æ –∫—É—Ä—å–µ—Ä—É';
            case 'FINISHED':
                return '–°–æ–±—Ä–∞–Ω';
            case 'IN_PROGRESS':
                return '–í —Ä–∞–±–æ—Ç–µ';
            case 'NOT_STARTED':
                return '–ù–µ –Ω–∞—á–∞—Ç';
            case 'SHIPPED':
                return '–û—Ç–≥—Ä—É–∂–µ–Ω';
            default:
                return status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }
    }
}


function tpi_cc_filteringColumnData() {
    const table = document.querySelector('table.tpi-cc--table-data-output');
    if (!table) {
        tpiNotification.show('–û—à–∏–±–∫–∞', "error", "–ù–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ —Ç–∞–±–ª–∏—Ü—É");
        return;
    }
    
    table.addEventListener('click', (event) => {
        const headerItem = event.target.closest('.tpi-cc--table-thead-item');
        if (!headerItem) return;
        if (headerItem.hasAttribute('tpi-cc-filters-not-allowed')) {
            return;
        }
        
        const targetDiv = headerItem.querySelector('div.tpi-cc--table-thead-data');
        if (!targetDiv) return;
        
        const currentState = targetDiv.getAttribute('tpi-current-state');
        let nextState = null;
        
        if (!currentState) {
            nextState = 'filtered-down';
        } else if (currentState === 'filtered-down') {
            nextState = 'filtered-up';
        }
        
        document.querySelectorAll('div.tpi-cc--table-thead-data[tpi-current-state]').forEach(div => {
            div.removeAttribute('tpi-current-state');
        });
        
        document.querySelectorAll('td.tpi-cc--table-tbody-item[tpi-current-state]').forEach(td => {
            td.removeAttribute('tpi-current-state');
        });
        
        if (nextState) {
            targetDiv.setAttribute('tpi-current-state', nextState);
            
            const thIndex = Array.from(headerItem.parentElement.children).indexOf(headerItem);
            
            const tableBodyRows = table.querySelectorAll('tbody tr');
            
            tableBodyRows.forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('td.tpi-cc--table-tbody-item');
                if (cells.length > thIndex) {
                    const cell = cells[thIndex];
                    
                    if (rowIndex === tableBodyRows.length - 1) {
                        cell.setAttribute('tpi-current-state', 'filtered-last');
                    } else {
                        cell.setAttribute('tpi-current-state', 'filtered');
                    }
                }
            });
        }
    });
}

function toggle_ActionProcessContainer(state){
    const actionProcessContainer = document.querySelector('.tpi-cc-process-manager-wrapper');
    
    if (!actionProcessContainer) {
        console.error('–≠–ª–µ–º–µ–Ω—Ç .tpi-cc-process-manager-wrapper –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    const actionAttributeState = actionProcessContainer.getAttribute('tpi-current-state');
    
    if (state === "show" && actionAttributeState === 'hidden') {
        actionProcessContainer.style.display = 'flex';
        setTimeout(() => {
            actionProcessContainer.setAttribute('tpi-current-state', 'shown');
        }, 2);
    } else if (state === "hide" && actionAttributeState === 'shown') {
        actionProcessContainer.setAttribute('tpi-current-state', 'hidden');
        setTimeout(() => {
            actionProcessContainer.style.display = 'none';
        }, 400);
    }
}

function update_ActionProcessContainer(){
    const tpi_cc_selected_carts = document.querySelector('div.tpi-cc-process-data-item:has(p.tpi-cc-process-data-item-text.tpi-cc-data-cart-amount)');
    const tpi_cc_selected_pallets = document.querySelector('div.tpi-cc-process-data-item:has(p.tpi-cc-process-data-item-text.tpi-cc-data-pallet-amount)');
    const tpi_cc_selected_data_carts = document.querySelector('p.tpi-cc-process-data-item-text.tpi-cc-data-cart-amount span');
    const tpi_cc_selected_data_pallets = document.querySelector('p.tpi-cc-process-data-item-text.tpi-cc-data-pallet-amount span');

    const tpi_cc_actionButtons = document.querySelectorAll('.tpi-cc-table-tbody-data-cart-id, .tpi-cc-table-tbody-data-pallet-id');
    
    let hasSelected = false;
    let tpi_cc_cart_amount = document.querySelectorAll('.tpi-cc-table-tbody-data-cart-id[tpi-cc-selected-courier-cell]');
    let tpi_cc_pallet_amount = document.querySelectorAll('.tpi-cc-table-tbody-data-pallet-id[tpi-cc-selected-courier-cell]');
    
    if (tpi_cc_selected_data_carts) {
        tpi_cc_selected_data_carts.innerText = tpi_cc_cart_amount.length;
        
        if (tpi_cc_cart_amount.length > 0) {
            tpi_cc_selected_data_carts.style.color = '#fc0';
            tpi_cc_selected_carts.style.height = '.8rem'
            tpi_cc_selected_carts.style.opacity = '1'
        } else {
            tpi_cc_selected_data_carts.style.color = '';
            tpi_cc_selected_carts.style.height = '0rem'
            tpi_cc_selected_carts.style.opacity = '0'
        }
    }
    
    if (tpi_cc_selected_data_pallets) {
        tpi_cc_selected_data_pallets.innerText = tpi_cc_pallet_amount.length;
        
        if (tpi_cc_pallet_amount.length > 0) {
            tpi_cc_selected_data_pallets.style.color = '#fc0';
            tpi_cc_selected_pallets.style.height = '.8rem'
            tpi_cc_selected_pallets.style.opacity = '1'
        } else {
            tpi_cc_selected_data_pallets.style.color = '';
            tpi_cc_selected_pallets.style.height = '0rem'
            tpi_cc_selected_pallets.style.opacity = '0'
        }
    }
    
    tpi_cc_actionButtons.forEach(button => {
        if (button.hasAttribute('tpi-cc-selected-courier-cell')) {
            hasSelected = true;
        }
    });
    
    if (hasSelected) {
        toggle_ActionProcessContainer("show");
    } else {
        toggle_ActionProcessContainer("hide");
    }
}