const tpiIcon__altLink = `
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M432,320H400a16,16,0,0,0-16,16V448H64V128H208a16,16,0,0,0,16-16V80a16,16,0,0,0-16-16H48A48,48,0,0,0,0,112V464a48,48,0,0,0,48,48H400a48,48,0,0,0,48-48V336A16,16,0,0,0,432,320ZM488,0h-128c-21.37,0-32.05,25.91-17,41l35.73,35.73L135,320.37a24,24,0,0,0,0,34L157.67,377a24,24,0,0,0,34,0L435.28,133.32,471,169c15,15,41,4.5,41-17V24A24,24,0,0,0,488,0Z"></path>
    </svg>
`
const tpiIcon__box = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="12px" width="12px" xmlns="http://www.w3.org/2000/svg">
    <path d="M50.7 58.5L0 160l208 0 0-128L93.7 32C75.5 32 58.9 42.3 50.7 58.5zM240 160l208 0L397.3 58.5C389.1 42.3 372.5 32 354.3 32L240 32l0 128zm208 32L0 192 0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-224z"></path>
</svg>
`
const tpiIcon__pallet = `
<svg class="tpi-infi--icon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 640 512" height="12px" width="12px" xmlns="http://www.w3.org/2000/svg">
    <path d="M144 256h352c8.8 0 16-7.2 16-16V16c0-8.8-7.2-16-16-16H384v128l-64-32-64 32V0H144c-8.8 0-16 7.2-16 16v224c0 8.8 7.2 16 16 16zm480 128c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h48v64H16c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h608c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16h-48v-64h48zm-336 64H128v-64h160v64zm224 0H352v-64h160v64z"></path>
</svg>
`
const tpiIcon__person = `
<svg class="tpi-infi--icon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M256 256a112 112 0 1 0-112-112 112 112 0 0 0 112 112zm0 32c-69.42 0-208 42.88-208 128v64h416v-64c0-85.12-138.58-128-208-128z"></path>
</svg>
`
const tpiIcon__phone = `
<svg class="tpi-infi--icon"  stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M347.1 24.6c7.7-18.6 28-28.5 47.4-23.2l88 24C499.9 30.2 512 46 512 64c0 247.4-200.6 448-448 448c-18 0-33.8-12.1-38.6-29.5l-24-88c-5.3-19.4 4.6-39.7 23.2-47.4l96-40c16.3-6.8 35.2-2.1 46.3 11.6L207.3 368c70.4-33.3 127.4-90.3 160.7-160.7L318.7 167c-13.7-11.2-18.4-30-11.6-46.3l40-96z"></path>
</svg>
`
const tpiIcon__inbounds = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16px" height="16px">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M5 3C6.30622 3 7.41746 3.83481 7.82929 5H10C12.2091 5 14 6.79086 14 9C14 11.2091 12.2091 13 10 13H7C5.34315 13 4 14.3431 4 16C4 17.6569 5.34315 19 7 19H13L15 21H7C4.23858 21 2 18.7614 2 16C2 13.2386 4.23858 11 7 11H10C11.1046 11 12 10.1046 12 9C12 7.89543 11.1046 7 10 7H7.82929C7.41746 8.16519 6.30622 9 5 9C3.34315 9 2 7.65685 2 6C2 4.34315 3.34315 3 5 3Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M17.5608 20.9961H18.4484C18.7487 20.192 19.5015 19.5618 20.1257 19.0568C20.3933 18.8404 20.6413 18.6397 20.8273 18.4502C21.3871 17.8811 21.7684 17.1554 21.9229 16.3652C22.0775 15.5751 21.9984 14.7559 21.6956 14.0116C21.3928 13.2673 20.88 12.6313 20.2221 12.1841C19.5642 11.737 18.7908 11.4989 18 11.5C17.2092 11.4989 16.4358 11.737 15.7779 12.1841C15.12 12.6313 14.6072 13.2673 14.3044 14.0116C14.0016 14.7559 13.9225 15.5751 14.0771 16.3652C14.2316 17.1554 14.6129 17.8811 15.1727 18.4502C15.359 18.6412 15.6088 18.8435 15.8786 19.0619C16.5011 19.5658 17.2566 20.2524 17.5608 20.9961Z"></path>
</svg>
`
const tpiIcon__truck = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 256 256" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M224,96.8V96a56.06,56.06,0,0,0-56-56h-8a16,16,0,0,0-16,16V176H128V72a8,8,0,0,0-8-8H16A16,16,0,0,0,0,80V184a32,32,0,0,0,56,21.13A32,32,0,0,0,111,192h82a32,32,0,0,0,63-8V136A40.07,40.07,0,0,0,224,96.8ZM32,200a16,16,0,1,1,16-16A16,16,0,0,1,32,200Zm48,0a16,16,0,1,1,16-16A16,16,0,0,1,80,200Zm144,0a16,16,0,1,1,16-16A16,16,0,0,1,224,200Z"></path>
</svg>
`
const tpiIcon__packages = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 576 512" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M248 0L208 0c-26.5 0-48 21.5-48 48l0 112c0 35.3 28.7 64 64 64l128 0c35.3 0 64-28.7 64-64l0-112c0-26.5-21.5-48-48-48L328 0l0 80c0 8.8-7.2 16-16 16l-48 0c-8.8 0-16-7.2-16-16l0-80zM64 256c-35.3 0-64 28.7-64 64L0 448c0 35.3 28.7 64 64 64l160 0c35.3 0 64-28.7 64-64l0-128c0-35.3-28.7-64-64-64l-40 0 0 80c0 8.8-7.2 16-16 16l-48 0c-8.8 0-16-7.2-16-16l0-80-40 0zM352 512l160 0c35.3 0 64-28.7 64-64l0-128c0-35.3-28.7-64-64-64l-40 0 0 80c0 8.8-7.2 16-16 16l-48 0c-8.8 0-16-7.2-16-16l0-80-40 0c-15 0-28.8 5.1-39.7 13.8c4.9 10.4 7.7 22 7.7 34.2l0 160c0 12.2-2.8 23.8-7.7 34.2C323.2 506.9 337 512 352 512z"></path>
</svg>
`
const tpiIcon__checkMark = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 48c110.532 0 200 89.451 200 200 0 110.532-89.451 200-200 200-110.532 0-200-89.451-200-200 0-110.532 89.451-200 200-200m140.204 130.267l-22.536-22.718c-4.667-4.705-12.265-4.736-16.97-.068L215.346 303.697l-59.792-60.277c-4.667-4.705-12.265-4.736-16.97-.069l-22.719 22.536c-4.705 4.667-4.736 12.265-.068 16.971l90.781 91.516c4.667 4.705 12.265 4.736 16.97.068l172.589-171.204c4.704-4.668 4.734-12.266.067-16.971z"></path>
</svg>
`
const tpiIcon__hourGlass = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M4.75 2h14.5a.75.75 0 0 1 0 1.5h-.75v2.982a4.75 4.75 0 0 1-2.215 4.017l-2.044 1.29a.25.25 0 0 0 0 .422l2.044 1.29a4.75 4.75 0 0 1 2.215 4.017V20.5h.75a.75.75 0 0 1 0 1.5H4.75a.75.75 0 0 1 0-1.5h.75v-2.982a4.75 4.75 0 0 1 2.215-4.017l2.044-1.29a.25.25 0 0 0 0-.422l-2.044-1.29A4.75 4.75 0 0 1 5.5 6.482V3.5h-.75a.75.75 0 0 1 0-1.5ZM17 3.5H7v2.982A3.25 3.25 0 0 0 8.516 9.23l2.044 1.29a1.75 1.75 0 0 1 0 2.96l-2.044 1.29A3.25 3.25 0 0 0 7 17.518V20.5h10v-2.982a3.25 3.25 0 0 0-1.516-2.748l-2.044-1.29a1.75 1.75 0 0 1 0-2.96l2.044-1.29A3.25 3.25 0 0 0 17 6.482Z"></path>
</svg>
`
const tpiIcon__graphLine = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path d="M15 13V14H1.5L1 13.5V0H2V13H15Z"></path><path d="M13 3.20714L7.85353 8.35359H7.14642L5.49998 6.70714L1.85353 10.3536L1.14642 9.64648L5.14642 5.64648H5.85353L7.49998 7.29293L12.6464 2.14648H13.3535L15.3535 4.14648L14.6464 4.85359L13 3.20714Z"></path>
</svg>
`
const tpiIcon__graphBar = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 14H15v-1H2V0H1v13.5l.5.5zM3 11.5v-8l.5-.5h2l.5.5v8l-.5.5h-2l-.5-.5zm2-.5V4H4v7h1zm6-9.5v10l.5.5h2l.5-.5v-10l-.5-.5h-2l-.5.5zm2 .5v9h-1V2h1zm-6 9.5v-6l.5-.5h2l.5.5v6l-.5.5h-2l-.5-.5zm2-.5V6H8v5h1z"></path>
</svg>
`
const tpiIcon__EAPP = `
<svg width="20px" height="20px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.18518 13.778H7.04218V17H8.14918C8.55718 17 8.91718 16.9415 9.22918 16.8245C9.54118 16.7045 9.78568 16.52 9.96268 16.271C10.1397 16.019 10.2282 15.698 10.2282 15.308C10.2282 15.014 10.1772 14.7695 10.0752 14.5745C9.97618 14.3765 9.83518 14.219 9.65218 14.102C9.46918 13.985 9.25318 13.9025 9.00418 13.8545C8.75518 13.8035 8.48218 13.778 8.18518 13.778ZM8.87818 16.001C8.72518 16.142 8.51068 16.2125 8.23468 16.2125H8.14918V14.5655H8.27518C8.44618 14.5655 8.59318 14.588 8.71618 14.633C8.84218 14.678 8.93968 14.756 9.00868 14.867C9.07768 14.978 9.11218 15.134 9.11218 15.335C9.11218 15.638 9.03418 15.86 8.87818 16.001Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M11.5645 16.946C11.7745 17.012 11.998 17.045 12.235 17.045C12.472 17.045 12.6955 17.009 12.9055 16.937C13.1185 16.862 13.306 16.754 13.468 16.613C13.63 16.472 13.7575 16.298 13.8505 16.091C13.9435 15.881 13.99 15.641 13.99 15.371C13.99 15.104 13.9435 14.87 13.8505 14.669C13.7575 14.465 13.63 14.294 13.468 14.156C13.306 14.018 13.1185 13.9145 12.9055 13.8455C12.6955 13.7735 12.472 13.7375 12.235 13.7375C11.995 13.7375 11.77 13.7765 11.56 13.8545C11.35 13.9295 11.1655 14.0405 11.0065 14.1875C10.8475 14.3315 10.723 14.5085 10.633 14.7185C10.543 14.9255 10.498 15.1625 10.498 15.4295C10.498 15.6995 10.543 15.935 10.633 16.136C10.726 16.337 10.852 16.505 11.011 16.64C11.173 16.775 11.3575 16.877 11.5645 16.946ZM12.685 16.0325C12.568 16.1645 12.418 16.2305 12.235 16.2305C12.061 16.2305 11.9155 16.1645 11.7985 16.0325C11.6815 15.9005 11.623 15.6875 11.623 15.3935C11.623 15.0965 11.6815 14.882 11.7985 14.75C11.9155 14.615 12.061 14.5475 12.235 14.5475C12.418 14.5475 12.568 14.615 12.685 14.75C12.802 14.882 12.8605 15.0965 12.8605 15.3935C12.8605 15.6875 12.802 15.9005 12.685 16.0325Z"></path><path d="M15.1643 16.8515C15.4553 16.9805 15.7958 17.045 16.1858 17.045C16.3628 17.045 16.5248 17.0315 16.6718 17.0045C16.8188 16.9805 16.9373 16.9445 17.0273 16.8965V16.1045C16.9433 16.1405 16.8353 16.1705 16.7033 16.1945C16.5713 16.2185 16.4438 16.2305 16.3208 16.2305C16.0298 16.2305 15.8003 16.1645 15.6323 16.0325C15.4673 15.8975 15.3848 15.6845 15.3848 15.3935C15.3848 15.0995 15.4673 14.885 15.6323 14.75C15.8003 14.615 16.0298 14.5475 16.3208 14.5475C16.4348 14.5475 16.5563 14.5595 16.6853 14.5835C16.8173 14.6075 16.9313 14.639 17.0273 14.678V13.886C16.9433 13.838 16.8278 13.802 16.6808 13.778C16.5338 13.751 16.3688 13.7375 16.1858 13.7375C15.7958 13.7375 15.4553 13.8035 15.1643 13.9355C14.8763 14.0675 14.6528 14.2565 14.4938 14.5025C14.3378 14.7485 14.2598 15.0455 14.2598 15.3935C14.2598 15.7385 14.3378 16.0355 14.4938 16.2845C14.6528 16.5305 14.8763 16.7195 15.1643 16.8515Z"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M10 2H14.5L20 7.5V16C20 17.8638 20 18.7956 19.6955 19.5307C19.2895 20.5108 18.5108 21.2895 17.5307 21.6955C16.7956 22 15.8638 22 14 22H10C8.13623 22 7.20435 22 6.46927 21.6955C5.48915 21.2895 4.71046 20.5108 4.30448 19.5307C4 18.7956 4 17.8638 4 16V8C4 6.13623 4 5.20435 4.30448 4.46927C4.71046 3.48915 5.48915 2.71046 6.46927 2.30448C7.20435 2 8.13623 2 10 2ZM12 4H10C9.04075 4 8.42148 4.00108 7.94752 4.03342C7.49152 4.06453 7.31786 4.11777 7.23463 4.15224C6.74458 4.35523 6.35523 4.74458 6.15224 5.23463C6.11777 5.31786 6.06453 5.49152 6.03342 5.94752C6.00108 6.42148 6 7.04075 6 8V16C6 16.9592 6.00108 17.5785 6.03342 18.0525C6.06453 18.5085 6.11777 18.6821 6.15224 18.7654C6.35523 19.2554 6.74458 19.6448 7.23463 19.8478C7.31786 19.8822 7.49152 19.9355 7.94752 19.9666C8.42148 19.9989 9.04075 20 10 20H14C14.9592 20 15.5785 19.9989 16.0525 19.9666C16.5085 19.9355 16.6821 19.8822 16.7654 19.8478C17.2554 19.6448 17.6448 19.2554 17.8478 18.7654C17.8822 18.6821 17.9355 18.5085 17.9666 18.0525C17.9989 17.5785 18 16.9592 18 16V10H17.4657C16.7959 10 16.2431 10 15.7905 9.96914C15.3212 9.93712 14.8871 9.86858 14.4693 9.69552C13.4892 9.28954 12.7105 8.51085 12.3045 7.53073C12.1314 7.11292 12.0629 6.67882 12.0309 6.20954C12 5.75693 12 5.20406 12 4.53427V4ZM17.6716 8L14 4.32843V4.5C14 5.21259 14.0005 5.69696 14.0262 6.0734C14.0513 6.44085 14.0969 6.63187 14.1522 6.76537C14.3552 7.25542 14.7446 7.64477 15.2346 7.84776C15.3681 7.90306 15.5591 7.9487 15.9266 7.97377C16.303 7.99946 16.7874 8 17.5 8H17.6716Z"></path>
</svg>
`

const tpiIcon__right_chevron = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 320 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z"></path>
</svg>
`
const tpiIcon__left_chevron = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 320 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l192 192c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256 246.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-192 192z"></path>
</svg>
`
const tpiIcon__playUpdate = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M424.4 214.7L72.4 6.6C43.8-10.3 0 6.1 0 47.9V464c0 37.5 40.7 60.1 72.4 41.3l352-208c31.4-18.5 31.5-64.1 0-82.6z"></path>
</svg>
`
const tpiIcon__pauseUpdate = `
<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 320 512" xmlns="http://www.w3.org/2000/svg">
    <path d="M48 64C21.5 64 0 85.5 0 112L0 400c0 26.5 21.5 48 48 48l32 0c26.5 0 48-21.5 48-48l0-288c0-26.5-21.5-48-48-48L48 64zm192 0c-26.5 0-48 21.5-48 48l0 288c0 26.5 21.5 48 48 48l32 0c26.5 0 48-21.5 48-48l0-288c0-26.5-21.5-48-48-48l-32 0z"></path>
</svg>
`
const tpiIcon__updateTable = `
<svg stroke="currentColor" fill="none" stroke-width="0" viewBox="0 0 15 15" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M1.90321 7.29677C1.90321 10.341 4.11041 12.4147 6.58893 12.8439C6.87255 12.893 7.06266 13.1627 7.01355 13.4464C6.96444 13.73 6.69471 13.9201 6.41109 13.871C3.49942 13.3668 0.86084 10.9127 0.86084 7.29677C0.860839 5.76009 1.55996 4.55245 2.37639 3.63377C2.96124 2.97568 3.63034 2.44135 4.16846 2.03202L2.53205 2.03202C2.25591 2.03202 2.03205 1.80816 2.03205 1.53202C2.03205 1.25588 2.25591 1.03202 2.53205 1.03202L5.53205 1.03202C5.80819 1.03202 6.03205 1.25588 6.03205 1.53202L6.03205 4.53202C6.03205 4.80816 5.80819 5.03202 5.53205 5.03202C5.25591 5.03202 5.03205 4.80816 5.03205 4.53202L5.03205 2.68645L5.03054 2.68759L5.03045 2.68766L5.03044 2.68767L5.03043 2.68767C4.45896 3.11868 3.76059 3.64538 3.15554 4.3262C2.44102 5.13021 1.90321 6.10154 1.90321 7.29677ZM13.0109 7.70321C13.0109 4.69115 10.8505 2.6296 8.40384 2.17029C8.12093 2.11718 7.93465 1.84479 7.98776 1.56188C8.04087 1.27898 8.31326 1.0927 8.59616 1.14581C11.4704 1.68541 14.0532 4.12605 14.0532 7.70321C14.0532 9.23988 13.3541 10.4475 12.5377 11.3662C11.9528 12.0243 11.2837 12.5586 10.7456 12.968L12.3821 12.968C12.6582 12.968 12.8821 13.1918 12.8821 13.468C12.8821 13.7441 12.6582 13.968 12.3821 13.968L9.38205 13.968C9.10591 13.968 8.88205 13.7441 8.88205 13.468L8.88205 10.468C8.88205 10.1918 9.10591 9.96796 9.38205 9.96796C9.65819 9.96796 9.88205 10.1918 9.88205 10.468L9.88205 12.3135L9.88362 12.3123C10.4551 11.8813 11.1535 11.3546 11.7585 10.6738C12.4731 9.86976 13.0109 8.89844 13.0109 7.70321Z" fill="currentColor"></path>
</svg>
`

let autoUpdateCalled = false;
let autoUpdateInterval = null;
let autoUpdateTimer = null;
let autoUpdateTimeLeft = 10;
let isUpdating = false;
let previousStatistics = null;

// Функция для форматирования даты (24 сентября)
function formatDate(dateString) {
    const date = new Date(dateString);
    const months = [
        'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
        'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
    ];
    return `${date.getDate()} ${months[date.getMonth()]}`;
}

function getShipmentStatus(shipment) {
    if (!shipment) return { state: 'unknown', text: 'null' };
    
    const isArrived = shipment.status === 'IN_PROGRESS' && 
                     shipment.acceptance?.place?.accepted >= 15;

    const isIncomingButSMTHaccepted = shipment.status === 'IN_PROGRESS' && 
                     shipment.acceptance?.place?.accepted < 15;
    
    const statusMap = {
        arrived: { state: 'arived', text: 'Прибыл', condition: isArrived },
        signed: { state: 'signed', text: 'Подписан', condition: shipment.status === 'SIGNED' },
        fixed: { state: 'fixed', text: 'Зафиксирован', condition: shipment.status === 'FIXED' },
        created: { state: 'incoming', text: 'В пути', condition: shipment.status === 'CREATED' },
        createdSomeAccepted: { state: 'createdSomeAccepted', text: 'В пути', condition: isIncomingButSMTHaccepted}
    };
    
    const foundStatus = Object.values(statusMap).find(item => item.condition);
    return foundStatus || { state: 'unknown', text: 'null' };
}

// Функция для инициализации переключателя дат
function initDateSwitcher() {
    const selectedDateElement = document.querySelector('.tpi-infi--selected-date');
    const prevButton = document.querySelector('.tpi-infi--switch-date-button[tpi-infi--change-date="prev"]');
    const nextButton = document.querySelector('.tpi-infi--switch-date-button[tpi-infi--change-date="next"]');
    
    if (!selectedDateElement || !prevButton || !nextButton) return;
    
    // Получаем текущую дату или используем сохраненную
    let currentDate = window.currentSelectedDate ? new Date(window.currentSelectedDate) : new Date();
    
    function updateDateDisplay() {
        const day = currentDate.getDate();
        const month = currentDate.getMonth();
        const year = currentDate.getFullYear();
        
        const months = [
            'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
            'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
        ];
        
        selectedDateElement.textContent = `${day} ${months[month]} ${year}`;
        
        // Проверяем, является ли выбранная дата сегодняшней
        const today = new Date();
        const isToday = currentDate.toDateString() === today.toDateString();
        
        // Блокируем кнопку "вперед" если выбрана сегодняшняя дата
        nextButton.disabled = isToday;
        
        // Сохраняем текущую дату
        window.currentSelectedDate = currentDate.toISOString().split('T')[0];
    }
    
    function animateDateChanging(animationStage) {
        const selectedDateElement = document.querySelector('.tpi-infi--selected-date');
        if (!selectedDateElement) return;
    
        // Сбрасываем предыдущую анимацию
        selectedDateElement.style.animation = 'none';
        selectedDateElement.offsetHeight; // Принудительный reflow
        selectedDateElement.style.animation = null;
    
        if (animationStage === 'loading') {
            // Анимация загрузки
            selectedDateElement.setAttribute("tpi-changing-date", "loading");
        } else if (animationStage === 'complete') {
            // Анимация успешного завершения
            selectedDateElement.setAttribute("tpi-changing-date", "complete");
            
            // Сбрасываем анимацию после завершения
            setTimeout(() => {
                selectedDateElement.setAttribute("tpi-changing-date", "unset");
            }, 1000);
        } else if (animationStage === 'error') {
            // Анимация ошибки
            selectedDateElement.setAttribute("tpi-changing-date", "error");
            
            // Сбрасываем анимацию после завершения
            setTimeout(() => {
                selectedDateElement.setAttribute("tpi-changing-date", "unset");
            }, 1000);
        } else if (animationStage === 'unset') {
            // Сброс анимации
            selectedDateElement.setAttribute("tpi-changing-date", "unset");
        }
    }

    function changeDate(direction) {
        const newDate = new Date(currentDate);
        
        if (direction === 'prev') {
            newDate.setDate(newDate.getDate() - 1);
        } else if (direction === 'next') {
            newDate.setDate(newDate.getDate() + 1);
        }
        
        // Проверяем, не пытаемся ли перейти в будущее
        const today = new Date();
        if (direction === 'next' && newDate > today) {
            return;
        }
        
        currentDate = newDate;
        updateDateDisplay();
        
        // Сбрасываем предыдущую анимацию и запускаем новую
        animateDateChanging('unset'); // Сначала сбрасываем
        setTimeout(() => {
            animateDateChanging('loading'); // Затем запускаем новую
        }, 1);
        
        // Сбрасываем предыдущий таймер и устанавливаем новый
        clearTimeout(window.dateChangeTimeout);
        window.dateChangeTimeout = setTimeout(() => {
            updateTableData();
        }, 1500);
    }
    // Обработчики событий для кнопок
    prevButton.addEventListener('click', () => changeDate('prev'));
    nextButton.addEventListener('click', () => changeDate('next'));
    
    // Инициализация отображения
    updateDateDisplay();
}

// Модифицируем функцию updateTableData чтобы она управляла завершающей анимацией
const originalUpdateTableData = window.updateTableData;

window.updateTableData = async function() {
    const selectedDateElement = document.querySelector('.tpi-infi--selected-date');
    
    // Сохраняем текущую статистику перед обновлением
    const currentStatistics = calculateStatisticsFromTable();
    if (currentStatistics.totalShipments > 0) {
        previousStatistics = currentStatistics;
    }
    
    try {
        // Вызываем оригинальную функцию
        await originalUpdateTableData();
        
        // ТОЛЬКО после успешной вставки данных показываем анимацию complete
        if (selectedDateElement) {
            // Сначала сбрасываем предыдущую анимацию
            selectedDateElement.setAttribute("tpi-changing-date", "unset");
            
            // Запускаем анимацию complete
            setTimeout(() => {
                selectedDateElement.setAttribute("tpi-changing-date", "complete");
            }, 1);
        }
        
    } catch (error) {
        // В случае ошибки показываем анимацию error
        if (selectedDateElement) {
            // Сначала сбрасываем предыдущую анимацию
            selectedDateElement.setAttribute("tpi-changing-date", "unset");
            
            // Запускаем анимацию error
            setTimeout(() => {
                selectedDateElement.setAttribute("tpi-changing-date", "error");
            }, 50);
        }
        throw error;
    }
}

function getDriverStatus(shipments) {
    if (!shipments || shipments.length === 0) return { state: 'unknown', text: 'null' };
    
    const statusPriority = {
        'signed': 5,
        'fixed': 4,
        'arived': 3,
        'createdSomeAccepted': 2,
        'incoming': 1,
        'unknown': 0
    };
    
    let highestPriorityStatus = { state: 'unknown', text: 'null', priority: 0 };
    
    for (const shipment of shipments) {
        const status = getShipmentStatus(shipment);
        const priority = statusPriority[status.state] || 0;
        
        if (priority > highestPriorityStatus.priority) {
            highestPriorityStatus = { ...status, priority };
        }
    }
    
    return highestPriorityStatus;
}

// Функция для форматирования времени (09:00 — 10:00)
function formatTime(startString, finishString) {
    const startTime = new Date(startString);
    const finishTime = new Date(finishString);
    
    const formatTimePart = (date) => {
        return date.toTimeString().slice(0, 5);
    };
    
    return `${formatTimePart(startTime)} — ${formatTimePart(finishTime)}`;
}

// Функция для получения первой части ФИО (до первого пробела)
function getFirstName(fullName) {
    return fullName ? fullName.split(' ')[0] : '';
}

async function fetchShipmentsToTable() {
    try {
        // Используем выбранную дату или текущую
        const selectedDate = window.currentSelectedDate ? new Date(window.currentSelectedDate) : new Date();
        const year = selectedDate.getFullYear();
        const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
        const day = String(selectedDate.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        const url = `https://hubs.market.yandex.ru/api/gateway/logpoint/21972131/inbounds/get-list?platformType=SORTING_CENTER&courierQuery=&dateFrom=${dateString}&dateTo=${dateString}&movementTypes=LINEHAUL&statuses=ARRIVED%2CIN_PROGRESS%2CSIGNED%2CFIXED%2CCREATED&types=&page=0&size=100`;
        // const url = `https://hubs.market.yandex.ru/api/gateway/logpoint/21972131/inbounds/get-list?platformType=SORTING_CENTER&dateFrom=${dateString}&dateTo=${dateString}&movementTypes=LINEHAUL&statuses=ARRIVED%2CIN_PROGRESS%2CSIGNED%2CFIXED%2CCREATED`;
        // const url = `https://hubs.market.yandex.ru/api/gateway/logpoint/21972131/inbounds/get-list?platformType=SORTING_CENTER&dateFrom=2025-09-25&dateTo=2025-09-25&movementTypes=LINEHAUL&statuses=ARRIVED%2CIN_PROGRESS%2CSIGNED%2CFIXED%2CCREATED`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Города для исключения
        const excludedCities = ['Липецк', 'Курск', 'Белгород'];
        
        // Находим tbody для вставки данных
        const tbody = document.querySelector('.tpi-infi--table--tbody');
        if (!tbody) {
            return;
        }
        
        // Очищаем существующие данные и показываем прелоадер
        tbody.innerHTML = '<tr class="tpi-infi--table-preloader"><td colspan="9" style="text-align: center; padding: 20px;">Загрузка данных...</td></tr>';
        
        // Переменные для статистики
        let totalShipments = 0;
        let totalPlaces = 0;
        
        // Собираем все промисы для загрузки данных водителей
        const shipmentPromises = [];
        const processedShipments = new Set(); // Для отслеживания уникальных поставок
        
        // Обрабатываем каждую поставку
        for (let i = 0; i < data.content.length; i++) {
            const shipment = data.content[i];
            
            // Проверяем на дубликаты по externalId
            if (processedShipments.has(shipment.externalId)) {
                continue;
            }
            processedShipments.add(shipment.externalId);
            
            // Проверяем время arrival planned start
            if (shipment.arrival && shipment.arrival.planned && shipment.arrival.planned.start) {
                const plannedStartTime = shipment.arrival.planned.start;
                const plannedDate = new Date(plannedStartTime);
                const hour = plannedDate.getHours();
                
                // Пропускаем поставки с временем после 19:00
                if (hour > 19) {
                    continue;
                }
            }
            
            // Проверяем название поставщика на наличие исключенных городов
            if (shipment.supplierName) {
                const shouldExclude = excludedCities.some(city => 
                    shipment.supplierName.includes(city)
                );
                
                if (shouldExclude) {
                    continue;
                }
            }
            
            // Проверяем acceptance place total и lot total
            const placeTotal = shipment.acceptance?.place?.total || 0;
            const lotTotal = shipment.acceptance?.lot?.total || 0;
            
            if (placeTotal === 0 && lotTotal === 0) {
                continue;
            }
            
            // Увеличиваем счетчики
            totalShipments++;
            totalPlaces += placeTotal;
            
            // Создаем промис для загрузки данных водителя и формирования строки
            const shipmentPromise = (async () => {
                // Получаем данные водителя
                let driverName = 'Не указано';
                let driverPhone = 'Не указан';
                
                if (shipment.courier?.nameId && shipment.courier?.phoneId) {
                    try {
                        const driverData = await fetchDriverInfo(shipment.courier.nameId, shipment.courier.phoneId);
                        driverName = driverData.name || 'Не указано';
                        driverPhone = driverData.phone || 'Не указан';
                    } catch (error) {
                        console.error('Ошибка загрузки данных водителя:', error);
                    }
                }
                
                return {
                    shipment,
                    driverName,
                    driverPhone
                };
            })();
            
            shipmentPromises.push(shipmentPromise);
        }
        
        // Ждем загрузки всех данных
        const shipmentsData = await Promise.all(shipmentPromises);
        
        // ФИЛЬТРАЦИЯ: Убираем водителей без имени и номера машины
        const validShipmentsData = filterValidShipments(shipmentsData);
        
        // Группируем поставки по водителям
        const groupedByDriver = {};
        validShipmentsData.forEach(data => {
            const driverKey = data.driverName + '|' + data.driverPhone;
            if (!groupedByDriver[driverKey]) {
                groupedByDriver[driverKey] = [];
            }
            groupedByDriver[driverKey].push(data);
        });
        
        // ФИЛЬТРАЦИЯ: Убираем группы с невалидными водителями
        const validDriverGroups = filterValidDriverGroups(groupedByDriver);
        
        // Формируем HTML строк для таблицы
        const rowsHTML = [];
        
        for (const driverKey in validDriverGroups) {
            const driverShipments = validDriverGroups[driverKey];
            const isMultiple = driverShipments.length > 1;
            const firstShipment = driverShipments[0];
            
            // Вычисляем суммарные значения для группированных поставок
            let totalPlacesSum = 0;
            let totalLotsSum = 0;
            
            driverShipments.forEach(data => {
                totalPlacesSum += data.shipment.acceptance?.place?.total || 0;
                totalLotsSum += data.shipment.acceptance?.lot?.total || 0;
            });
            
            if (isMultiple) {
                // Группированная строка для нескольких поставок одного водителя
                
                // Получаем статус водителя на основе всех его поставок
                const driverShipmentsData = driverShipments.map(data => data.shipment);
                const driverStatus = getDriverStatus(driverShipmentsData);
                
                let rowHTML = `
                    <tr multiple-inbound-driver="true">
                        <td class="tpi-infi--table-suplier tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка поставщиков
                driverShipments.forEach((data, index) => {
                    rowHTML += `<div>${shortenSupplierName(data.shipment.supplierName) || 'Не указан'}</div>`;
                });
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-driver tpi-infi--table-multiple-inbounds-driver">
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>
                                        ${tpiIcon__person}${firstShipment.driverName}
                                        <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/inbounds?courierQuery=${encodeURIComponent(getFirstName(firstShipment.driverName))}&statuses=ARRIVED%2CIN_PROGRESS%2CSIGNED%2CFIXED%2CCREATED">${tpiIcon__altLink}</a>
                                    </p>
                                    <p class="tpi-infi--table-driver-phone">${tpiIcon__phone}${firstShipment.driverPhone}</p>
                                    <p>
                                        <i class="tpi-infi--table-inbound-status" current-state="${driverStatus.state}"></i>${driverStatus.text}
                                    </p>
                                </span>
                            </div>
                        </td>
                `;
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-orders-data tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка поставок/перемещений
                driverShipments.forEach(data => {
                    rowHTML += `
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>
                                        ${data.shipment.externalId}
                                        <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/inbounds?externalIdQuery=${encodeURIComponent(data.shipment.externalId)}">${tpiIcon__altLink}</a>
                                    </p>
                                    <p>${data.shipment.transportationId || 'Не указан'}</p>
                                </span>
                            </div>
                    `;
                });
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-orders-data tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка посылок принято/план
                driverShipments.forEach(data => {
                    rowHTML += `
                            <div>
                                <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/sortables?inboundIdTitle=${data.shipment.externalId}&sortableStatuses=&sortableStatusesLeafs=" class="tpi-infi--inbound-incom-data tpi-infi--table-orders-data">${tpiIcon__box}${data.shipment.acceptance?.place?.accepted || 0} / ${data.shipment.acceptance?.place?.total || 0}</a>
                            </div>
                    `;
                });
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-lots-data tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка лотов принято/план
                driverShipments.forEach(data => {
                    rowHTML += `
                            <div>
                                <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/sortables?inboundIdTitle=${data.shipment.externalId}&sortableStatuses=&sortableStatusesLeafs=&sortableTypes=DROP_PALLET&sortableTypes=ORPHAN_PALLET&sortableTypes=PALLET&sortableTypes=XDOC_PALLET" class="tpi-infi--inbound-incom-data">${tpiIcon__pallet}${data.shipment.acceptance?.lot?.accepted || 0} / ${data.shipment.acceptance?.lot?.total || 0}</a>
                            </div>
                    `;
                });
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-combined-orders-data tpi-infi--table-multiple-inbounds-part-left">
                            <div>
                                <p>${totalPlacesSum}</p>
                            </div>
                        </td>
                        <td class="tpi-infi--table-combined-lots-data">
                            <div>
                                <p>${totalLotsSum}</p>
                            </div>
                        </td>
                        <td class="tpi-infi--table-income-date tpi-infi--table-multiple-inbounds-part-right">
                `;
                
                // Колонка прибытия
                    rowHTML += `
                    <div>
                        <span class="tpi-infi--table-data-wrapper">
                            <p class="tpi-infi-arival-planned-day">${firstShipment.shipment.arrival?.planned?.finish ? formatDate(firstShipment.shipment.arrival.planned.finish) : 'Не указано'}</p>
                            <p class="tpi-infi-arival-planned-time">${firstShipment.shipment.arrival?.planned?.start && firstShipment.shipment.arrival?.planned?.finish ? formatTime(firstShipment.shipment.arrival.planned.start, firstShipment.shipment.arrival.planned.finish) : 'Не указано'}</p>
                        </span>
                    </div>
            `;
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-driver-truck-data tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка машина/прицеп
                driverShipments.forEach(data => {
                    rowHTML += `
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>${data.shipment.courier?.carNumber || 'Не указан'}</p>
                                    <p>${data.shipment.courier?.trailerNumber || 'Не указан'}</p>
                                </span>
                            </div>
                    `;
                });
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-inbound-document-wrapper tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка документы
                driverShipments.forEach(data => {
                    rowHTML += `
                            <div>
                                <button tpi-tmu-id="${data.shipment.externalId}">
                                    ${tpiIcon__EAPP} ЭАПП Поставки
                                </button>
                            </div>
                    `;
                });
                
                rowHTML += `
                        </td>
                    </tr>
                `;
                
                rowsHTML.push(rowHTML);
            } else {
                // Одиночная поставка
                const data = firstShipment;
                const rowHTML = `
                    <tr>
                        <td class="tpi-infi--table-suplier">
                            <div>${shortenSupplierName(data.shipment.supplierName) || 'Не указан'}</div>
                        </td>
                        <td class="tpi-infi--table-driver">
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>
                                        ${tpiIcon__person}${data.driverName}
                                        <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/inbounds?courierQuery=${encodeURIComponent(getFirstName(data.driverName))}&statuses=ARRIVED%2CIN_PROGRESS%2CSIGNED%2CFIXED%2CCREATED">${tpiIcon__altLink}</a>
                                    </p>
                                    <p class="tpi-infi--table-driver-phone">${tpiIcon__phone}${data.driverPhone}</p>
                                    <p>
                                        <i class="tpi-infi--table-inbound-status" current-state="${getShipmentStatus(data.shipment).state}"></i>${getShipmentStatus(data.shipment).text}
                                    </p>
                                </span>
                            </div>
                        </td>
                        <td class="tpi-infi--table-inbound-data">
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>
                                        ${data.shipment.externalId}
                                        <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/inbounds?externalIdQuery=${encodeURIComponent(data.shipment.externalId)}">${tpiIcon__altLink}</a>
                                    </p>
                                    <p>${data.shipment.transportationId || 'Не указан'}</p>
                                </span>
                            </div>
                        </td>
                        <td class="tpi-infi--table-orders-data">
                            <div>
                                <a target="_blank"  href="https://hubs.market.yandex.ru/sorting-center/21972131/sortables?inboundIdTitle=${data.shipment.externalId}&sortableStatuses=&sortableStatusesLeafs=" class="tpi-infi--inbound-incom-data tpi-infi--table-orders-data">${tpiIcon__box}${data.shipment.acceptance?.place?.accepted || 0} / ${data.shipment.acceptance?.place?.total || 0}</a>
                            </div>
                        </td>
                        <td class="tpi-infi--table-lots-data">
                            <div>
                                <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/sortables?inboundIdTitle=${data.shipment.externalId}&sortableStatuses=&sortableStatusesLeafs=&sortableTypes=DROP_PALLET&sortableTypes=ORPHAN_PALLET&sortableTypes=PALLET&sortableTypes=XDOC_PALLET" class="tpi-infi--inbound-incom-data">${tpiIcon__pallet}${data.shipment.acceptance?.lot?.accepted || 0} / ${data.shipment.acceptance?.lot?.total || 0}</a>
                            </div>
                        </td>
                        <td class="tpi-infi--table-combined-orders-data">
                            <div>
                                <p>–</p>
                            </div>
                        </td>
                        <td class="tpi-infi--table-combined-lots-data">
                            <div>
                                <p>–</p>
                            </div>
                        </td>
                        <td class="tpi-infi--table-income-date">
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p class="tpi-infi-arival-planned-day">${data.shipment.arrival?.planned?.finish ? formatDate(data.shipment.arrival.planned.finish) : 'Не указано'}</p>
                                    <p class="tpi-infi-arival-planned-time">${data.shipment.arrival?.planned?.start && data.shipment.arrival?.planned?.finish ? formatTime(data.shipment.arrival.planned.start, data.shipment.arrival.planned.finish) : 'Не указано'}</p>
                                </span>
                            </div>
                        </td>
                        <td class="tpi-infi--table-driver-truck-data">
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>${data.shipment.courier?.carNumber || 'Не указан'}</p>
                                    <p>${data.shipment.courier?.trailerNumber || 'Не указан'}</p>
                                </span>
                            </div>
                        </td>
                        <td class="tpi-infi--table-inbound-document-wrapper">
                            <div>
                                <button tpi-tmu-id="${data.shipment.externalId}">
                                    ${tpiIcon__EAPP} ЭАПП Поставки
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                
                rowsHTML.push(rowHTML);
            }
        }
        
        // Очищаем tbody и вставляем все строки сразу
        tbody.innerHTML = rowsHTML.join('');
        
        // Убираем класс прелоадера если он еще есть
        const preloaderRow = tbody.querySelector('.tpi-infi--table-preloader');
        if (preloaderRow) {
            preloaderRow.remove();
        }
        
        // ОБНОВЛЕНИЕ: Используем отфильтрованные данные для статистики
        const statistics = calculateStatistics(validShipmentsData);
        updateStatisticsBlock(statistics);
        
        // Если нет данных, показываем сообщение
        if (validShipmentsData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Нет данных для отображения</td></tr>';
        }
        
        const EAPP_documents = document.querySelectorAll('.tpi-infi--table-inbound-document-wrapper > div > button[tpi-tmu-id]')
        EAPP_documents.forEach(button =>{
            button.addEventListener('click', (e)=>{
                e.preventDefault();
                const tmuData = button.getAttribute('tpi-tmu-id')
                let documentURL= `https://hubs.market.yandex.ru/api/gateway/logpoint/21972131/inbounds/print-document?type=DIGITAL_TRANSFER_ACT&platformType=SORTING_CENTER&externalId=${tmuData}`
                window.open(documentURL, '_blank');
                return false;
            })
        })
        
    } catch (error) {
        console.log('Ошибка при получении данных:', error);
        const tbody = document.querySelector('.tpi-infi--table--tbody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: red;">Ошибка загрузки данных</td></tr>';
        }
    }
}

function updateStatisticsBlock(statistics) {
    const statisticElements = {
        shipments: document.getElementById('tpi-infi--inbounds-total'),
        vehicles: document.getElementById('tpi-infi--inbounds-trucks'),
        totalPlaces: document.getElementById('tpi-infi--places-total'),
        placesAccepted: document.getElementById('tpi-infi--places-accepted'),
        placesNotAccepted: document.getElementById('tpi-infi--places-not-accepted'),
        totalLots: document.getElementById('tpi-infi--lots-total'),
        lotsAccepted: document.getElementById('tpi-infi--lots-accepted'),
        lotsNotAccepted: document.getElementById('tpi-infi--lots-not-accepted')
    };

    // Сбрасываем все элементы в состояние unset перед обновлением
    Object.values(statisticElements).forEach(element => {
        if (element) {
            element.setAttribute('tpi-state-data', 'unset');
            element.setAttribute('tpi-state-data-value', '');
        }
    });

    // Если есть предыдущая статистика, вычисляем разницу
    if (previousStatistics) {
        const differences = calculateStatisticsDifferences(previousStatistics, statistics);
        
        // Применяем изменения к элементам
        Object.keys(differences).forEach(key => {
            const element = statisticElements[key];
            if (element && differences[key].changed) {
                element.setAttribute('tpi-state-data', differences[key].type);
                element.setAttribute('tpi-state-data-value', differences[key].value);
                
                // Устанавливаем таймер для сброса анимации
                setTimeout(() => {
                    if (element.getAttribute('tpi-state-data') !== 'unset') {
                        element.setAttribute('tpi-state-data', 'unset');
                        element.setAttribute('tpi-state-data-value', '');
                    }
                }, 2500);
            }
        });
    }

    // Обновляем значения
    if (statisticElements.shipments) statisticElements.shipments.textContent = statistics.totalShipments;
    if (statisticElements.vehicles) statisticElements.vehicles.textContent = statistics.totalVehicles;
    if (statisticElements.totalPlaces) statisticElements.totalPlaces.textContent = statistics.totalPlaces;
    if (statisticElements.placesAccepted) statisticElements.placesAccepted.textContent = statistics.totalPlacesAccepted;
    if (statisticElements.placesNotAccepted) statisticElements.placesNotAccepted.textContent = statistics.totalPlacesNotAccepted;
    if (statisticElements.totalLots) statisticElements.totalLots.textContent = statistics.totalLots;
    if (statisticElements.lotsAccepted) statisticElements.lotsAccepted.textContent = statistics.totalLotsAccepted;
    if (statisticElements.lotsNotAccepted) statisticElements.lotsNotAccepted.textContent = statistics.totalLotsNotAccepted;

    // Сохраняем текущую статистику как предыдущую для следующего сравнения
    previousStatistics = { ...statistics };
}

function calculateStatisticsDifferences(prevStats, newStats) {
    const differences = {};
    
    differences.shipments = calculateDifference(prevStats.totalShipments, newStats.totalShipments);
    differences.vehicles = calculateDifference(prevStats.totalVehicles, newStats.totalVehicles);
    differences.totalPlaces = calculateDifference(prevStats.totalPlaces, newStats.totalPlaces);
    differences.placesAccepted = calculateDifference(prevStats.totalPlacesAccepted, newStats.totalPlacesAccepted);
    differences.placesNotAccepted = calculateDifference(prevStats.totalPlacesNotAccepted, newStats.totalPlacesNotAccepted);
    differences.totalLots = calculateDifference(prevStats.totalLots, newStats.totalLots);
    differences.lotsAccepted = calculateDifference(prevStats.totalLotsAccepted, newStats.totalLotsAccepted);
    differences.lotsNotAccepted = calculateDifference(prevStats.totalLotsNotAccepted, newStats.totalLotsNotAccepted);
    
    return differences;
}

// Функция для вычисления разницы между двумя значениями
function calculateDifference(prevValue, newValue) {
    // Преобразуем значения в числа
    const prev = parseInt(prevValue) || 0;
    const current = parseInt(newValue) || 0;
    
    const difference = current - prev;
    
    if (difference === 0) {
        return {
            changed: false,
            type: 'unset',
            value: ''
        };
    } else if (difference > 0) {
        return {
            changed: true,
            type: 'plus',
            value: `+${difference}`
        };
    } else {
        return {
            changed: true,
            type: 'minus',
            value: `${difference}` // будет отрицательное число с минусом
        };
    }
}

async function fetchDriverInfo(nameId, phoneId) {
    try {
        const encodedNameId = encodeURIComponent(nameId);
        const encodedPhoneId = encodeURIComponent(phoneId);
        
        const url = `https://hubs.market.yandex.ru/api/gateway/logpoint/21972131/personal/get-bulk?platformType=SORTING_CENTER&ids=${encodedNameId}%2C${encodedPhoneId}`;
        
        const response = await fetch(url);
        const driverData = await response.json();
        
        return {
            name: driverData[nameId] || 'Не указано',
            phone: driverData[phoneId] || 'Не указан'
        };
        
    } catch (error) {
        return {
            name: 'ошибка загрузки',
            phone: 'ошибка загрузки'
        };
    }
}

function calculateStatistics(shipmentsData) {
    let totalShipments = 0;
    let totalPlaces = 0;
    let totalPlacesAccepted = 0;
    let totalLots = 0;
    let totalLotsAccepted = 0;
    let uniqueDrivers = new Set();

    shipmentsData.forEach(data => {
        const carNumber = data.shipment.courier?.carNumber || 'Не указан';
        
        // Пропускаем невалидных водителей - ТОЧНО ТАК ЖЕ КАК В ОСНОВНОЙ ФУНКЦИИ
        if (!isValidDriver(data.driverName, carNumber)) {
            return;
        }
        
        totalShipments++;
        totalPlaces += data.shipment.acceptance?.place?.total || 0;
        totalPlacesAccepted += data.shipment.acceptance?.place?.accepted || 0;
        totalLots += data.shipment.acceptance?.lot?.total || 0;
        totalLotsAccepted += data.shipment.acceptance?.lot?.accepted || 0;
        
        // Считаем уникальных водителей по имени+телефону
        const driverKey = data.driverName + '|' + data.driverPhone;
        uniqueDrivers.add(driverKey);
    });

    return {
        totalShipments,
        totalVehicles: uniqueDrivers.size,
        totalPlaces,
        totalPlacesAccepted,
        totalPlacesNotAccepted: totalPlaces - totalPlacesAccepted,
        totalLots,
        totalLotsAccepted,
        totalLotsNotAccepted: totalLots - totalLotsAccepted
    };
}
// Модифицируем функцию updateTableData
async function updateTableData() {
    try {
        // Загружаем данные и формируем новый HTML в фоне
        const newTableHTML = await fetchShipmentsToTableHTML();
        
        // Когда ВСЕ готово - заменяем содержимое таблицы
        const tbody = document.querySelector('.tpi-infi--table--tbody');
        if (tbody) {
            tbody.innerHTML = newTableHTML;
            
            // Инициализируем обработчики для новых элементов
            initEAPPHandlers();
        }
        
        // Обновляем статистику
        updateStatisticsAfterTableUpdate();

    } catch (error) {
        console.error('Ошибка при обновлении данных:', error);
    }
}

// Функция, которая возвращает HTML вместо прямого вставления в DOM
async function fetchShipmentsToTableHTML() {
    try {
        // Используем выбранную дату или текущую
        const selectedDate = window.currentSelectedDate ? new Date(window.currentSelectedDate) : new Date();
        const year = selectedDate.getFullYear();
        const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
        const day = String(selectedDate.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        const url = `https://hubs.market.yandex.ru/api/gateway/logpoint/21972131/inbounds/get-list?platformType=SORTING_CENTER&courierQuery=&dateFrom=${dateString}&dateTo=${dateString}&movementTypes=LINEHAUL&statuses=ARRIVED%2CIN_PROGRESS%2CSIGNED%2CFIXED%2CCREATED&types=&page=0&size=100`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Города для исключения
        const excludedCities = ['Липецк', 'Курск', 'Белгород'];
        
        // Переменные для статистики
        let totalShipments = 0;
        let totalPlaces = 0;
        
        // Собираем все промисы для загрузки данных водителей
        const shipmentPromises = [];
        const processedShipments = new Set();
        
        // Обрабатываем каждую поставку
        for (let i = 0; i < data.content.length; i++) {
            const shipment = data.content[i];
            
            // Проверяем на дубликаты по externalId
            if (processedShipments.has(shipment.externalId)) {
                continue;
            }
            processedShipments.add(shipment.externalId);
            
            // Проверяем время arrival planned start
            if (shipment.arrival && shipment.arrival.planned && shipment.arrival.planned.start) {
                const plannedStartTime = shipment.arrival.planned.start;
                const plannedDate = new Date(plannedStartTime);
                const hour = plannedDate.getHours();
                
                // Пропускаем поставки с временем после 19:00
                if (hour > 19) {
                    continue;
                }
            }
            
            // Проверяем название поставщика на наличие исключенных городов
            if (shipment.supplierName) {
                const shouldExclude = excludedCities.some(city => 
                    shipment.supplierName.includes(city)
                );
                
                if (shouldExclude) {
                    continue;
                }
            }
            
            // Проверяем acceptance place total и lot total
            const placeTotal = shipment.acceptance?.place?.total || 0;
            const lotTotal = shipment.acceptance?.lot?.total || 0;
            
            if (placeTotal === 0 && lotTotal === 0) {
                continue;
            }
            
            // Увеличиваем счетчики
            totalShipments++;
            totalPlaces += placeTotal;
            
            // Создаем промис для загрузки данных водителя и формирования строки
            const shipmentPromise = (async () => {
                // Получаем данные водителя
                let driverName = 'Не указано';
                let driverPhone = 'Не указан';
                
                if (shipment.courier?.nameId && shipment.courier?.phoneId) {
                    try {
                        const driverData = await fetchDriverInfo(shipment.courier.nameId, shipment.courier.phoneId);
                        driverName = driverData.name || 'Не указано';
                        driverPhone = driverData.phone || 'Не указан';
                    } catch (error) {
                        console.error('Ошибка загрузки данных водителя:', error);
                    }
                }
                
                return {
                    shipment,
                    driverName,
                    driverPhone
                };
            })();
            
            shipmentPromises.push(shipmentPromise);
        }
        
        // Ждем загрузки всех данных
        const shipmentsData = await Promise.all(shipmentPromises);
        
        // ФИЛЬТРАЦИЯ: Убираем водителей без имени и номера машины
        const validShipmentsData = filterValidShipments(shipmentsData);
        
        // Группируем поставки по водителям
        const groupedByDriver = {};
        validShipmentsData.forEach(data => {
            const driverKey = data.driverName + '|' + data.driverPhone;
            if (!groupedByDriver[driverKey]) {
                groupedByDriver[driverKey] = [];
            }
            groupedByDriver[driverKey].push(data);
        });
        
        // ФИЛЬТРАЦИЯ: Убираем группы с невалидными водителями
        const validDriverGroups = filterValidDriverGroups(groupedByDriver);
        
        // Формируем HTML строк для таблицы
        const rowsHTML = [];
        
        for (const driverKey in validDriverGroups) {
            const driverShipments = validDriverGroups[driverKey];
            const isMultiple = driverShipments.length > 1;
            const firstShipment = driverShipments[0];
            
            // Вычисляем суммарные значения для группированных поставок
            let totalPlacesSum = 0;
            let totalLotsSum = 0;
            
            driverShipments.forEach(data => {
                totalPlacesSum += data.shipment.acceptance?.place?.total || 0;
                totalLotsSum += data.shipment.acceptance?.lot?.total || 0;
            });
            
            if (isMultiple) {
                // Группированная строка для нескольких поставок одного водителя
                
                // Получаем статус водителя на основе всех его поставок
                const driverShipmentsData = driverShipments.map(data => data.shipment);
                const driverStatus = getDriverStatus(driverShipmentsData);
                
                let rowHTML = `
                    <tr multiple-inbound-driver="true">
                        <td class="tpi-infi--table-suplier tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка поставщиков
                driverShipments.forEach((data, index) => {
                    rowHTML += `<div>${shortenSupplierName(data.shipment.supplierName) || 'Не указан'}</div>`;
                });
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-driver tpi-infi--table-multiple-inbounds-driver">
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>
                                        ${tpiIcon__person}${firstShipment.driverName}
                                        <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/inbounds?courierQuery=${encodeURIComponent(getFirstName(firstShipment.driverName))}&statuses=ARRIVED%2CIN_PROGRESS%2CSIGNED%2CFIXED%2CCREATED">${tpiIcon__altLink}</a>
                                    </p>
                                    <p class="tpi-infi--table-driver-phone">${tpiIcon__phone}${firstShipment.driverPhone}</p>
                                    <p>
                                        <i class="tpi-infi--table-inbound-status" current-state="${driverStatus.state}"></i>${driverStatus.text}
                                    </p>
                                </span>
                            </div>
                        </td>
                `;
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-orders-data tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка поставок/перемещений
                driverShipments.forEach(data => {
                    rowHTML += `
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>
                                        ${data.shipment.externalId}
                                        <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/inbounds?externalIdQuery=${encodeURIComponent(data.shipment.externalId)}">${tpiIcon__altLink}</a>
                                    </p>
                                    <p>${data.shipment.transportationId || 'Не указан'}</p>
                                </span>
                            </div>
                    `;
                });
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-orders-data tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка посылок принято/план
                driverShipments.forEach(data => {
                    rowHTML += `
                            <div>
                                <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/sortables?inboundIdTitle=${data.shipment.externalId}&sortableStatuses=&sortableStatusesLeafs=" class="tpi-infi--inbound-incom-data tpi-infi--table-orders-data">${tpiIcon__box}${data.shipment.acceptance?.place?.accepted || 0} / ${data.shipment.acceptance?.place?.total || 0}</a>
                            </div>
                    `;
                });
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-lots-data tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка лотов принято/план
                driverShipments.forEach(data => {
                    rowHTML += `
                            <div>
                                <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/sortables?inboundIdTitle=${data.shipment.externalId}&sortableStatuses=&sortableStatusesLeafs=&sortableTypes=DROP_PALLET&sortableTypes=ORPHAN_PALLET&sortableTypes=PALLET&sortableTypes=XDOC_PALLET" class="tpi-infi--inbound-incom-data">${tpiIcon__pallet}${data.shipment.acceptance?.lot?.accepted || 0} / ${data.shipment.acceptance?.lot?.total || 0}</a>
                            </div>
                    `;
                });
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-combined-orders-data tpi-infi--table-multiple-inbounds-part-left">
                            <div>
                                <p>${totalPlacesSum}</p>
                            </div>
                        </td>
                        <td class="tpi-infi--table-combined-lots-data">
                            <div>
                                <p>${totalLotsSum}</p>
                            </div>
                        </td>
                        <td class="tpi-infi--table-income-date tpi-infi--table-multiple-inbounds-part-right">
                `;
                
                // Колонка прибытия
                rowHTML += `
                    <div>
                        <span class="tpi-infi--table-data-wrapper">
                            <p class="tpi-infi-arival-planned-day">${firstShipment.shipment.arrival?.planned?.finish ? formatDate(firstShipment.shipment.arrival.planned.finish) : 'Не указано'}</p>
                            <p class="tpi-infi-arival-planned-time">${firstShipment.shipment.arrival?.planned?.start && firstShipment.shipment.arrival?.planned?.finish ? formatTime(firstShipment.shipment.arrival.planned.start, firstShipment.shipment.arrival.planned.finish) : 'Не указано'}</p>
                        </span>
                    </div>
                `;
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-driver-truck-data tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка машина/прицеп
                driverShipments.forEach(data => {
                    rowHTML += `
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>${data.shipment.courier?.carNumber || 'Не указан'}</p>
                                    <p>${data.shipment.courier?.trailerNumber || 'Не указан'}</p>
                                </span>
                            </div>
                    `;
                });
                
                rowHTML += `
                        </td>
                        <td class="tpi-infi--table-inbound-document-wrapper tpi-infi--table-multiple-inbounds">
                `;
                
                // Колонка документы
                driverShipments.forEach(data => {
                    rowHTML += `
                            <div>
                                <button tpi-tmu-id="${data.shipment.externalId}">
                                    ${tpiIcon__EAPP} ЭАПП Поставки
                                </button>
                            </div>
                    `;
                });
                
                rowHTML += `
                        </td>
                    </tr>
                `;
                
                rowsHTML.push(rowHTML);
            } else {
                // Одиночная поставка
                const data = firstShipment;
                const rowHTML = `
                    <tr>
                        <td class="tpi-infi--table-suplier">
                            <div>${shortenSupplierName(data.shipment.supplierName) || 'Не указан'}</div>
                        </td>
                        <td class="tpi-infi--table-driver">
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>
                                        ${tpiIcon__person}${data.driverName}
                                        <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/inbounds?courierQuery=${encodeURIComponent(getFirstName(data.driverName))}&statuses=ARRIVED%2CIN_PROGRESS%2CSIGNED%2CFIXED%2CCREATED">${tpiIcon__altLink}</a>
                                    </p>
                                    <p class="tpi-infi--table-driver-phone">${tpiIcon__phone}${data.driverPhone}</p>
                                    <p>
                                        <i class="tpi-infi--table-inbound-status" current-state="${getShipmentStatus(data.shipment).state}"></i>${getShipmentStatus(data.shipment).text}
                                    </p>
                                </span>
                            </div>
                        </td>
                        <td class="tpi-infi--table-inbound-data">
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>
                                        ${data.shipment.externalId}
                                        <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/inbounds?externalIdQuery=${encodeURIComponent(data.shipment.externalId)}">${tpiIcon__altLink}</a>
                                    </p>
                                    <p>${data.shipment.transportationId || 'Не указан'}</p>
                                </span>
                            </div>
                        </td>
                        <td class="tpi-infi--table-orders-data">
                            <div>
                                <a target="_blank"  href="https://hubs.market.yandex.ru/sorting-center/21972131/sortables?inboundIdTitle=${data.shipment.externalId}&sortableStatuses=&sortableStatusesLeafs=" class="tpi-infi--inbound-incom-data tpi-infi--table-orders-data">${tpiIcon__box}${data.shipment.acceptance?.place?.accepted || 0} / ${data.shipment.acceptance?.place?.total || 0}</a>
                            </div>
                        </td>
                        <td class="tpi-infi--table-lots-data">
                            <div>
                                <a target="_blank" href="https://hubs.market.yandex.ru/sorting-center/21972131/sortables?inboundIdTitle=${data.shipment.externalId}&sortableStatuses=&sortableStatusesLeafs=&sortableTypes=DROP_PALLET&sortableTypes=ORPHAN_PALLET&sortableTypes=PALLET&sortableTypes=XDOC_PALLET" class="tpi-infi--inbound-incom-data">${tpiIcon__pallet}${data.shipment.acceptance?.lot?.accepted || 0} / ${data.shipment.acceptance?.lot?.total || 0}</a>
                            </div>
                        </td>
                        <td class="tpi-infi--table-combined-orders-data">
                            <div>
                                <p>–</p>
                            </div>
                        </td>
                        <td class="tpi-infi--table-combined-lots-data">
                            <div>
                                <p>–</p>
                            </div>
                        </td>
                        <td class="tpi-infi--table-income-date">
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p class="tpi-infi-arival-planned-day">${data.shipment.arrival?.planned?.finish ? formatDate(data.shipment.arrival.planned.finish) : 'Не указано'}</p>
                                    <p class="tpi-infi-arival-planned-time">${data.shipment.arrival?.planned?.start && data.shipment.arrival?.planned?.finish ? formatTime(data.shipment.arrival.planned.start, data.shipment.arrival.planned.finish) : 'Не указано'}</p>
                                </span>
                            </div>
                        </td>
                        <td class="tpi-infi--table-driver-truck-data">
                            <div>
                                <span class="tpi-infi--table-data-wrapper">
                                    <p>${data.shipment.courier?.carNumber || 'Не указан'}</p>
                                    <p>${data.shipment.courier?.trailerNumber || 'Не указан'}</p>
                                </span>
                            </div>
                        </td>
                        <td class="tpi-infi--table-inbound-document-wrapper">
                            <div>
                                <button tpi-tmu-id="${data.shipment.externalId}">
                                    ${tpiIcon__EAPP} ЭАПП Поставки
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                
                rowsHTML.push(rowHTML);
            }
        }
        
        // Если нет данных, возвращаем сообщение
        if (rowsHTML.length === 0) {
            return '<tr><td colspan="9" style="text-align: center; padding: 20px;">Нет данных для отображения</td></tr>';
        }
        
        // Возвращаем собранный HTML
        return rowsHTML.join('');
        
    } catch (error) {
        console.log('Ошибка при получении данных:', error);
        return '<tr><td colspan="9" style="text-align: center; padding: 20px; color: red;">Ошибка загрузки данных</td></tr>';
    }
}

// Функция для инициализации обработчиков EAPP документов
function initEAPPHandlers() {
    const EAPP_documents = document.querySelectorAll('.tpi-infi--table-inbound-document-wrapper > div > button[tpi-tmu-id]');
    EAPP_documents.forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const tmuData = button.getAttribute('tpi-tmu-id');
            let documentURL = `https://hubs.market.yandex.ru/api/gateway/logpoint/21972131/inbounds/print-document?type=DIGITAL_TRANSFER_ACT&platformType=SORTING_CENTER&externalId=${tmuData}`;
            window.open(documentURL, '_blank');
            return false;
        });
    });
}

// Функция для обновления статистики после обновления таблицы
function updateStatisticsAfterTableUpdate() {
    // Пересчитываем статистику на основе текущих данных в таблице
    const statistics = calculateStatisticsFromTable();
    updateStatisticsBlock(statistics);
}

// Функция для расчета статистики из данных таблицы
function calculateStatisticsFromTable() {
    const rows = document.querySelectorAll('.tpi-infi--table--tbody tr:not(.tpi-infi--table-preloader)');
    
    let totalShipments = 0;
    let totalPlaces = 0;
    let totalPlacesAccepted = 0;
    let totalLots = 0;
    let totalLotsAccepted = 0;
    let uniqueDrivers = new Set();
    
    // Города для исключения (как в основной функции)
    const excludedCities = ['Липецк', 'Курск', 'Белгород'];
    
    rows.forEach(row => {
        // Пропускаем строки с невалидными водителями
        const driverCell = row.querySelector('.tpi-infi--table-driver');
        if (!driverCell) return;
        
        // Проверяем валидность водителя
        const driverNameElement = driverCell.querySelector('.tpi-infi--table-data-wrapper p:first-child');
        if (!driverNameElement) return;
        
        // Получаем имя водителя (убираем иконки и ссылки)
        const tmp = driverNameElement.cloneNode(true);
        tmp.querySelectorAll('svg, a').forEach(el => el.remove());
        const driverName = tmp.textContent.trim();
        
        // Получаем номер машины
        const vehicleCell = row.querySelector('.tpi-infi--table-driver-truck-data');
        let carNumber = 'Не указан';
        if (vehicleCell) {
            const firstVehicleDiv = vehicleCell.querySelector('div:first-child');
            if (firstVehicleDiv) {
                const vehicleTmp = firstVehicleDiv.cloneNode(true);
                vehicleTmp.querySelectorAll('svg').forEach(el => el.remove());
                const vehicleText = vehicleTmp.textContent.trim();
                // Берем только первую строку (номер машины)
                carNumber = vehicleText.split('\n')[0] || 'Не указан';
            }
        }
        
        // ПРИМЕНЯЕМ ТЕ ЖЕ ФИЛЬТРЫ, ЧТО И ПРИ ЗАГРУЗКЕ
        if (!isValidDriver(driverName, carNumber)) {
            return; // пропускаем невалидных водителей
        }
        
        // Проверяем поставщика на исключенные города
        const supplierCell = row.querySelector('.tpi-infi--table-suplier');
        if (supplierCell) {
            const supplierText = supplierCell.textContent.trim();
            const shouldExclude = excludedCities.some(city => 
                supplierText.includes(city)
            );
            
            if (shouldExclude) {
                return; // пропускаем исключенные города
            }
        }
        
        // Проверяем время прибытия (после 19:00)
        const timeCell = row.querySelector('.tpi-infi--table-income-date');
        if (timeCell) {
            const timeText = timeCell.textContent.trim();
            // Ищем время в формате "HH:MM — HH:MM"
            const timeMatch = timeText.match(/(\d{1,2}):(\d{2})\s*—\s*(\d{1,2}):(\d{2})/);
            if (timeMatch) {
                const startHour = parseInt(timeMatch[1]);
                // Пропускаем поставки с временем после 19:00
                if (startHour > 19) {
                    return;
                }
            }
        }
        
        if (row.hasAttribute('multiple-inbound-driver')) {
            // Обработка группированных строк
            const ordersElements = row.querySelectorAll('.tpi-infi--table-orders-data a');
            const lotsElements = row.querySelectorAll('.tpi-infi--table-lots-data a');
            
            // Для группированных строк считаем КОЛИЧЕСТВО поставок по количеству ссылок
            let validShipmentsInRow = 0;
            
            ordersElements.forEach((element, index) => {
                const text = element.textContent.trim();
                const match = text.match(/(\d+)\s*\/\s*(\d+)/);
                if (match) {
                    const accepted = parseInt(match[1]);
                    const total = parseInt(match[2]);
                    
                    // Пропускаем поставки с нулевыми значениями (как в основной функции)
                    if (total > 0) {
                        totalPlacesAccepted += accepted;
                        totalPlaces += total;
                        validShipmentsInRow++;
                    }
                }
            });
            
            lotsElements.forEach(element => {
                const text = element.textContent.trim();
                const match = text.match(/(\d+)\s*\/\s*(\d+)/);
                if (match) {
                    totalLotsAccepted += parseInt(match[1]);
                    totalLots += parseInt(match[2]);
                }
            });
            
            totalShipments += validShipmentsInRow;
            
            // Считаем уникальных водителей
            uniqueDrivers.add(driverName);
            
        } else {
            // Обработка одиночных строк
            const ordersElement = row.querySelector('.tpi-infi--table-orders-data a');
            const lotsElement = row.querySelector('.tpi-infi--table-lots-data a');
            
            let shouldCountShipment = true;
            
            // Проверяем, есть ли заказы (как в основной функции)
            if (ordersElement) {
                const text = ordersElement.textContent.trim();
                const match = text.match(/(\d+)\s*\/\s*(\d+)/);
                if (match) {
                    const total = parseInt(match[2]);
                    // Пропускаем поставки с нулевыми значениями
                    if (total === 0) {
                        shouldCountShipment = false;
                    } else {
                        totalPlacesAccepted += parseInt(match[1]);
                        totalPlaces += total;
                    }
                }
            }
            
            if (lotsElement && shouldCountShipment) {
                const text = lotsElement.textContent.trim();
                const match = text.match(/(\d+)\s*\/\s*(\d+)/);
                if (match) {
                    totalLotsAccepted += parseInt(match[1]);
                    totalLots += parseInt(match[2]);
                }
            }
            
            if (shouldCountShipment) {
                totalShipments++;
                // Считаем уникальных водителей
                uniqueDrivers.add(driverName);
            }
        }
    });
    
    return {
        totalShipments,
        totalVehicles: uniqueDrivers.size,
        totalPlaces,
        totalPlacesAccepted,
        totalPlacesNotAccepted: totalPlaces - totalPlacesAccepted,
        totalLots,
        totalLotsAccepted,
        totalLotsNotAccepted: totalLots - totalLotsAccepted
    };
}

// Функция для инициализации статистики при первой загрузке
function initializeStatistics() {
    const statistics = calculateStatisticsFromTable();
    updateStatisticsBlock(statistics);
}



function shouldExcludeByTime(timeText) {
    if (!timeText) return false;
    
    // Ищем время в формате "HH:MM — HH:MM"
    const timeMatch = timeText.match(/(\d{1,2}):(\d{2})\s*—\s*(\d{1,2}):(\d{2})/);
    if (timeMatch) {
        const startHour = parseInt(timeMatch[1]);
        return startHour > 19;
    }
    
    return false;
}

// Добавляем функцию в глобальную область видимости
window.updateTableData = updateTableData;

function checkiIs__onInboundsFile() {
    'use strict';

    // Функция проверки URL
    function isInboundsFilePage(url) {
        const base = 'https://hubs.market.yandex.ru/sorting-center/';
        if (!url.startsWith(base)) return false;
        
        const params = new URLSearchParams(url.split('?')[1] || '');
        return params.get('tpiInboundsFile') === 'true' 
    }

    // Функция добавления блока (и отключения наблюдателя)
    function addTurboBlock() {
        if (document.querySelector('.tpi-infi--wrapper')) return;

        document.title = "Файл поставок"

        const overlay = document.createElement('div');
        overlay.className = 'tpi-infi--wrapper';

        overlay.innerHTML = 
        `
        <div class="tpi-infi--wrapper-title">
            <div class="tpi-infi-title-container">
                <div class="tpi-infi--wrapper-title-text">Файл поставок</div>
                <div class="tpi-infi--change-date-wrapper">
                    <button class="tpi-infi--switch-date-button" tpi-infi--change-date="prev">
                        ${tpiIcon__left_chevron}
                    </button>
                    <p class="tpi-infi--selected-date" tpi-changing-date="unset">-</p>
                    <button class="tpi-infi--switch-date-button" tpi-infi--change-date="next">
                        ${tpiIcon__right_chevron}
                    </button>
                </div>
            </div>
            <div class="tpi-infi--update-table-wrapper">
                <div class="tpi-infi--update-button-wrapper">
                    <button class="tpi-infi--force-update-button" tpi-current-state="unset" disabled>
                        ${tpiIcon__updateTable}
                    </button>
                    <button class="tpi-infi--update-button" tpi-current-state="playing">
                        ${tpiIcon__pauseUpdate}
                    </button>
                </div>
                <div class="tpi-infi--update-info-container">
                    <p class="tpi-infi--update-info-text">Обноление таблицы через 10</p>
                    <div class="tpi-infi--update-progress-track">
                        <span class="tpi-infi--update-progress-bar"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="tpi-infi--content-block">
            <div class="tpi-infi--controls-panel tpi-infi--column-section">
                <div class="tpi-infi--controls-wrapper">
                    <div class="tpi-infi--controls-wrapper-title">
                        <p>Статистика поставок</p>
                    </div>
                    <div class="tpi-infi--item-wrapper tpi-infi--column-section">
                        <div class="tpi-infi--item">
                            <ul class="tpi-infi--statistic-wrapper">
                                <li class="tpi-infi--statistic">
                                    <div class="tpi-infi--statistic-block">
                                        <i class="tpi-infi--statistic-icon">${tpiIcon__inbounds}</i>
                                        <p class="tpi-infi--statistic-text">Поставок</p>
                                    </div>
                                    <div class="tpi-infi--statistic-block-data">
                                        <p class="tpi-infi--statistic-value" tpi-state-data="unset" tpi-state-data-value="+150" id="tpi-infi--inbounds-total">•</p>
                                    </div>
                                </li>
                                <li class="tpi-infi--statistic">
                                    <div class="tpi-infi--statistic-block">
                                        <i class="tpi-infi--statistic-icon">${tpiIcon__truck}</i>
                                        <p class="tpi-infi--statistic-text">Количество ТС</p>
                                    </div>
                                    <div class="tpi-infi--statistic-block-data">
                                        <p class="tpi-infi--statistic-value" tpi-state-data="unset" tpi-state-data-value="+150" id="tpi-infi--inbounds-trucks">•</p>
                                    </div>
                                </li>
                                <li class="tpi-infi--statistic">
                                    <div class="tpi-infi--statistic-block">
                                        <i class="tpi-infi--statistic-icon">${tpiIcon__packages}</i>
                                        <p class="tpi-infi--statistic-text">Всего заказов</p>
                                    </div>
                                    <div class="tpi-infi--statistic-block-data">
                                        <p class="tpi-infi--statistic-value" tpi-state-data="unset" tpi-state-data-value="+150" id="tpi-infi--places-total">•</p>
                                    </div>
                                </li>
                                <li class="tpi-infi--statistic" style="margin-top: 20px;">
                                    <div class="tpi-infi--statistic-block">
                                        <i class="tpi-infi--statistic-icon">${tpiIcon__checkMark}</i>
                                        <p class="tpi-infi--statistic-text">Заказов принято</p>
                                    </div>
                                    <div class="tpi-infi--statistic-block-data">
                                        <p class="tpi-infi--statistic-value" tpi-state-data="unset" tpi-state-data-value="+150" id="tpi-infi--places-accepted">•</p>
                                    </div>
                                </li>
                                <li class="tpi-infi--statistic">
                                    <div class="tpi-infi--statistic-block">
                                        <i class="tpi-infi--statistic-icon">${tpiIcon__hourGlass}</i>
                                        <p class="tpi-infi--statistic-text">Не принято заказов</p>
                                    </div>
                                    <div class="tpi-infi--statistic-block-data">
                                        <p class="tpi-infi--statistic-value" tpi-state-data="unset" tpi-state-data-value="+150" id="tpi-infi--places-not-accepted">•</p>
                                    </div>
                                </li>
                                <li class="tpi-infi--statistic" style="margin-top: 20px;">
                                    <div class="tpi-infi--statistic-block">
                                        <i class="tpi-infi--statistic-icon">${tpiIcon__pallet}</i>
                                        <p class="tpi-infi--statistic-text">Всего лотов</p>
                                    </div>
                                    <div class="tpi-infi--statistic-block-data">
                                        <p class="tpi-infi--statistic-value" tpi-state-data="unset" tpi-state-data-value="+150" id="tpi-infi--lots-total">•</p>
                                    </div>
                                </li>
                                <li class="tpi-infi--statistic">
                                    <div class="tpi-infi--statistic-block">
                                        <i class="tpi-infi--statistic-icon">${tpiIcon__checkMark}</i>
                                        <p class="tpi-infi--statistic-text">Лотов принято</p>
                                    </div>
                                    <div class="tpi-infi--statistic-block-data">
                                        <p class="tpi-infi--statistic-value" tpi-state-data="unset" tpi-state-data-value="+150" id="tpi-infi--lots-accepted">•</p>
                                    </div>
                                </li>
                                <li class="tpi-infi--statistic">
                                    <div class="tpi-infi--statistic-block">
                                        <i class="tpi-infi--statistic-icon">${tpiIcon__hourGlass}</i>
                                        <p class="tpi-infi--statistic-text">Не принято лотов</p>
                                    </div>
                                    <div class="tpi-infi--statistic-block-data">
                                        <p class="tpi-infi--statistic-value" tpi-state-data="unset" tpi-state-data-value="+150" id="tpi-infi--lots-not-accepted">•</p>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="tpi-infi--controls-wrapper" style="width: 100%;">
                    <div class="tpi-infi--controls-wrapper-title">
                        <p>Печать</p>
                    </div>
                    <div class="tpi-infi--item-wrapper">
                        <div class="tpi-infi--item">
                            <button class="tpi-infi--update-all-groups">
                                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M408 112H106a58 58 0 0 0-58 58v158a56 56 0 0 0 56 56h8v39.68A40.32 40.32 0 0 0 152.32 464h207.36A40.32 40.32 0 0 0 400 423.68V384h8a56 56 0 0 0 56-56V168a56 56 0 0 0-56-56zm-40 311.68a8.35 8.35 0 0 1-8.32 8.32H152.32a8.35 8.35 0 0 1-8.32-8.32V264.32a8.35 8.35 0 0 1 8.32-8.32h207.36a8.35 8.35 0 0 1 8.32 8.32zm26-215.76a24 24 0 1 1 22-22 24 24 0 0 1-22 22zM344 48H168a56.09 56.09 0 0 0-55.42 48h286.84A56.09 56.09 0 0 0 344 48z"></path>
                                </svg>
                                <p>
                                    Распечатать файл
                                </p>
                            </button>
                        </div>
                        <p class="tpi-infi--generating-status">
                            Файл создан
                        </p>
                    </div>
                </div>
            </div>
            <div class="tpi-infi--controls-panel tpi-infi--column-section" style="width: 100%;">
                <div class="tpi-infi--controls-wrapper" style="height: 100%;width: 100%;">
                    <div class="tpi-infi--controls-wrapper-title">
                        <p class="tpi-infi--graph-title">График текщуих поставок</p>
                        <div class="tpi-infi--graph-switch-wrapper">
                            <button class="tpi-ingi--graph-switch" id="tpi-infi--graph-line" current-state="unchecked">${tpiIcon__graphLine}</button>
                            <button class="tpi-ingi--graph-switch" id="tpi-infi--graph-bar" current-state="checked" disabled>${tpiIcon__graphBar}</button>
                        </div>
                    </div>
                    <div class="tpi-infi--statistic-graph"></div>
                </div>
            </div>
        </div>

        <!--<div class="tpi-infi--content-block">
            <div class="tpi-infi--controls-panel tpi-infi--column-section" style="width: 100%;">
                <div class="tpi-infi--controls-wrapper" style="width: 100%;">
                    <div class="tpi-infi--controls-wrapper-title">
                        <p>Обновление данных</p>
                    </div>
                    <div class="tpi-infi--data-update-progress-wrapper">
                        <span class="tpi-infi--data-update-progress-wrapper">
                        </span>
                    </div>
                </div>
            </div>
        </div>-->

            
        <div class="tpi-infi--table-wrapper">
            <table class="tpi-infi--inbounds-data">
                <thead class="tpi-infi--table--thead">
                    <tr>
                        <th>
                            <div>Поставщик</div>
                        </th>
                        <th>
                            <div>Водитель</div>
                        </th>
                        <th>
                            <div>Поставка<br>Перемещение</div>
                        </th>
                        <th>
                            <div>Посылки<br>Принято / План</div>
                        </th>
                        <th>
                            <div>Лоты<br>Принято / План</div>
                        </th>
                        <th>
                            <div>Всего посылок<br>в двух ТС</div>
                        </th>
                        <th>
                            <div>Всего Лотов<br>в двух ТС</div>
                        </th>
                        <th>
                            <div>Прибытие</div>
                        </th>
                        <th>
                            <div>Машина<br>Прицеп</div>
                        </th>
                        <th>
                            <div>Документы</div>
                        </th>
                    </tr>
                </thead>
                <tbody class="tpi-infi--table--tbody">
                    <tr class="tpi-infi--table-preloader">
                        <td colspan="9" style="text-align: center; padding: 20px;">
                            Загрузка данных...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        `
        
        function tryInsertOverlay() {
            const targetSpan = document.querySelector('span[data-i18n-key="pages.billing-stat:header.title"]');
            
            if (targetSpan) {
                const fifthParent = targetSpan.parentElement?.parentElement?.parentElement?.parentElement?.parentElement;
                
                if (fifthParent && document.body.contains(fifthParent)) {
                    // Удаляем старый overlay если есть
                    const oldOverlay = document.querySelector('.tpi-infi--wrapper');
                    if (oldOverlay) oldOverlay.remove();
                    
                    fifthParent.classList.add('tpi-infi--default-layout');
                    
                    // Проставляем атрибут родителю overlay
                    fifthParent.parentElement.setAttribute('tpi-blocked', 'true');
                    
                    fifthParent.insertAdjacentElement('afterend', overlay);
                    document.title = "Файл поставок";
                    // Загружаем данные после вставки блока
                    setTimeout(() => {
                        initDateSwitcher();
                        fetchShipmentsToTable();
                        initStatisticsGraph();
                        initGraphSwitchers(); 
                        startBackgroundDataLoading();
                        autoUpdateTableData();
                        initializeStatistics();
                    }, 100);
                    
                    return true;
                }
            }
            return false;
        }
    
        // Пытаемся вставить сразу
        if (!tryInsertOverlay()) {
            // Если не получилось, ждем появления элемента
            const insertionObserver = new MutationObserver(() => {
                if (tryInsertOverlay()) {
                    document.title = "Файл поставок";
                    insertionObserver.disconnect();
                }
            });
            
            insertionObserver.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            // На всякий случай таймаут
            setTimeout(() => {
                insertionObserver.disconnect();
                if (tryInsertOverlay()) {
                    setTimeout(() => {
                        fetchShipmentsToTable();
                    }, 100);
                }
            }, 5000);
        }
    
        // Наблюдатель для повторной вставки после перезагрузки страницы
        const bodyObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    // Проверяем, был ли удален наш overlay
                    if (!document.querySelector('.tpi-infi--wrapper')) {
                        // Даем время на полную перезагрузку контента
                        setTimeout(() => {
                            if (!document.querySelector('.tpi-infi--wrapper')) {
                                tryInsertOverlay();
                            }
                        }, 100);
                    }
                }
            });
        });
    
        bodyObserver.observe(document.body, {
            childList: true,
            subtree: false
        });
        
        // observer.disconnect();
        // observer = null;
    }

    if (isInboundsFilePage(location.href)) {
        addTurboBlock();
        document.querySelector(".tpi-infi--update-all-groups")
            ?.addEventListener("click", generateInboundsPDF);
        
        // Инициализируем переключатели графиков после загрузки DOM
        setTimeout(() => {
            initGraphSwitchers();
        }, 100);
        
        return; 
    }

    let observer = new MutationObserver(() => {
        if (isInboundsFilePage(location.href)) {
            addTurboBlock();
            document.title = "Файл поставок";
            console.log("changed")
        }
    });
    observer.observe(document, { subtree: true, childList: true });

}

checkiIs__onInboundsFile()


// Функция для сокращения названия поставщика (такая же как в PDF)
function shortenSupplierName(name) {
    if (!name) return '';
    const patterns = [
        { regex: /СЦ Яндекс\.?Маркет СПБ Бугры/, replacement: 'СЦ СПБ Бугры' },
        { regex: /Склад,? СЦ Яндекс\.?Маркет Строгино/, replacement: 'СЦ Строгино' },
        { regex: /Склад СЦ Яндекс\.? ?Маркет Тарный/, replacement: 'СЦ МК Тарный' },
        { regex: /Склад СЦ Яндекс\.?Маркет \(Ростов\)/, replacement: 'СЦ МК Ростов' },
        { regex: /МО Домодедово КГТ/, replacement: 'Домодедово КГТ' },
        { regex: /ООО «Маркет\.Операции» \(Ростов-на-Дону КГТ\)/, replacement: 'Ростов КГТ' },
        { regex: /ООО «Маркет\.Операции» \(Московская область, Софьино\)/, replacement: 'Софьино ФФЦ' },
        { regex: /ООО «Маркет\.Операции» \(Софьино КГТ\)/, replacement: 'Софьино КГТ' },
        { regex: /СЦ Яндекс\.?Маркет (.+)/, replacement: 'СЦ $1' },
        { regex: /Склад СЦ Яндекс\.?Маркет (.+)/, replacement: 'СЦ $1' },
        { regex: /ООО «Маркет\.Операции» \((.+)\)/, replacement: '$1' }
    ];
    for (const pattern of patterns) {
        if (pattern.regex.test(name)) return name.replace(pattern.regex, pattern.replacement);
    }
    return name;
}

//@@@ 

function initStatisticsGraph() {
    const graphContainer = document.querySelector('.tpi-infi--statistic-graph');
    if (!graphContainer) return;

    // Полностью очищаем контейнер
    graphContainer.innerHTML = '';
    
    // Создаем новый контейнер для графика
    const chartElement = document.createElement('div');
    chartElement.style.height = '100%';
    graphContainer.appendChild(chartElement);

    // Создаем новый график
    const chart = echarts.init(chartElement);
    currentChart = chart;

    // Конфигурация статусов с цветами и настройками
    const statusConfig = {
        'arived': {
            name: 'Прибыл',
            gradient: {
                type: 'linear',
                x: 0, y: 0, x2: 0, y2: 1,
                colorStops: [
                    { offset: 0, color: '#caff00' },
                    { offset: 0.5, color: '#C4F13C' },
                    { offset: 1, color: '#31C539' }
                ]
            },
            borderColor: '#4cf754',
            shadowColor: 'rgba(76, 175, 80, 0.7)'
        },
        'fixed': {
            name: 'Зафиксирован',
            gradient: {
                type: 'linear',
                x: 0, y: 0, x2: 0, y2: 1,
                colorStops: [
                    { offset: 0, color: '#CAFF00' },
                    { offset: 0.5, color: '#C4F13C' },
                    { offset: 1, color: '#1BF726FF' }
                ]
            },
            borderColor: '#31C539',
            shadowColor: 'rgab(204, 255, 0, 0.7)'
        },
        'signed': {
            name: 'Подписан',
            gradient: {
                type: 'linear',
                x: 0, y: 0, x2: 0, y2: 1,
                colorStops: [
                    { offset: 0, color: '#00ffaf' },
                    { offset: 0.5, color: '#00f1ff' },
                    { offset: 1, color: '#00b1ff' }
                ]
            },
            borderColor: '#39E3ECFF',
            shadowColor: 'rgba(0, 255, 175, 0.7)'
        },
        'incoming': {
            name: 'В пути',
            gradient: {
                type: 'linear',
                x: 0, y: 0, x2: 0, y2: 1,
                colorStops: [
                    { offset: 0, color: '#FFD700' },
                    { offset: 0.5, color: '#FFC400' },
                    { offset: 1, color: '#FFA500' }
                ]
            },
            borderColor: '#ffb300',
            shadowColor: 'rgba(255, 165, 0, 0.7)'
        },
        'createdSomeAccepted': {
            name: 'В пути',
            gradient: {
                type: 'linear',
                x: 0, y: 0, x2: 0, y2: 1,
                colorStops: [
                    { offset: 0, color: '#FFD700' },
                    { offset: 0.5, color: '#FFC400' },
                    { offset: 1, color: '#FFA500' }
                ]
            },
            borderColor: '#ffb300',
            shadowColor: 'rgba(255, 165, 0, 0.7)'
        },
        'unknown': {
            name: 'Статус неизвестен',
            gradient: {
                type: 'linear',
                x: 0, y: 0, x2: 0, y2: 1,
                colorStops: [
                    { offset: 0, color: '#DCDCDCFF' },
                    { offset: 0.5, color: '#BBBBBBFF' },
                    { offset: 1, color: '#959595FF' }
                ]
            },
            borderColor: '#868686FF',
            shadowColor: 'rgba(214, 214, 214, 0.7)'
        }
    };

    // Функция для получения конфигурации статуса
    function getStatusConfig(status) {
        return statusConfig[status] || statusConfig['unknown'];
    }

    function collectDataFromTable() {
        const drivers = {};
        const rows = document.querySelectorAll('.tpi-infi--table--tbody tr:not(.tpi-infi--table-preloader)');


        rows.forEach(row => {
            const isMulti = row.hasAttribute("multiple-inbound-driver");
            const driverCell = row.querySelector('td:nth-child(2)');
            if (!driverCell) return;
            // const carNumber = data.shipment.courier?.carNumber || 'Не указан';
            // if (!isValidDriver(driver, carNumber)) {
            //     return;
            // }
            let nameNode = driverCell.querySelector('.tpi-infi--table-data-wrapper p:first-child');
            if (!nameNode) return;
            let tmp = nameNode.cloneNode(true);
            tmp.querySelectorAll('svg,a').forEach(el => el.remove());
            const fullName = tmp.textContent.trim();
            if (!fullName) return;

            // Форматируем имя водителя
            const parts = fullName.split(' ').filter(Boolean);
            let driver = parts[0] || '';
            if (parts[1]) driver += ' ' + parts[1][0] + '.';
            if (parts[2]) driver += parts[2][0] + '.';

            // Получаем данные ТС (берем из первой ячейки)
            const vehicleCell = row.querySelector('td:nth-child(9)');
            let vehicleInfo = '—';
            if (vehicleCell) {
                const firstVehicleDiv = vehicleCell.querySelector('div:first-child');
                if (firstVehicleDiv) {
                    const vehicleTmp = firstVehicleDiv.cloneNode(true);
                    vehicleTmp.querySelectorAll('svg').forEach(el => el.remove());
                    vehicleInfo = vehicleTmp.textContent.trim().replace(/\s+/g, ' ');
                }
            }

            // Получаем статус поставки
            const statusElement = driverCell.querySelector('.tpi-infi--table-inbound-status');
            const status = statusElement ? statusElement.getAttribute('current-state') : 'unknown';
            const statusConfig = getStatusConfig(status);

            if (!drivers[driver]) {
                drivers[driver] = { 
                    total: 0, 
                    shipments: [], 
                    driver: driver,
                    vehicleInfo: vehicleInfo,
                    status: status,
                    statusConfig: statusConfig
                };
            }

            if (isMulti) {
                // Обрабатываем множественные поставки
                const supplierCells = row.querySelectorAll('.tpi-infi--table-suplier div');
                
                // ИСПРАВЛЕНИЕ: Берем данные из правильных ячеек
                const orderCells = row.querySelectorAll('.tpi-infi--table-orders-data div a.tpi-infi--inbound-incom-data');
                const lotCells = row.querySelectorAll('.tpi-infi--table-lots-data div a.tpi-infi--inbound-incom-data');
                
                // Для multiple inbounds берем данные из колонки "Всего посылок в двух ТС"
                const combinedOrdersCell = row.querySelector('.tpi-infi--table-combined-orders-data');
                let totalOrders = 0;
                
                if (combinedOrdersCell) {
                    const combinedText = combinedOrdersCell.textContent.trim();
                    totalOrders = parseInt(combinedText) || 0;
                }

                // Обрабатываем каждую поставку в multiple
                for (let i = 0; i < supplierCells.length; i++) {
                    const supplier = shortenSupplierName(supplierCells[i].textContent.trim());
                    
                    // ИСПРАВЛЕНИЕ: Правильно извлекаем данные о заказах
                    let shipmentTotal = 0;
                    if (orderCells[i]) {
                        const orderText = orderCells[i].textContent.trim();
                        const match = orderText.match(/(\d+)\s*\/\s*(\d+)/);
                        if (match) {
                            shipmentTotal = parseInt(match[2]); // Берем второе число (план)
                            // console.log(`Found orders: ${match[1]}/${match[2]} -> using ${shipmentTotal}`);
                        }
                    }

                    // ИСПРАВЛЕНИЕ: Правильно извлекаем данные о лотах
                    let lotsTotal = 0;
                    if (lotCells[i]) {
                        const lotText = lotCells[i].textContent.trim();
                        const lotsMatch = lotText.match(/(\d+)\s*\/\s*(\d+)/);
                        if (lotsMatch) {
                            lotsTotal = parseInt(lotsMatch[2]); // Берем второе число (план)
                            // console.log(`Found lots: ${lotsMatch[1]}/${lotsMatch[2]} -> using ${lotsTotal}`);
                        }
                    }

                    drivers[driver].shipments.push({
                        supplier,
                        total: shipmentTotal,
                        lotsTotal
                    });
                }
                
                // Если combined orders есть, используем его, иначе суммируем
                if (totalOrders > 0) {
                    drivers[driver].total = totalOrders;
                } else {
                    drivers[driver].total = drivers[driver].shipments.reduce((sum, shipment) => sum + shipment.total, 0);
                }

            } else {
                // Обрабатываем одиночную поставку
                // ИСПРАВЛЕНИЕ: Правильные селекторы для single поставок
                const packagesCell = row.querySelector('.tpi-infi--table-orders-data a.tpi-infi--inbound-incom-data');
                let total = 0;
                if (packagesCell) {
                    const packageText = packagesCell.textContent.trim();
                    const match = packageText.match(/(\d+)\s*\/\s*(\d+)/);
                    if (match) total = parseInt(match[2]); // Берем второе число (план)
                }

                const lotsCell = row.querySelector('.tpi-infi--table-lots-data a.tpi-infi--inbound-incom-data');
                let lotsTotal = 0;
                if (lotsCell) {
                    const lotText = lotsCell.textContent.trim();
                    const lotsMatch = lotText.match(/(\d+)\s*\/\s*(\d+)/);
                    if (lotsMatch) lotsTotal = parseInt(lotsMatch[2]); // Берем второе число (план)
                }

                const supplierCell = row.querySelector('.tpi-infi--table-suplier div');
                const supplier = shortenSupplierName(supplierCell ? supplierCell.textContent.trim() : 'Склад');

                drivers[driver].total += total;
                drivers[driver].shipments.push({
                    supplier,
                    total,
                    lotsTotal
                });
            }
        });

        return drivers;
    }

    function updateChart() {
      const driversData = collectDataFromTable();
      const drivers = Object.values(driversData);

      if (!drivers.length) {
        chart.clear();
        return;
      }

      // Сортируем по общему количеству заказов
      drivers.sort((a, b) => b.total - a.total);

      // Подготавливаем данные для графика
      const categories = drivers.map((driver) => driver.driver);
      const seriesData = drivers.map((driver) => ({
        value: driver.total,
        status: driver.status,
        statusConfig: driver.statusConfig,
      }));

      const option = {
        backgroundColor: "#fff",
        tooltip: {
          trigger: "axis",
          confine: true,
          backgroundColor: "rgba(0, 0, 0, .8)",
          textStyle: {
            color: "#333",
            fontSize: 12,
          },
          axisPointer: {
            type: "cross",
            lineStyle: {
              type: "dashed",
              color: "#7d7d7d",
              width: 1,
            },
            crossStyle: {
              color: "#7d7d7d",
            },
            label: {
              backgroundColor: "#fc0",
              color: "#000",
              fontSize: 11,
            },
          },
          formatter: function (params) {
            const driver = drivers[params[0].dataIndex];

            let html = `
                        <div class="tpi-infi--graph-tooltip">
                            <div class="tpi-infi--graph-tooltip-driver-data">
                                ${tpiIcon__person}${driver.driver}
                                <span style="color:${driver.statusConfig.borderColor}; margin-left:8px;">
                                    ${driver.statusConfig.name}
                                </span>
                            </div>`;

            // Отображаем все поставки
            driver.shipments.forEach((shipment, index) => {
              if (index === 0) {
                // Первая поставка - более выделенно
                html += `
                                <div class="tpi-infi--graph-flex-wrapper" style="margin-bottom:${
                                  driver.shipments.length > 1 ? "18px" : "0"
                                }">
                                    <div class="tpi-infi--graph-tooltip-suplier-data">
                                        ${tpiIcon__inbounds}${shipment.supplier}
                                    </div>
                                    <div class="tpi-infi--graph-tooltip-income-data">
                                        ${tpiIcon__box}Заказы: ${shipment.total}
                                    </div>
                                    <div class="tpi-infi--graph-tooltip-income-data">
                                        ${tpiIcon__pallet}Лоты: ${
                  shipment.lotsTotal
                }
                                    </div>
                                </div>`;
              } else {
                // Остальные поставки
                html += `
                                <div class="tpi-infi--graph-flex-wrapper" style="margin-bottom:${
                                  index < driver.shipments.length - 1
                                    ? "6px"
                                    : "0"
                                }">
                                    <div class="tpi-infi--graph-tooltip-suplier-data">
                                        ${tpiIcon__inbounds}${shipment.supplier}
                                    </div>
                                    <div class="tpi-infi--graph-tooltip-income-data">
                                        ${tpiIcon__box}Заказы: ${shipment.total}
                                    </div>
                                    <div class="tpi-infi--graph-tooltip-income-data">
                                        ${tpiIcon__pallet}Лоты: ${
                  shipment.lotsTotal
                }
                                    </div>
                                </div>`;
              }
            });

            // Общая информация
            html += `
                            <div class="tpi-infi--graph-flex-wrapper" style="border-top:1px solid #eee;margin-top:8px;padding-top:8px;">
                                <div class="tpi-infi--graph-tooltip-driver-total-data">
                                    ${tpiIcon__packages}Всего заказов: ${driver.total}
                                </div>
                                <div class="tpi-infi--graph-tooltip-driver-total-data">
                                    ${tpiIcon__truck}ТС: ${driver.vehicleInfo}
                                </div>
                            </div>
                        </div>`;

            return html;
          },
        },
        grid: {
          left: "3%",
          right: "3%",
          bottom: "3%",
          top: "3%",
          containLabel: true,
        },
        xAxis: {
          type: "category",
          data: categories,
          axisLabel: {
            show: false,
          },
          axisTick: {
            show: false,
          },
          axisLine: {
            show: false,
          },
          splitLine: {
            show: false,
          },
        },
        yAxis: {
          type: "value",
          axisLine: {
            show: true,
            lineStyle: {
              color: "#e8e8e8",
            },
          },
          axisTick: {
            show: false,
          },
          axisLabel: {
            color: "#666",
            fontSize: 10,
          },
          splitLine: {
            lineStyle: {
              color: "#f0f0f0",
              type: "dashed",
            },
          },
        },
        series: [
          {
            name: "Заказы",
            type: "bar",
            data: seriesData.map((item, index) => ({
              value: item.value,
              itemStyle: {
                color: item.statusConfig.gradient,
                borderColor: item.statusConfig.borderColor,
                borderWidth: 1,
                borderRadius: [10, 10, 0, 0],
              },
              emphasis: {
                itemStyle: {
                  shadowBlur: 15,
                  shadowColor: item.statusConfig.shadowColor, // задаем напрямую
                  shadowOffsetX: 0,
                  shadowOffsetY: 3,
                },
              },
            })),
            barWidth: "50%",
          },
        ],
      };

      chart.setOption(option, true);
    }

    // Обновляем график при изменении данных
    const observer = new MutationObserver(() => {
        setTimeout(updateChart, 100);
    });
    
    const tbody = document.querySelector('.tpi-infi--table--tbody');
    if (tbody) {
        observer.observe(tbody, { 
            childList: true, 
            subtree: true 
        });
    }

    // Автоматическое изменение размера
    window.addEventListener('resize', () => {
        if (chart && !chart.isDisposed()) {
            chart.resize();
        }
    });

    // Инициализация
    setTimeout(() => {
        if (chart && !chart.isDisposed()) {
            chart.resize();
            updateChart();
        }
    }, 100);
}

async function generateInboundsPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
        orientation: "p",
        unit: "mm",
        format: "a4"
    });

    // === Подключение Roboto ===
    try {
        const fontPaths = {
            regular: chrome.runtime.getURL('fonts/Roboto-Regular.ttf'),
            bold: chrome.runtime.getURL('fonts/Roboto-Bold.ttf'),
            black: chrome.runtime.getURL('fonts/Roboto-Black.ttf')
        };

        const loadFont = async (path) => {
            const response = await fetch(path);
            const buffer = await response.arrayBuffer();
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const chunk = 0x8000;
            for (let i = 0; i < bytes.length; i += chunk) {
                binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
            }
            return btoa(binary);
        };

        pdf.addFileToVFS("Roboto-Regular.ttf", await loadFont(fontPaths.regular));
        pdf.addFont("Roboto-Regular.ttf", "Roboto", "normal");
        pdf.addFileToVFS("Roboto-Bold.ttf", await loadFont(fontPaths.bold));
        pdf.addFont("Roboto-Bold.ttf", "Roboto", "bold");
        pdf.addFileToVFS("Roboto-Black.ttf", await loadFont(fontPaths.black));
        pdf.addFont("Roboto-Black.ttf", "Roboto", "black");
        pdf.setFont("Roboto", "normal");
    } catch (e) {
        console.log("Не удалось подключить Roboto", e);
        pdf.setFont("helvetica", "normal");
    }

    // === Загрузка PNG иконок ===
    async function loadPNGIcon(path) {
        try {
            const response = await fetch(path);
            const blob = await response.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        } catch (e) {
            console.log('Не удалось загрузить иконку:', path, e);
            return null;
        }
    }

    let truckIcon, inboundIcon, packagesIcon;
    
    try {
        truckIcon = await loadPNGIcon(chrome.runtime.getURL('img/svg/tpiTruck.png'));
        inboundIcon = await loadPNGIcon(chrome.runtime.getURL('img/svg/tpiInbound.png'));
        packagesIcon = await loadPNGIcon(chrome.runtime.getURL('img/svg/tpiPackages.png'));
    } catch (e) {
        console.log("Не удалось загрузить иконки", e);
    }

    // === Настройки таблицы ===
    const headers = ["№", "СЦ Отправитель", "Заказов", "Всего", "ФИО Водителя", "Телефон", "QR Код", "ПВП", "ОВП", "Отгрузка","Компания"];
    const colWidths = [8, 45, 20, 20, 45, 45, 18, 35, 22, 22, 24];
    const totalWidth = colWidths.reduce((a, b) => a + b, 0);
    const scale = (pdf.internal.pageSize.getWidth() - 4) / totalWidth;
    for (let i = 0; i < colWidths.length; i++) colWidths[i] *= scale;

    const marginX = 2;
    const marginY = 2;
    let cursorY = marginY;
    const fontSize = 9;

    // === Функции ===
    function shortenSupplierName(name) {
        if (!name) return '';
        const patterns = [
            { regex: /СЦ Яндекс\.?Маркет СПБ Бугры/, replacement: 'СЦ СПБ Бугры' },
            { regex: /Склад,? СЦ Яндекс\.?Маркет Строгино/, replacement: 'СЦ Строгино' },
            { regex: /Склад СЦ Яндекс\.? ?Маркет Тарный/, replacement: 'СЦ МК Тарный' },
            { regex: /Склад СЦ Яндекс\.?Маркет \(Ростов\)/, replacement: 'СЦ МК Ростов' },
            { regex: /МО Домодедово КГТ/, replacement: 'Домодедово КГТ' },
            { regex: /ООО «Маркет\.Операции» \(Ростов-на-Дону КГТ\)/, replacement: 'Ростов КГТ' },
            { regex: /ООО «Маркет\.Операции» \(Московская область, Софьино\)/, replacement: 'Софьино ФФЦ' },
            { regex: /ООО «Маркет\.Операции» \(Софьино КГТ\)/, replacement: 'Софьино КГТ' },
            { regex: /СЦ Яндекс\.?Маркет (.+)/, replacement: 'СЦ $1' },
            { regex: /Склад СЦ Яндекс\.?Маркет (.+)/, replacement: 'СЦ $1' },
            { regex: /ООО «Маркет\.Операции» \((.+)\)/, replacement: '$1' }
        ];
        for (const pattern of patterns) {
            if (pattern.regex.test(name)) return name.replace(pattern.regex, pattern.replacement);
        }
        return name;
    }

    function drawTextWithWrap(text, x, y, maxWidth, rowHeight, fontStyle = "normal", fontSz = fontSize, align = "center") {
        pdf.setFont("Roboto", fontStyle);
        pdf.setFontSize(fontSz);

        const initialLines = text.split('\n');
        const lines = [];
        
        // Для каждой строки применяем перенос по словам
        initialLines.forEach(initialLine => {
            const words = initialLine.split(/\s+/);
            let line = '';
            words.forEach(word => {
                const testLine = line ? line + ' ' + word : word;
                if (pdf.getTextWidth(testLine) <= maxWidth - 2) {
                    line = testLine;
                } else {
                    if (line) lines.push(line);
                    line = word;
                }
            });
            if (line) lines.push(line);
        });

        const lineHeight = 4;
        const startY = y + (rowHeight - lines.length * lineHeight) / 2 + lineHeight/2;
        lines.forEach((l, idx) => {
            pdf.text(l, x + maxWidth / 2, startY + idx * lineHeight, { align: align, baseline: "middle" });
        });
    }

    function drawSupplierCell(text, x, y, width, height) {
        pdf.setFont("Roboto", "black");
        pdf.setFontSize(fontSize);
        
        const lines = text.split('\n');
        const lineHeight = 4;
        const startY = y + (height - lines.length * lineHeight) / 2 + lineHeight/2;
        
        lines.forEach((line, idx) => {
            pdf.text(line, x + width / 2, startY + idx * lineHeight, { align: "center", baseline: "middle" });
        });
    }

    function drawOrdersCell(text, x, y, width, height) {
        pdf.setFont("Roboto", "normal");
        pdf.setFontSize(fontSize);
        
        const lines = text.split('\n');
        const lineHeight = 4;
        
        const totalTextHeight = lines.length * lineHeight;
        const startY = y + (height - totalTextHeight) / 2 + lineHeight/2;
        
        lines.forEach((line, idx) => {
            pdf.text(line, x + width / 2, startY + idx * lineHeight, { align: "center", baseline: "middle" });
        });
    }

    // Функция для добавления иконки с текстом
    function drawStatisticWithIcon(iconData, text, x, y) {
        const iconSize = 4; // 4mm размер иконки
        
        if (iconData) {
            // Добавляем PNG иконку
            try {
                pdf.addImage(iconData, 'PNG', x, y, iconSize, iconSize);
            } catch (e) {
                console.warn('Не удалось добавить иконку:', e);
            }
        }
        
        // Добавляем текст с Roboto Black
        pdf.setFont("Roboto", "black");
        pdf.setFontSize(10);
        pdf.text(text, x + iconSize + 1, y + iconSize/2 + 1);
    }

    async function generateQRCodeDataURL(text, canvasSize = 150) {
        return new Promise(resolve => {
            const qrContainer = document.createElement("div");
            new QRCode(qrContainer, { text, width: canvasSize, height: canvasSize, correctLevel: QRCode.CorrectLevel.M });
            setTimeout(() => {
                const img = qrContainer.querySelector("img");
                if (img) resolve(img.src);
                else resolve(qrContainer.querySelector("canvas").toDataURL());
            }, 100);
        });
    }

    // === Статистика сверху с PNG иконками ===
    const totalTrucks = document.querySelector("#tpi-infi--inbounds-trucks")?.textContent || '';
    const totalSupplies = document.querySelector("#tpi-infi--inbounds-total")?.textContent || '';
    const totalOrders = document.querySelector("#tpi-infi--places-total")?.textContent || '';
    const formattedDate = new Date().toLocaleDateString('ru-RU');

    // Статистика в столбик с PNG иконками
    let statsY = cursorY;
    
    // Всего ТС с иконкой грузовика
    drawStatisticWithIcon(truckIcon, `Всего ТС: ${totalTrucks}`, marginX, statsY);
    
    statsY += 6;
    
    // Поставок с иконкой
    drawStatisticWithIcon(inboundIcon, `Поставок: ${totalSupplies}`, marginX, statsY);
    
    statsY += 6;
    
    // Заказов с иконкой
    drawStatisticWithIcon(packagesIcon, `Заказов: ${totalOrders}`, marginX, statsY);

    // Дата справа
    const pageWidth = pdf.internal.pageSize.getWidth();
    pdf.setFont("Roboto", "normal");
    pdf.text(formattedDate, pageWidth - marginX, cursorY + 5, { align: "right" });

    cursorY += 20; // Увеличиваем отступ после статистики

    // === Заголовки таблицы ===
    pdf.setFont("Roboto", "bold");
    pdf.setFontSize(fontSize);
    let x = marginX;
    headers.forEach((h, i) => {
        pdf.rect(x, cursorY, colWidths[i], 10);
        drawTextWithWrap(h, x, cursorY, colWidths[i], 10);
        x += colWidths[i];
    });
    cursorY += 10;
    pdf.setFont("Roboto", "normal");

    // === Обработка строк таблицы ===
    let rowIndex = 1;
    const tableRows = document.querySelectorAll(".tpi-infi--inbounds-data tbody tr");

    for (const tr of tableRows) {
        const isMulti = tr.hasAttribute("multiple-inbound-driver");
        const isOddRow = rowIndex % 2 === 1;

        let suppliersText = '';
        let ordersText = '';
        let combinedOrders = '';
        let driverFormatted = '';
        let driverPhone = '';
        let plannedArivalTime = '';

        if (isMulti) {
            const supliers = Array.from(tr.querySelectorAll(".tpi-infi--table-suplier div"))
                .map(d => shortenSupplierName(d.textContent.trim()));
            const ordersList = Array.from(tr.querySelectorAll("td div a.tpi-infi--table-orders-data"))
                .map(a => {
                    const text = a.textContent.trim();
                    return text.includes("/") ? text.split("/")[1].trim() : text;
                });
            combinedOrders = tr.querySelector(".tpi-infi--table-combined-orders-data p")?.textContent.trim() || "";
            driverFormatted = tr.querySelector(".tpi-infi--table-driver span p:first-child")?.textContent.trim() || "";
            suppliersText = supliers.join('\n');
            ordersText = ordersList.join('\n');
            driverPhone = tr.querySelector(".tpi-infi--table-driver span p.tpi-infi--table-driver-phone")?.textContent.trim() || "";
            let plannedDate = tr.querySelector(".tpi-infi--table-income-date span p.tpi-infi-arival-planned-day")?.textContent.trim() || "";
            let plannedTime = tr.querySelector(".tpi-infi--table-income-date span p.tpi-infi-arival-planned-time")?.textContent.trim() || "";
            plannedArivalTime = plannedDate + '\n' + plannedTime;
        } else {
            suppliersText = shortenSupplierName(tr.querySelector(".tpi-infi--table-suplier div")?.textContent.trim() || "");
            let ordersSingle = tr.querySelector("td a.tpi-infi--table-orders-data")?.textContent.trim() || "";
            ordersSingle = ordersSingle.includes("/") ? ordersSingle.split("/")[1].trim() : ordersSingle;
            ordersText = ordersSingle;
            combinedOrders = tr.querySelector(".tpi-infi--table-combined-orders-data")?.textContent.trim() || "";
            driverFormatted = tr.querySelector(".tpi-infi--table-driver span p:first-child")?.textContent.trim() || "";
            driverPhone = tr.querySelector(".tpi-infi--table-driver span p.tpi-infi--table-driver-phone")?.textContent.trim() || "";
            let plannedDate = tr.querySelector(".tpi-infi--table-income-date span p.tpi-infi-arival-planned-day")?.textContent.trim() || "";
            let plannedTime = tr.querySelector(".tpi-infi--table-income-date span p.tpi-infi-arival-planned-time")?.textContent.trim() || "";
            plannedArivalTime = plannedDate + '\n' + plannedTime;
        }

        const row = [
            String(rowIndex++),
            suppliersText,
            ordersText,
            combinedOrders,
            driverFormatted,
            driverPhone,
            null,
            plannedArivalTime,
            "",
            "",
            ""
        ];

        const qrSize = 10;
        const rowHeight = Math.max(12, (suppliersText.split('\n').length * 4) + 4); // Динамическая высота строки

        let x = marginX;
        for (let ci = 0; ci < row.length; ci++) {
            pdf.setFillColor(isOddRow ? 245 : 255, isOddRow ? 245 : 255, isOddRow ? 245 : 255);
            pdf.setDrawColor(0, 0, 0);
            pdf.rect(x, cursorY, colWidths[ci], rowHeight);

            if (ci === 1) {
                // Колонка "Поставка от" - выравнивание по центру для всех строк
                drawSupplierCell(row[ci], x, cursorY, colWidths[ci], rowHeight);
            } else if (ci === 2) {
                // Колонка "Заказов" - каждое значение с новой строки
                drawOrdersCell(row[ci] || '', x, cursorY, colWidths[ci], rowHeight);
            } else if (ci === 4) {
                // Колонка "Водитель" - перенос текста
                drawTextWithWrap(row[ci] || '', x, cursorY, colWidths[ci], rowHeight, "normal", fontSize, "center");
            } else if (ci === 6 && driverPhone) {
                // QR код
                const qrDataURL = await generateQRCodeDataURL(`tel:${driverPhone}`);
                const qrX = x + (colWidths[ci] - qrSize) / 2;
                const qrY = cursorY + (rowHeight - qrSize) / 2;
                pdf.addImage(qrDataURL, 'PNG', qrX, qrY, qrSize, qrSize);
            } else {
                drawTextWithWrap(row[ci] || '', x, cursorY, colWidths[ci], rowHeight, "normal", fontSize, "center");
            }

            x += colWidths[ci];
        }

        cursorY += rowHeight;
        if (cursorY > pdf.internal.pageSize.getHeight() - 20) {
            pdf.addPage();
            cursorY = marginY;
        }
    }

    const pdfBlob = pdf.output("blob");
    const pdfURL = URL.createObjectURL(pdfBlob);
    window.open(pdfURL, "_blank");
}

// Добавляем обработчики для кнопок переключения графиков
function initGraphSwitchers() {
    const lineBtn = document.getElementById('tpi-infi--graph-line');
    const barBtn = document.getElementById('tpi-infi--graph-bar');
    
    if (lineBtn && barBtn) {
        // Убираем старые обработчики
        lineBtn.replaceWith(lineBtn.cloneNode(true));
        barBtn.replaceWith(barBtn.cloneNode(true));
        
        // Получаем новые элементы
        const newLineBtn = document.getElementById('tpi-infi--graph-line');
        const newBarBtn = document.getElementById('tpi-infi--graph-bar');
        
        // Добавляем новые обработчики
        newLineBtn.addEventListener('click', switchToLineGraph);
        newBarBtn.addEventListener('click', switchToBarGraph);
    }
}

// Функция для переключения на столбчатый график (данные за день)
// Глобальная переменная для хранения текущего графика
let currentChart = null;
let currentChartType = 'bar';
let monthDataCache = null;
let monthDataLoading = false;
let monthDataLoadPromise = null;

// Функция для переключения на линейный график (данные за месяц)
function switchToLineGraph() {
    const lineBtn = document.getElementById('tpi-infi--graph-line');
    const barBtn = document.getElementById('tpi-infi--graph-bar');
    
    if (currentChartType === 'line') return;
    
    // Блокируем кнопки
    lineBtn.disabled = true;
    barBtn.disabled = true;
    
    // Обновляем состояние кнопок
    lineBtn.setAttribute('current-state', 'checked');
    barBtn.setAttribute('current-state', 'unchecked');
    
    // Обновляем заголовок
    const graphTitle = document.querySelector('.tpi-infi--graph-title');
    if (graphTitle) {
        graphTitle.textContent = 'График всех поставок за последние 30 дней';
    }
    
    // Полностью очищаем предыдущий график
    if (currentChart) {
        try {
            if (!currentChart.isDisposed()) {
                currentChart.dispose();
            }
        } catch (e) {
            console.log('Ошибка при уничтожении предыдущего графика:', e);
        }
        currentChart = null;
    }
    
    // Загружаем данные за последние 30 дней
    initMonthStatisticsGraph()
        .catch(error => {
            console.error('Ошибка при загрузке графика за последние 30 дней:', error);
            const graphContainer = document.querySelector('.tpi-infi--statistic-graph');
            if (graphContainer) {
                graphContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">Ошибка загрузки данных за последние 30 дней</div>';
            }
        })
        .finally(() => {
            // Разблокируем кнопки после загрузки
            lineBtn.disabled = false;
            barBtn.disabled = false;
        });
    
    currentChartType = 'line';
}

// Функция для принудительного обновления данных
function refreshMonthData() {
    console.log('Принудительное обновление данных за последние 30 дней...');
    monthDataCache = null;
    monthDataLoadPromise = null;
    startBackgroundDataLoading();
}

function switchToBarGraph() {
    const lineBtn = document.getElementById('tpi-infi--graph-line');
    const barBtn = document.getElementById('tpi-infi--graph-bar');
    
    if (currentChartType === 'bar') return;
    
    // Блокируем кнопки
    lineBtn.disabled = true;
    barBtn.disabled = true;
    
    // Обновляем состояние кнопок
    lineBtn.setAttribute('current-state', 'unchecked');
    barBtn.setAttribute('current-state', 'checked');
    
    // Обновляем заголовок
    const graphTitle = document.querySelector('.tpi-infi--graph-title');
    if (graphTitle) {
        graphTitle.textContent = 'График текущих поставок';
    }
    
    // Полностью очищаем текущий график
    if (currentChart) {
        try {
            if (!currentChart.isDisposed()) {
                currentChart.dispose();
            }
        } catch (e) {
            console.warn('Ошибка при уничтожении графика:', e);
        }
        currentChart = null;
    }
    
    // Очищаем контейнер
    const graphContainer = document.querySelector('.tpi-infi--statistic-graph');
    
    // Возвращаем дневной график
    setTimeout(() => {
        try {
            initStatisticsGraph();
            currentChartType = 'bar';
        } catch (error) {
            console.error('Ошибка при переключении на столбчатый график:', error);
            if (graphContainer) {
                graphContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">Ошибка загрузки данных</div>';
            }
        } finally {
            // Разблокируем кнопки после переключения
            lineBtn.disabled = false;
            barBtn.disabled = false;
        }
    }, 100);
}
// Функция для получения данных за месяц и построения линейного графика
async function initMonthStatisticsGraph() {
    const graphContainer = document.querySelector('.tpi-infi--statistic-graph');
    if (!graphContainer) return;

    // Полностью очищаем контейнер
    graphContainer.innerHTML = '';
    
    try {
        let data;
        
        // Если данные уже загружены, используем их
        if (monthDataCache) {
            console.log('Используем кэшированные данные');
            data = monthDataCache;
        } 
        // Если данные в процессе загрузки, ждем их
        else if (monthDataLoadPromise) {
            console.log('Ожидание завершения фоновой загрузки...');
            data = await monthDataLoadPromise;
        }
        // Если данных нет и они не загружаются, загружаем сейчас
        else {
            console.log('Загрузка данных...');
            data = await fetchLast30DaysDataParallel();
            monthDataCache = data;
        }
        
        // Обрабатываем данные
        const dailyData = processMonthData(data);
        
        // Очищаем контейнер и создаем график
        graphContainer.innerHTML = '';
        const chartElement = document.createElement('div');
        chartElement.style.height = '100%';
        graphContainer.appendChild(chartElement);
        
        // Создаем новый график
        currentChart = echarts.init(chartElement);
        
        // Строим линейный график
        buildLineChart(currentChart, dailyData);
        
    } catch (error) {
        console.error('Ошибка при получении данных за последние 30 дней:', error);
        
        // Показываем сообщение об ошибке в контейнере
        graphContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: red;">Ошибка загрузки данных за последние 30 дней</div>';
        
        throw error;
    }

    // Автоматическое изменение размера
    const resizeHandler = () => {
        if (currentChart && !currentChart.isDisposed()) {
            currentChart.resize();
        }
    };
    
    window.addEventListener('resize', resizeHandler);
}


function startBackgroundDataLoading() {
    if (!monthDataLoadPromise && !monthDataCache) {
        console.log('Запуск фоновой загрузки данных за последние 30 дней...');
        monthDataLoading = true;
        monthDataLoadPromise = fetchLast30DaysDataParallel()
            .then(data => {
                monthDataCache = data;
                monthDataLoading = false;
                console.log('Фоновая загрузка данных завершена. Поставок:', data.length);
                return data;
            })
            .catch(error => {
                console.error('Ошибка фоновой загрузки данных:', error);
                monthDataLoading = false;
                monthDataLoadPromise = null;
                throw error;
            });
    }
    return monthDataLoadPromise;
}

// Функция для параллельной загрузки данных за последние 30 дней
async function fetchLast30DaysDataParallel() {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - 30);
    
    // Создаем массив промисов для всех недельных интервалов
    const promises = [];
    let currentStart = new Date(startDate);
    
    while (currentStart <= endDate) {
        const currentEnd = new Date(currentStart);
        currentEnd.setDate(currentStart.getDate() + 6);
        const chunkEnd = currentEnd > endDate ? endDate : currentEnd;
        
        const dateFrom = formatDateForAPI(currentStart);
        const dateTo = formatDateForAPI(chunkEnd);
        
        // Добавляем промис в массив (без await - запускаем параллельно)
        promises.push(
            fetchShipmentsForPeriod(dateFrom, dateTo)
                .then(data => {
                    console.log(`Загружены данные с ${dateFrom} по ${dateTo}: ${data.length} поставок`);
                    return data;
                })
                .catch(error => {
                    console.error(`Ошибка загрузки данных с ${dateFrom} по ${dateTo}:`, error);
                    return []; // Возвращаем пустой массив в случае ошибки
                })
        );
        
        // Переходим к следующей неделе
        currentStart.setDate(currentStart.getDate() + 7);
    }
    
    // Ждем завершения всех промисов параллельно
    console.log(`Запущено ${promises.length} параллельных запросов`);
    const results = await Promise.all(promises);
    
    // Объединяем все данные
    const allShipments = results.flat();
    console.log(`Всего загружено поставок: ${allShipments.length}`);
    
    return allShipments;
}

// Функция для форматирования даты для API (гггг-мм-дд)
function formatDateForAPI(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Функция для обработки данных за месяц
function processMonthData(shipments) {
    const dailyStats = {};
    
    // debugShipmentData(shipments);
    // Городы для исключения (как в основной функции)
    const excludedCities = ['Липецк', 'Курск', 'Белгород'];
    
    shipments.forEach(shipment => {
        // Применяем те же фильтры, что и в основной функции
        if (shipment.supplierName) {
            const shouldExclude = excludedCities.some(city => 
                shipment.supplierName.includes(city)
            );
            
            if (shouldExclude) {
                return; // пропускаем этот shipment
            }
        }
        
        // Проверяем acceptance place total и lot total
        const placeTotal = shipment.acceptance?.place?.total || 0;
        const lotTotal = shipment.acceptance?.lot?.total || 0;
        
        if (placeTotal === 0 && lotTotal === 0) {
            return; // пропускаем
        }
        
        // Используем дату из arrival.planned.finish или start
        let arrivalDate;
        if (shipment.arrival?.planned?.finish) {
            arrivalDate = new Date(shipment.arrival.planned.finish);
        } else if (shipment.arrival?.planned?.start) {
            arrivalDate = new Date(shipment.arrival.planned.start);
        } else {
            return; // пропускаем если нет даты
        }
        
        const dateKey = formatDateForAPI(arrivalDate);
        
        if (!dailyStats[dateKey]) {
            dailyStats[dateKey] = {
                date: dateKey,
                totalOrders: 0,
                totalShipments: 0
            };
        }
        
        // Суммируем общее количество заказов
        const orders = shipment.acceptance?.place?.total || 0;
        
        dailyStats[dateKey].totalOrders += orders;
        dailyStats[dateKey].totalShipments += 1;
    });
    
    // Преобразуем в массив и сортируем по дате
    const result = Object.values(dailyStats)
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // console.log('Обработанные данные за месяц:', result);
    
    // ДЕБАГ: Проверяем, есть ли данные
    if (result.length === 0) {
        console.warn('Нет данных для отображения графика за месяц');
    }
    
    return result;
}

// Функция для проверки, является ли водитель валидным (есть имя и номер машины)
function isValidDriver(driverName, carNumber) {
    return driverName && 
           driverName !== 'Не указано' && 
           driverName !== 'ошибка загрузки' &&
           driverName.trim() !== '' &&
           carNumber && 
           carNumber !== 'Не указан' &&
           carNumber !== 'null' &&
           carNumber.trim() !== '';
}

// Функция для фильтрации данных поставок перед вставкой в таблицу
function filterValidShipments(shipmentsData) {
    return shipmentsData.filter(data => {
        const carNumber = data.shipment.courier?.carNumber || 'Не указан';
        return isValidDriver(data.driverName, carNumber);
    });
}

// Функция для фильтрации поставок при группировке по водителям
function filterValidDriverGroups(groupedByDriver) {
    const validGroups = {};
    
    for (const driverKey in groupedByDriver) {
        const driverShipments = groupedByDriver[driverKey];
        const firstShipment = driverShipments[0];
        const carNumber = firstShipment.shipment.courier?.carNumber || 'Не указан';
        
        if (isValidDriver(firstShipment.driverName, carNumber)) {
            validGroups[driverKey] = driverShipments;
        }
    }
    
    return validGroups;
}

// Функция для построения линейного графика
function buildLineChart(chart, dailyData) {
    if (!dailyData || dailyData.length === 0) {
        console.warn('Нет данных для построения графика');
        try {
            chart.clear();
            chart.setOption({
                title: {
                    text: 'Нет данных за последние 30 дней',
                    left: 'center',
                    top: 'center',
                    textStyle: {
                        color: '#999',
                        fontSize: 14
                    }
                },
                xAxis: { show: false },
                yAxis: { show: false }
            }, true);
        } catch (error) {
            console.warn('Ошибка при очистке графика:', error);
        }
        return;
    }

    // Подготавливаем данные для графика
    const dates = dailyData.map(day => {
        const date = new Date(day.date);
        return `${date.getDate()} ${getMonthName(date.getMonth())}`;
    });
    
    const ordersData = dailyData.map(day => day.totalOrders);
    const shipmentsData = dailyData.map(day => day.totalShipments);

    // Устанавливаем минимум 10000 для оси Y заказов
    const maxOrders = Math.max(...ordersData, 10000);
    
    // Обновляем заголовок в тултипе для отражения периода
    const option = {
        backgroundColor: '#fff',
        animation: true,
        animationDuration: 1500,
        animationEasing: 'cubicOut',
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            borderColor: '#fc0',
            borderWidth: 1,
            textStyle: {
                color: '#333',
                fontSize: 12
            },
            formatter: function(params) {
                const dayData = dailyData[params[0].dataIndex];
                let html = `
                    <div style="padding:10px;font-family:Arial,sans-serif;min-width:200px;">
                        <div style="font-weight:bold;margin-bottom:8px;color:#333;">
                            ${dayData.date}
                        </div>`;
                
                params.forEach(param => {
                    html += `
                        <div style="margin-bottom:4px;display:flex;align-items:center;">
                            <span style="display:inline-block;width:8px;height:8px;background:${param.color};border-radius:50%;margin-right:8px;"></span>
                            ${param.seriesName}: <strong style="margin-left:auto;">${param.value}</strong>
                        </div>`;
                });
                
                html += `</div>`;
                return html;
            }
        },
        legend: {
            data: ['Заказы', 'Поставки'],
            top: 0,
            textStyle: {
                fontSize: 11
            }
        },
        grid: {
            left: '3%',
            right: '3%',
            bottom: '3%',
            top: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates,
            axisLine: {
                lineStyle: {
                    color: '#e8e8e8'
                }
            },
            axisTick: {
                show: false
            },
            axisLabel: {
                color: '#666',
                fontSize: 10,
                rotate: dates.length > 10 ? 45 : 0
            }
        },
        yAxis: [
            {
                type: 'value',
                name: 'Заказы',
                nameTextStyle: {
                    fontSize: 10,
                    color: '#666'
                },
                min: 2500,
                max: maxOrders,
                axisLine: {
                    show: true,
                    lineStyle: {
                        color: '#e8e8e8'
                    }
                },
                axisTick: {
                    show: false
                },
                axisLabel: {
                    color: '#666',
                    fontSize: 10
                },
                splitLine: {
                    lineStyle: {
                        color: '#f0f0f0',
                        type: 'dashed'
                    }
                }
            },
            {
                type: 'value',
                name: 'Поставки',
                nameTextStyle: {
                    fontSize: 10,
                    color: '#666'
                },
                axisLine: {
                    show: true,
                    lineStyle: {
                        color: '#e8e8e8'
                    }
                },
                axisTick: {
                    show: false
                },
                axisLabel: {
                    color: '#666',
                    fontSize: 10
                },
                splitLine: {
                    show: false
                }
            }
        ],
        series: [
            {
                name: 'Заказы',
                type: 'line',
                data: ordersData,
                smooth: true,
                symbol: 'circle',
                symbolSize: 6,
                lineStyle: {
                    width: 3,
                    color: '#cf0'
                },
                itemStyle: {
                    color: '#cf0'
                },
                animation: true,
                animationDuration: 1500,
                animationEasing: 'cubicOut'
            },
            {
                name: 'Поставки',
                type: 'line',
                yAxisIndex: 1,
                data: shipmentsData,
                smooth: true,
                symbol: 'circle',
                symbolSize: 6,
                lineStyle: {
                    width: 3,
                    color: '#fc0'
                },
                itemStyle: {
                    color: '#fc0'
                },
                animation: true,
                animationDuration: 1500,
                animationEasing: 'cubicOut',
                animationDelay: function(idx) {
                    return idx * 100;
                }
            }
        ]
    };

    try {
        chart.setOption(option, {
            notMerge: true,
            lazyUpdate: false
        });
    } catch (error) {
        console.log('Ошибка при установке опций графика:', error);
        try {
            if (!chart.isDisposed()) {
                chart.dispose();
            }
            const newContainer = document.querySelector('.tpi-infi--statistic-graph');
            if (newContainer) {
                newContainer.innerHTML = '';
                const newChartElement = document.createElement('div');
                newChartElement.style.height = '100%';
                newContainer.appendChild(newChartElement);
                currentChart = echarts.init(newChartElement);
                currentChart.setOption(option, true);
            }
        } catch (e) {
            console.log('Критическая ошибка при создании графика:', e);
        }
    }
}

// Функция для получения названия месяца
function getMonthName(monthIndex) {
    const months = [
        'янв', 'фев', 'мар', 'апр', 'мая', 'июн',
        'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'
    ];
    return months[monthIndex];
}

// Функция для получения данных за месяц по частям (неделям)
async function fetchMonthDataInChunks(startDate, endDate) {
    const allShipments = [];
    let currentStart = new Date(startDate);
    
    while (currentStart <= endDate) {
        // Вычисляем конец текущей недели (7 дней от начала)
        const currentEnd = new Date(currentStart);
        currentEnd.setDate(currentStart.getDate() + 6);
        
        // Если конец недели выходит за пределы конечной даты, используем конечную дату
        const chunkEnd = currentEnd > endDate ? endDate : currentEnd;
        
        const dateFrom = formatDateForAPI(currentStart);
        const dateTo = formatDateForAPI(chunkEnd);
        
        try {
            const chunkData = await fetchShipmentsForPeriod(dateFrom, dateTo);
            allShipments.push(...chunkData);
            
        } catch (error) {
            console.error(`Ошибка при загрузке данных с ${dateFrom} по ${dateTo}:`, error);
        }
        
        // Переходим к следующей неделе
        currentStart.setDate(currentStart.getDate() + 7);
    }
    
    return allShipments;
}

async function fetchShipmentsForPeriod(dateFrom, dateTo) {
    // const url = `https://hubs.market.yandex.ru/api/gateway/logpoint/21972131/inbounds/get-list?platformType=SORTING_CENTER&dateFrom=${dateFrom}&dateTo=${dateTo}&movementTypes=LINEHAUL&statuses=ARRIVED%2CIN_PROGRESS%2CSIGNED%2CFIXED%2CCREATED&page=0&size=1000`;
    const url = `https://hubs.market.yandex.ru/api/gateway/logpoint/21972131/inbounds/get-list?platformType=SORTING_CENTER&dateFrom=${dateFrom}&dateTo=${dateTo}&movementTypes=LINEHAUL&statuses=ARRIVED%2CIN_PROGRESS%2CSIGNED%2CFIXED%2CCREATED&types=&page=0&size=100`;
    
    const response = await fetch(url);
    
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    return data.content || [];
}

async function updateChartWithPartialData(shipments, startDate, currentEndDate) {
    if (!currentChart || currentChart.isDisposed()) return;
    
    try {
        // Обрабатываем текущие данные
        const dailyData = processMonthData(shipments);
        
        // Строим график с текущими данными
        buildLineChart(currentChart, dailyData);
        
    } catch (error) {
        console.log('Ошибка при обновлении графика с частичными данными:', error);
    }
}

//A- update table

function startAutoUpdate() {
    if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
    }
    
    autoUpdateTimeLeft = 10;
    updateProgressBar();
    
    autoUpdateInterval = setInterval(() => {
        const updateButton = document.querySelector('.tpi-infi--update-button');
        const buttonState = updateButton?.getAttribute('tpi-current-state');
        
        // Если обновление на паузе, сбрасываем таймер
        if (buttonState === 'paused') {
            resetAutoUpdate();
            return;
        }
        
        autoUpdateTimeLeft--;
        updateProgressBar();
        
        if (autoUpdateTimeLeft <= 0) {
            clearInterval(autoUpdateInterval);
            updateTableDataWithProgress();
        }
    }, 1000);
}

// Функция для обновления прогресс-бара и текста
function updateProgressBar() {
    const progressText = document.querySelector('.tpi-infi--update-info-text');
    const progressBar = document.querySelector('.tpi-infi--update-progress-bar');
    
    if (progressText) {
        progressText.textContent = `Обновление таблицы через ${autoUpdateTimeLeft}`;
    }
    
    if (progressBar) {
        const progressPercentage = 100 - (autoUpdateTimeLeft * 10);
        progressBar.style.width = `${progressPercentage}%`;
    }
}

// Функция для сброса автообновления
function resetAutoUpdate() {
    if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
        autoUpdateInterval = null;
    }
    
    autoUpdateTimeLeft = 10;
    updateProgressBar();
}

// Функция для обновления таблицы с отслеживанием прогресса
async function updateTableDataWithProgress() {
    if (isUpdating) return;
    
    isUpdating = true;
    
    // Блокируем кнопку принудительного обновления
    const forceUpdateButton = document.querySelector('.tpi-infi--force-update-button');
    if (forceUpdateButton) {
        forceUpdateButton.disabled = true;
        // Сохраняем начальное состояние для анимации
        const initialUpdateButtonState = document.querySelector('.tpi-infi--update-button').getAttribute('tpi-current-state');
        if (initialUpdateButtonState === 'paused') {
            setTimeout(() => {
                // Проверяем, что мы все еще в состоянии обновления
                if (isUpdating) {
                    forceUpdateButton.setAttribute('tpi-current-state', 'updating');
                }
            }, 2000);
        } else {
            forceUpdateButton.setAttribute('tpi-current-state', 'unset');
        }
    }
    
    try {
        await updateTableData();
    } catch (error) {
        console.error('Ошибка при обновлении таблицы:', error);
    } finally {
        isUpdating = false;
        
        // Разблокируем кнопку принудительного обновления
        if (forceUpdateButton) {
            forceUpdateButton.disabled = false;
            
            // Проверяем АКТУАЛЬНОЕ состояние кнопки обновления в момент завершения
            const currentUpdateButtonState = document.querySelector('.tpi-infi--update-button').getAttribute('tpi-current-state');
            
            if (currentUpdateButtonState === 'paused') {
                setTimeout(() => {
                    // Двойная проверка, что состояние не изменилось во время таймаута
                    const finalUpdateButtonState = document.querySelector('.tpi-infi--update-button').getAttribute('tpi-current-state');
                    if (finalUpdateButtonState === 'paused' && !isUpdating) {
                        forceUpdateButton.setAttribute('tpi-current-state', 'showed');
                    } else if (finalUpdateButtonState === 'playing') {
                        forceUpdateButton.setAttribute('tpi-current-state', 'unset');
                    }
                }, 2000);
            } else {
                // Если состояние playing - сразу ставим unset
                forceUpdateButton.setAttribute('tpi-current-state', 'unset');
            }
        }
        
        // Перезапускаем автообновление, если не на паузе
        const updateButton = document.querySelector('.tpi-infi--update-button');
        const buttonState = updateButton?.getAttribute('tpi-current-state');
        
        if (buttonState === 'playing') {
            startAutoUpdate();
        }
    }
}

// Функция для принудительного обновления
function forceUpdateTable() {
    if (isUpdating) return;
    
    // Сбрасываем текущий таймер
    resetAutoUpdate();
    
    // Запускаем обновление
    updateTableDataWithProgress();
}

// Модифицируем функцию autoUpdateTableData
function autoUpdateTableData(){
    if(autoUpdateCalled === false && document.querySelector('.tpi-infi--update-button')){
        autoUpdateCalled = true;
        
        const pauseButton = document.querySelector('.tpi-infi--update-button');
        const forceUpdateButton = document.querySelector('.tpi-infi--force-update-button');
        
        // Добавляем обработчик для кнопки принудительного обновления
        forceUpdateButton.addEventListener('click', forceUpdateTable);
        
        pauseButton.addEventListener('click', ()=>{
            const buttonState = pauseButton.getAttribute('tpi-current-state');
            
            if(buttonState === 'playing'){
                // Ставим на паузу
                pauseButton.setAttribute('tpi-current-state', 'paused');
                pauseButton.innerHTML = tpiIcon__playUpdate;
                forceUpdateButton.setAttribute('tpi-current-state', 'showed');
                forceUpdateButton.disabled = false;
                
                // Сбрасываем автообновление
                resetAutoUpdate();
            } else if(buttonState === 'paused'){
                // Возобновляем
                pauseButton.setAttribute('tpi-current-state', 'playing');
                pauseButton.innerHTML = tpiIcon__pauseUpdate;
                forceUpdateButton.setAttribute('tpi-current-state', 'unset');
                forceUpdateButton.disabled = true;
                
                // Запускаем автообновление
                startAutoUpdate();
            }
        });
        
        // Запускаем автообновление при инициализации
        startAutoUpdate();
    }
}